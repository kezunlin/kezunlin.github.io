<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">


  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-5653382914441020",
      enable_page_level_ads: true
    });
  </script>

  <meta name="google-site-verification" content="WSpJFvfcmIPBX_iK8uPbmCHIy_0f1lvd7ZJpbyad2sA">
  <meta name="yandex-verification" content="808eb057eb8396cc">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kezunlin.me","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Kezunlin&#39;s Blog">
<meta property="og:url" content="https://kezunlin.me/page/6/index.html">
<meta property="og:site_name" content="Kezunlin&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="kezunlin">
<meta property="article:tag" content="linux, c++, python, AI, LLM">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://kezunlin.me/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Kezunlin's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Kezunlin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Kezunlin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Live and Learn</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/mplack-tutorial-on-ubuntu-16-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/mplack-tutorial-on-ubuntu-16-04/" class="post-title-link" itemprop="url">compile and install mplack on ubuntu 16.04</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-05-20 17:01:00" itemprop="dateCreated datePublished" datetime="2019-05-20T17:01:00+08:00">2019-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><p>mlpack: a scalable C++ machine learning library </p>
<h3 id="dependencies"><a href="#dependencies" class="headerlink" title="dependencies"></a>dependencies</h3><ul>
<li>Armadillo     &gt;&#x3D; 6.500.0</li>
<li>Boost</li>
<li>CMake         &gt;&#x3D; 3.3.2</li>
</ul>
<blockquote>
<p>Armadillo: c++ linear algebra library based on <code>LAPACK</code> and <code>BLAS</code><br>If you are compiling Armadillo by hand, ensure that LAPACK and BLAS are enabled.</p>
</blockquote>
<blockquote>
<p>see <a target="_blank" rel="noopener" href="https://www.cnblogs.com/cslxiao/p/3512976.html">OpenCV vs. Armadillo vs. Eigen on Linux</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install libarmadillo-dev</span><br></pre></td></tr></table></figure>

<h3 id="install"><a href="#install" class="headerlink" title="install"></a>install</h3><h4 id="apt-get"><a href="#apt-get" class="headerlink" title="apt-get"></a>apt-get</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install libmlpack-dev</span><br></pre></td></tr></table></figure>
<blockquote>
<p>version: 2.0.1<br>by default <code>mlpack</code> will install to <code>/usr/include/mlpack</code> and <code>/usr/lib</code></p>
</blockquote>
<h4 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.mlpack.org/files/mlpack-3.1.1.tar.gz</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/mlpack/mlpack.git</span><br><span class="line"><span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; cmake-gui ..</span><br><span class="line">make -j8</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure>

<p>configure and output </p>
<pre><code>...
Found Armadillo: /usr/lib/libarmadillo.so (found suitable version &quot;6.500.5&quot;, minimum required is &quot;6.500.0&quot;) 
Armadillo libraries: /usr/lib/libarmadillo.so
...
</code></pre>
<blockquote>
<p>version: 3.1.1<br>by default <code>mlpack</code> will install to <code>/usr/local/include</code> and <code>/usr/local/lib/libmlpack.so.3.1</code></p>
</blockquote>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>




<h3 id="usage"><a href="#usage" class="headerlink" title="usage"></a>usage</h3><h4 id="mlpack-config-cmake"><a href="#mlpack-config-cmake" class="headerlink" title="mlpack-config.cmake"></a>mlpack-config.cmake</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#.rst:</span></span><br><span class="line"><span class="comment"># FindMLPACK</span></span><br><span class="line"><span class="comment"># -------------</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Find MLPACK</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Find the MLPACK C++ library</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Using MLPACK::</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   find_package(MLPACK REQUIRED)</span></span><br><span class="line"><span class="comment">#   include_directories($&#123;MLPACK_INCLUDE_DIRS&#125;)</span></span><br><span class="line"><span class="comment">#   add_executable(foo foo.cc)</span></span><br><span class="line"><span class="comment">#   target_link_libraries(foo $&#123;MLPACK_LIBRARIES&#125;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This module sets the following variables::</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   MLPACK_FOUND - set to true if the library is found</span></span><br><span class="line"><span class="comment">#   MLPACK_INCLUDE_DIRS - list of required include directories</span></span><br><span class="line"><span class="comment">#   MLPACK_LIBRARIES - list of libraries to be linked</span></span><br><span class="line"><span class="comment">#   MLPACK_VERSION_MAJOR - major version number</span></span><br><span class="line"><span class="comment">#   MLPACK_VERSION_MINOR - minor version number</span></span><br><span class="line"><span class="comment">#   MLPACK_VERSION_PATCH - patch version number</span></span><br><span class="line"><span class="comment">#   MLPACK_VERSION_STRING - version number as a string (ex: &quot;1.0.4&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># UNIX paths are standard, no need to specify them.</span></span><br><span class="line"><span class="keyword">find_library</span>(MLPACK_LIBRARY</span><br><span class="line">	NAMES mlpack</span><br><span class="line">	PATHS <span class="string">&quot;$ENV&#123;ProgramFiles&#125;/mlpack/lib&quot;</span>  <span class="string">&quot;$ENV&#123;ProgramFiles&#125;/mlpack/lib64&quot;</span> <span class="string">&quot;$ENV&#123;ProgramFiles&#125;/mlpack&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">find_path</span>(MLPACK_INCLUDE_DIR</span><br><span class="line">	NAMES mlpack/core.hpp mlpack/prereqs.hpp</span><br><span class="line">	PATHS <span class="string">&quot;$ENV&#123;ProgramFiles&#125;/mlpack&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(MLPACK_INCLUDE_DIR)</span><br><span class="line">	<span class="comment"># Read and parse mlpack version header file for version number</span></span><br><span class="line">	<span class="keyword">file</span>(STRINGS <span class="string">&quot;$&#123;MLPACK_INCLUDE_DIR&#125;/mlpack/core/util/version.hpp&quot;</span> _mlpack_HEADER_CONTENTS REGEX <span class="string">&quot;#define MLPACK_VERSION_[A-Z]+ &quot;</span>)</span><br><span class="line">	<span class="keyword">string</span>(REGEX REPLACE <span class="string">&quot;.*#define MLPACK_VERSION_MAJOR ([0-9]+).*&quot;</span> <span class="string">&quot;\\1&quot;</span> MLPACK_VERSION_MAJOR <span class="string">&quot;$&#123;_mlpack_HEADER_CONTENTS&#125;&quot;</span>)</span><br><span class="line">	<span class="keyword">string</span>(REGEX REPLACE <span class="string">&quot;.*#define MLPACK_VERSION_MINOR ([0-9]+).*&quot;</span> <span class="string">&quot;\\1&quot;</span> MLPACK_VERSION_MINOR <span class="string">&quot;$&#123;_mlpack_HEADER_CONTENTS&#125;&quot;</span>)</span><br><span class="line">	<span class="keyword">string</span>(REGEX REPLACE <span class="string">&quot;.*#define MLPACK_VERSION_PATCH ([0-9]+).*&quot;</span> <span class="string">&quot;\\1&quot;</span> MLPACK_VERSION_PATCH <span class="string">&quot;$&#123;_mlpack_HEADER_CONTENTS&#125;&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">unset</span>(_mlpack_HEADER_CONTENTS)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">set</span>(MLPACK_VERSION_STRING <span class="string">&quot;$&#123;MLPACK_VERSION_MAJOR&#125;.$&#123;MLPACK_VERSION_MINOR&#125;.$&#123;MLPACK_VERSION_PATCH&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line">find_package_handle_standard_args(MLPACK</span><br><span class="line">	REQUIRED_VARS MLPACK_LIBRARY MLPACK_INCLUDE_DIR</span><br><span class="line">	VERSION_VAR MLPACK_VERSION_STRING</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(MLPACK_FOUND)</span><br><span class="line">	<span class="keyword">set</span>(MLPACK_INCLUDE_DIRS <span class="variable">$&#123;MLPACK_INCLUDE_DIR&#125;</span>)</span><br><span class="line">	<span class="keyword">set</span>(MLPACK_LIBRARIES <span class="variable">$&#123;MLPACK_LIBRARY&#125;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hide internal variables</span></span><br><span class="line"><span class="keyword">mark_as_advanced</span>(</span><br><span class="line">	MLPACK_INCLUDE_DIR</span><br><span class="line">	MLPACK_LIBRARY</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>From <a target="_blank" rel="noopener" href="https://github.com/mlpack/mlpack/issues/444">here</a></p>
</blockquote>
<h4 id="CMakeLists-txt"><a href="#CMakeLists-txt" class="headerlink" title="CMakeLists.txt"></a>CMakeLists.txt</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(MLPACK REQUIRED)</span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; MLPACK_INCLUDE_DIRS = $&#123;MLPACK_INCLUDE_DIRS&#125;&quot;</span>) </span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; MLPACK_LIBRARIES = $&#123;MLPACK_LIBRARIES&#125;&quot;</span>)  </span><br><span class="line"><span class="comment"># /usr/local/include</span></span><br><span class="line"><span class="comment"># /usr/local/lib/libmlpack.so</span></span><br></pre></td></tr></table></figure>

<h3 id="mlpack-clustering"><a href="#mlpack-clustering" class="headerlink" title="mlpack clustering"></a>mlpack clustering</h3><blockquote>
<p>see <a target="_blank" rel="noopener" href="https://mlpack.org/doc/mlpack-3.1.0/cli_documentation.html">mlpack clustering</a></p>
</blockquote>
<h4 id="kmeans"><a href="#kmeans" class="headerlink" title="kmeans"></a>kmeans</h4><p>skip now.</p>
<h4 id="meanshift"><a href="#meanshift" class="headerlink" title="meanshift"></a>meanshift</h4><ul>
<li><p><a target="_blank" rel="noopener" href="https://mlpack.org/doc/mlpack-git/doxygen/classmlpack_1_1meanshift_1_1MeanShift.html">mlpack_meanshift doc</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/mlpack/mlpack/blob/master/src/mlpack/tests/mean_shift_test.cpp">mlpack mean shift test</a></p>
</li>
</ul>
<h4 id="dbscan"><a href="#dbscan" class="headerlink" title="dbscan"></a>dbscan</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mlpack/mlpack/blob/master/src/mlpack/tests/dbscan_test.cpp">mlpack dbscan test</a></li>
</ul>
<h3 id="sklearn-clustering"><a href="#sklearn-clustering" class="headerlink" title="sklearn clustering"></a>sklearn clustering</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.cluster <span class="keyword">import</span> MeanShift</span><br><span class="line"><span class="keyword">from</span> sklearn.cluster <span class="keyword">import</span> DBSCAN</span><br><span class="line"><span class="keyword">from</span> sklearn.cluster <span class="keyword">import</span> KMeans</span><br></pre></td></tr></table></figure>
<blockquote>
<p>see <a target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.cluster">sklearn clustering</a></p>
</blockquote>
<h3 id="opencv-clustering"><a href="#opencv-clustering" class="headerlink" title="opencv clustering"></a>opencv clustering</h3><ul>
<li>cv::kmeans()</li>
</ul>
<blockquote>
<p>see <a target="_blank" rel="noopener" href="https://docs.opencv.org/4.1.0/d5/d38/group__core__cluster.html">opencv clustering</a></p>
</blockquote>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mlpack/mlpack">mlpack</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mlpack.org/doc/stable/cli_documentation.html#tutorials">mlpack.org</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mlpack/mlpack/issues/444">mlpack findpackage</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mlpack/mlpack/blob/master/src/mlpack/tests/mean_shift_test.cpp">mlpack mean shift</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/davisking/dlib">dlib</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190520: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/ml-ref/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/ml-ref/" class="post-title-link" itemprop="url">pratical machine learning with python</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-05-14 17:56:00" itemprop="dateCreated datePublished" datetime="2019-05-14T17:56:00+08:00">2019-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index"><span itemprop="name">machine learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Linear-Algebra"><a href="#Linear-Algebra" class="headerlink" title="Linear Algebra"></a>Linear Algebra</h2><h3 id="determinant"><a href="#determinant" class="headerlink" title="determinant"></a>determinant</h3><p>basic </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/51ec2d87b5f3">matrix determinant</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f84157116683">minor&#x2F;cofactor&#x2F;adjugate&#x2F;inverse matrix</a></li>
</ul>
<p><img src="https://gss1.bdstatic.com/-vo3dSag_xI4khGkpoWK1HF6hhy/baike/s%3D343/sign=03ae18e90133874498c52978620ed937/30adcbef76094b3659255d54aecc7cd98c109dd0.jpg" alt="determinant formula"></p>
<p>determinant properties</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/seniusen/p/10023231.html">determinant properties</a></li>
</ul>
<p>online calculator </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ncalculators.com/matrix/matrix-determinant-calculator.htm">determinant</a></li>
<li><a target="_blank" rel="noopener" href="https://ncalculators.com/matrix/2x2-inverse-matrix-calculator.htm">inverse</a></li>
</ul>
<h3 id="inverse-adjoint-adjugate-matrix"><a href="#inverse-adjoint-adjugate-matrix" class="headerlink" title="inverse&#x2F;adjoint(adjugate) matrix"></a>inverse&#x2F;adjoint(adjugate) matrix</h3><p>Only non-singular matrices have inverses. (det(A) !&#x3D; 0)</p>
<ul>
<li>minor matrix</li>
<li>cofactor matrix</li>
<li>adjoint&#x2F;adjugate matrix</li>
<li>inverse matrix</li>
<li>conjugate matrix</li>
</ul>
<h3 id="eigenvalue-eigenvector"><a href="#eigenvalue-eigenvector" class="headerlink" title="eigenvalue&#x2F;eigenvector"></a>eigenvalue&#x2F;eigenvector</h3><p>An*n<br>graph demo<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/alvinlyb/article/details/78892486">eigenvector</a></p>
<p><a target="_blank" rel="noopener" href="https://www.wikihow.com/Find-Eigenvalues-and-Eigenvectors">eigenvector steps</a></p>
<h3 id="svd"><a href="#svd" class="headerlink" title="svd"></a>svd</h3><p>singular value decomposition<br>Am*n (m!&#x3D;n)<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pinard/p/6251584.html">svd</a></p>
<h2 id="Probability-Theory"><a href="#Probability-Theory" class="headerlink" title="Probability Theory"></a>Probability Theory</h2><p>random variable: discrete&#x2F;continuous</p>
<ul>
<li>probability mass function: pmf (possion, binomial distribution ) for <strong>discrete random variable</strong></li>
<li>probability density function: pdf (normal,uniform) for <strong>contiunous random variable</strong></li>
<li>cumulative distribution function: cdf  for <strong>discrete+contiunous random variable</strong></li>
</ul>
<p>see <a target="_blank" rel="noopener" href="http://blog.dyingbleed.com/pmf-cdf-pdf/">pmf-cdf-pdf</a><br><a target="_blank" rel="noopener" href="https://stats.stackexchange.com/questions/242465/distribution-function-terminology-pdf-cdf-pmf-etc">distribution-function-terminology-pdf-cdf-pmf-etc</a></p>
<blockquote>
<p>binomial: n times Bernoulli trial, P(x&#x3D;k)&#x3D;C(n,k)* p^k * (1-p)^(n-k)</p>
</blockquote>
<ul>
<li>marginal probability</li>
<li>joint probability</li>
<li>conditional probability</li>
<li>bayes theorem</li>
</ul>
<p>see <a target="_blank" rel="noopener" href="https://sites.nicholas.duke.edu/statsreview/jmc/">here</a></p>
<blockquote>
<p>Marginal probability: the probability of an event occurring (p(A)), it may be thought of as an unconditional probability.  It is not conditioned on another event.  Example:  the probability that a card drawn is red (p(red) &#x3D; 0.5).  Another example:  the probability that a card drawn is a 4  (p(four)&#x3D;1&#x2F;13).</p>
</blockquote>
<blockquote>
<p>Joint probability:  p(A and B).  The probability of event A and event B occurring.  It is the probability of the intersection of two or more events.  The probability of the intersection of A and B may be written p(A ∩ B). Example:  the probability that a card is a four and red &#x3D;p(four and red) &#x3D; 2&#x2F;52&#x3D;1&#x2F;26.  (There are two red fours in a deck of 52, the 4 of hearts and the 4 of diamonds).</p>
</blockquote>
<blockquote>
<p>Conditional probability:  p(A|B) is the probability of event A occurring, given that event B occurs. Example:  given that you drew a red card, what’s the probability that it’s a four (p(four|red))&#x3D;2&#x2F;26&#x3D;1&#x2F;13.  So out of the 26 red cards (given a red card), there are two fours so 2&#x2F;26&#x3D;1&#x2F;13.</p>
</blockquote>
<blockquote>
<p>bayes theorem:  p(cancer)&#x3D;0.01, p(positive test|cancer)&#x3D;0.9, p(positive test|no cancer)&#x3D;0.08<br>p(cancer|positive test)?</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://tinyheero.github.io/2016/03/20/basic-prob.html">basic-prob</a></p>
<h2 id="Statistics"><a href="#Statistics" class="headerlink" title="Statistics"></a>Statistics</h2><p>2 types of statistics</p>
<ul>
<li>descriptive statistics 描述性统计值</li>
<li>inferential statistics　推理性统计值</li>
</ul>
<h3 id="descriptive-statistics"><a href="#descriptive-statistics" class="headerlink" title="descriptive statistics"></a>descriptive statistics</h3><h4 id="basic"><a href="#basic" class="headerlink" title="basic"></a>basic</h4><ul>
<li>n, sum, min,max, range &#x3D;max-min,</li>
<li>mean,median,mode</li>
<li>variance,standard deviation </li>
<li>skewness,kurtosis<blockquote>
<p>from <a target="_blank" rel="noopener" href="https://www.purplemath.com/modules/meanmode.htm">mean,median,mode</a></p>
</blockquote>
</li>
</ul>
<p>mean&#x2F;median&#x2F;mode</p>
<ul>
<li>mean: regular meaning of “average”</li>
<li>median: middle value</li>
<li>mode: most often</li>
</ul>
<p>2 types of data set: <a target="_blank" rel="noopener" href="https://stattrek.com/sampling/populations-and-samples.aspx">here</a></p>
<ul>
<li>population: u,sigma^2, sigma —&gt; parameter</li>
<li>sample:  x, s^2, s —&gt;  statistic</li>
</ul>
<blockquote>
<p>population是总体,总体的数据是不变的,u就代表总体真实的均值；<br>sample是样本,我们总体的数据很难得到,必须借助样本猜测总体的情况,但是每次采样的时候会有不同,因此x拔表示一次采样的均值；<br>不同采样的均值x往往不同,但是总体均值u一定是不变的。</p>
</blockquote>
<p>population<br><img src="https://kezunlin.me/images/posts/635233-20190522085451958-700851246.png" alt="population"></p>
<p>sample<br><img src="https://kezunlin.me/images/posts/635233-20190522085910140-397214367.png" alt="sample"></p>
<blockquote>
<p>see <a target="_blank" rel="noopener" href="https://cn.bing.com/search?q=mean%20median%20&qs=n&form=QBRE&sp=-1&pq=mean%20median%20&sc=8-12&sk=&cvid=4161BAB55A18491594A005523AEDF298">example</a></p>
</blockquote>
<h4 id="skewness-vs-kurtosis"><a href="#skewness-vs-kurtosis" class="headerlink" title="skewness vs kurtosis"></a>skewness vs kurtosis</h4><ul>
<li>skewness: 偏度  the degree of symmetry</li>
<li>kurtosis: 峰度　the degree of peakedness&#x2F;flatness</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190522094931003-1160367822.jpg" alt="image"></p>
<p><img src="https://kezunlin.me/images/posts/635233-20190522095110460-710218536.jpg" alt="image"></p>
<p>formula see <a target="_blank" rel="noopener" href="https://itl.nist.gov/div898/handbook/eda/section3/eda35b.htm">skewness kurtosis formula</a></p>
<h3 id="inferential-statistics"><a href="#inferential-statistics" class="headerlink" title="inferential statistics"></a>inferential statistics</h3><p><img src="https://kezunlin.me/images/posts/635233-20190619144201298-517495811.jpg" alt="inferential statistics"><br><img src="https://kezunlin.me/images/posts/635233-20190619144446758-1310784151.jpg" alt="inferential statistics"><br>Each hypothesis: null hypothesis +  an alternative hypothesis.  </p>
<ul>
<li>H0: u1&#x3D;u2&#x3D;u3&#x3D;…&#x3D;un.  it indicates that the group means for the various groups are NOT very different from each other based on statistical significance levels.</li>
<li>Ha: there exists at least two group means that are statistically significantly different from each other.</li>
</ul>
<p>significance tests　显著性检验</p>
<ul>
<li>H0: there is NO real difference</li>
<li>Ha: there is a difference<blockquote>
<p>Reject H0 at 5% significant level if p-value&lt;5%, statistical significant<br>Reject H0 at 1% significant level if p-value&lt;1%, highly significant<br>one-tailed tests vs two-tailed tests</p>
</blockquote>
</li>
</ul>
<p>one-way ANOVA test: </p>
<ul>
<li>if p-value&lt;&#x3D;5%, the result is statistically significant different, we reject the null hypothesis in favor of the alternative hypothesis. (Ha was correct)</li>
<li>Otherwise, if the results is not statistically significant, we conclude that our null hypothesis was correct. (H0 was correct)</li>
</ul>
<p>demo<br><img src="https://kezunlin.me/images/posts/635233-20190619143945820-1738438241.png" alt="anova test"></p>
<blockquote>
<p>F-stat&gt;4.737 or p-value&lt;0.05, then reject H0</p>
</blockquote>
<p><img src="https://kezunlin.me/images/posts/635233-20190619144127155-2135913752.png" alt="boxplot for anova test"></p>
<p>parametric tests vs nonparametric tests 参数检验　vs 非参数检验</p>
<h2 id="Data-Mining"><a href="#Data-Mining" class="headerlink" title="Data Mining"></a>Data Mining</h2><ul>
<li>KDD: knowledge discovery of dataset </li>
<li>CRISP-DM: cross-industry standard process for data mining 跨行业数据挖掘标准流程</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190522101222659-268099901.png" alt="CRISP-DM_Process_Diagram.png"></p>
<h2 id="Machine-Learning-methods"><a href="#Machine-Learning-methods" class="headerlink" title="Machine Learning methods"></a>Machine Learning methods</h2><p>with&#x2F;without labels</p>
<ul>
<li>supervised learning: <ul>
<li>classification</li>
<li>regression</li>
</ul>
</li>
<li>unsupervised learning<ul>
<li>clustering</li>
<li>dimensionality reduction</li>
<li>anomaly detection</li>
<li>assiciation rule-mining&#x2F;market basket analysis(购物篮分析)</li>
</ul>
</li>
<li>semi-supervised learning</li>
<li>reinforcement learning</li>
</ul>
<p>online&#x2F;offline</p>
<ul>
<li>batch learning&#x2F;offline learning</li>
<li>online learning</li>
</ul>
<p>instance&#x2F;model</p>
<ul>
<li>instance based learning</li>
<li>model based learning</li>
</ul>
<h2 id="EDA"><a href="#EDA" class="headerlink" title="EDA"></a>EDA</h2><h3 id="statistics"><a href="#statistics" class="headerlink" title="statistics"></a>statistics</h3><ul>
<li>descriptive statistics</li>
<li>inferential statistics</li>
</ul>
<h3 id="analysis"><a href="#analysis" class="headerlink" title="analysis"></a>analysis</h3><p>3 types</p>
<ul>
<li>univariate analysis: n&#x3D;1</li>
<li>bivariate analysis: n&#x3D;2</li>
<li>multivariate analysis: n&gt;&#x3D;3</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190619152011901-168373230.jpg" alt="3 types of analysis"></p>
<ul>
<li>use histogram to visualize data</li>
<li>correlation matrix&#x2F;heatmap</li>
</ul>
<h2 id="Model-Evaluation"><a href="#Model-Evaluation" class="headerlink" title="Model Evaluation"></a>Model Evaluation</h2><h3 id="Classification"><a href="#Classification" class="headerlink" title="Classification"></a>Classification</h3><p>confusion matrix</p>
<ul>
<li>accuracy</li>
<li>precision</li>
<li>recall</li>
<li>F1-score: harmonic mean 调和平均值</li>
</ul>
<p>value range (0-1), the bigger, the better.</p>
<p><img src="https://kezunlin.me/images/posts/635233-20190618144928732-1997507318.png" alt="confusion matrix"></p>
<p>precision vs recall curve<br><img src="https://kezunlin.me/images/posts/635233-20190618151318062-715784222.png" alt="precision vs recall"></p>
<p>another curve</p>
<ul>
<li>roc: receiver operating characteristic 接受者操作特征.  TPR vs FPR curve</li>
<li>auc: area under curve.  value range (0-1), the bigger, the better.</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190618151018159-318786418.png" alt="roc basic"><br><img src="https://kezunlin.me/images/posts/635233-20190618150355651-1546386024.png" alt="roc"><br><img src="https://kezunlin.me/images/posts/635233-20190618150814474-536646125.jpg" alt="auc"><br><img src="https://kezunlin.me/images/posts/635233-20190618150657897-1643602084.png" alt="roc demo"></p>
<p>all in one<br><img src="https://kezunlin.me/images/posts/635233-20190618151558587-282770481.png" alt="roc, precision recall, f1-score"></p>
<p>multi-class classification for ROC</p>
<ul>
<li>micro-averaging: treat as binary </li>
<li>macro-averaging:  equal weight<br><img src="https://kezunlin.me/images/posts/635233-20190619175451921-1801584977.png" alt="roc for multi-class classification"></li>
</ul>
<h3 id="Clustering"><a href="#Clustering" class="headerlink" title="Clustering"></a>Clustering</h3><p>types</p>
<ul>
<li>partition&#x2F;centroid based clustering: k-means,k-medoids</li>
<li>hierachical clustering: AgglomerativeClustering, affinity propagation<ul>
<li>ward&#x2F;single linkage</li>
<li>averate linkage</li>
<li>complete linkage</li>
</ul>
</li>
<li>distribution based clustering: gaussian mixture models</li>
<li>densitity based clustering: DBSCAN, OPTICS</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190618152757010-799129444.png" alt="clustering"><br><img src="https://kezunlin.me/images/posts/635233-20190618152840294-1313788780.png" alt="clustering"></p>
<p><img src="https://kezunlin.me/images/posts/635233-20190618154249813-1152275745.jpg" alt="partition based clustering"><br><img src="https://kezunlin.me/images/posts/635233-20190618154036170-139572525.jpg" alt="hierachical clustering dendrogram"><br><img src="https://kezunlin.me/images/posts/635233-20190618154158157-1063351244.png" alt="linkages"></p>
<h4 id="external-validation"><a href="#external-validation" class="headerlink" title="external validation"></a>external validation</h4><p>with labels</p>
<ul>
<li>homogeneity</li>
<li>completeness</li>
<li>v-measure: harmonic mean 调和平均值<br>value range (0-1), the bigger, the better.</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190618152717377-1272500102.jpg" alt="homogeneity completeness"><br><img src="https://kezunlin.me/images/posts/635233-20190618153341598-798705751.jpg" alt="v-measure"></p>
<h4 id="internal-validation"><a href="#internal-validation" class="headerlink" title="internal validation"></a>internal validation</h4><p>no labels<br>2 most important traits:</p>
<ul>
<li>compact groups</li>
<li>well seperated groups</li>
</ul>
<p>metric</p>
<ul>
<li>silhouette coefficient: SC轮廓系数. value range (-1-1), the bigger, the better.</li>
<li>calinski-harabaz index: chi指数   value range &gt;0 , the bigger, the better.</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190618154805753-557196140.jpg" alt="sc"><br><img src="https://kezunlin.me/images/posts/635233-20190618154934289-438670456.jpg" alt="sc"><br><img src="https://kezunlin.me/images/posts/635233-20190618155106519-791597666.png" alt="sc vs number of clusters"><br><img src="https://kezunlin.me/images/posts/635233-20190618155404644-386109044.png" alt="sc and chi"></p>
<h3 id="Regression"><a href="#Regression" class="headerlink" title="Regression"></a>Regression</h3><p>metric:</p>
<ul>
<li>mean squared error: MSE</li>
<li>root mean squared error: RMSE</li>
<li>coefficient of determination (R^2):判定系数</li>
<li>coefficient of correlation (r):相关系数  value range (-1,1)</li>
</ul>
<p>R2: value range (0,1), the bigger, the better.</p>
<blockquote>
<p>for simple linear regression, R^2 &#x3D; r^2</p>
</blockquote>
<p>formula:<br><img src="https://kezunlin.me/images/posts/635233-20190613100645927-2086416697.png" alt="r2 formula"></p>
<p>correlation coefficient<br><img src="https://kezunlin.me/images/posts/635233-20190613102402855-1112676399.png" alt="r demo"></p>
<p>r2 demo<br><img src="https://kezunlin.me/images/posts/635233-20190613102853720-421135885.jpg" alt="r2"><br><img src="https://kezunlin.me/images/posts/635233-20190613094519733-545867820.jpg" alt="r2 demo"></p>
<blockquote>
<p>images from bing search.</p>
</blockquote>
<h4 id="regression-analysis"><a href="#regression-analysis" class="headerlink" title="regression analysis"></a>regression analysis</h4><p>types</p>
<ul>
<li>simple linear regression</li>
<li>multiple linear regression</li>
<li>nonlinear regression</li>
</ul>
<p>assumptions</p>
<ul>
<li>training dataset(sample) is representative of the population being modeled</li>
<li>x1,x2,…,xn are linearly independent. no multicollinearity 非多重共线性 </li>
<li>homoscedasticity of error 同方差性:  residuals being random and no any patterns</li>
</ul>
<blockquote>
<p>multicollinearity 多重共线性:  correlation matrix<br>variance inflation factor (VIF)方差膨胀因子　VIFi &#x3D; 1&#x2F;(1-Ri^2). VIF越大，显示共线性越严重。经验判断方法表明：当0&lt;VIF&lt;10，不存在多重共线性；当10≤VIF&lt;100，存在较强的多重共线性；当VIF≥100，存在严重多重共线性。<br>homo-scedastic(同方差) vs hetero-scedastic (异方差性): residual plot<br>homogeneous vs heterogeneous 同质的vs异质的</p>
</blockquote>
<p><img src="https://kezunlin.me/images/posts/635233-20190617144321205-573073220.png" alt="correlation matrix/heatmap"></p>
<p><img src="https://kezunlin.me/images/posts/635233-20190617145208765-175981783.jpg" alt="VIF"></p>
<p><img src="https://kezunlin.me/images/posts/635233-20190617113523952-599571664.png" alt="homoscedasticity"><br><img src="https://kezunlin.me/images/posts/635233-20190617113542212-995572923.png" alt="homoscedasticity"></p>
<p>evaluation analysis</p>
<ul>
<li>residual analysis</li>
<li>normality tests (Q-Q plot）正态分布检验</li>
<li>R^2</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190617145954684-427188783.png" alt="QQ-plot"></p>
<h5 id="linear-regression"><a href="#linear-regression" class="headerlink" title="linear regression"></a>linear regression</h5><blockquote>
<p>y &#x3D; kx + b, use OLS </p>
</blockquote>
<h5 id="decision-tree-based-regression"><a href="#decision-tree-based-regression" class="headerlink" title="decision tree based regression"></a>decision tree based regression</h5><p>linear vs non-linear regression:</p>
<ul>
<li>linear regression</li>
<li>decision tree based regression (non-linear)</li>
</ul>
<blockquote>
<p>decision tree can be used for both classification and regression. CART</p>
</blockquote>
<p>node splitting<br>for regression:</p>
<ul>
<li>MSE: mean squared error  </li>
<li>RMSE: root mean squared error  </li>
<li>MAE: mean absolute error </li>
<li>MAPE: mean absolute percentage error</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190617163953017-375911658.jpg" alt="regression"><br><img src="https://kezunlin.me/images/posts/635233-20190617164254843-277788876.jpg" alt="mse and mae"></p>
<p>for classification</p>
<ul>
<li>information gain(entropy): 信息增益(熵) </li>
<li>gini impurity&#x2F;index: GINI 基尼不纯度</li>
<li>misclassification error:</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190617165054902-66957836.png" alt="ig and gini"><br><img src="https://kezunlin.me/images/posts/635233-20190617165115901-1683267423.png" alt="bad vs good split"></p>
<p>stoppint criteria</p>
<ul>
<li>max depth</li>
<li>min samples to split internal nodes</li>
<li>max leaf nodes<blockquote>
<p>use GridSearch to search for optimal hyperparameters</p>
</blockquote>
</li>
</ul>
<p>decesion tree algorithms</p>
<ul>
<li>CART</li>
<li>ID3</li>
<li>C4.5</li>
</ul>
<h3 id="ensemble-learning"><a href="#ensemble-learning" class="headerlink" title="ensemble learning"></a>ensemble learning</h3><p>3 major families:</p>
<ul>
<li>bagging: boostrap aggregating, boostrap sampling(自助采样法) eg. RandomForest</li>
<li>boosting: eg. Gradient Boosting Machine(GBM), AdaBoost<ul>
<li>GBM variant: LightGBM, Extreme Gradient Boosting(XGBoost)</li>
</ul>
</li>
<li>stacking</li>
</ul>
<p>others</p>
<ul>
<li>binning</li>
<li>blending</li>
<li>averaging</li>
<li>voting</li>
</ul>
<blockquote>
<p>see <a target="_blank" rel="noopener" href="https://www.kdnuggets.com/2017/11/difference-bagging-boosting.html">What is the difference between Bagging and Boosting?</a><br>see <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/39920405">集成学习-Boosting,Bagging与Stacking</a></p>
</blockquote>
<p>boostrap aggregating&#x2F;bagging<br><img src="https://kezunlin.me/images/posts/635233-20190619170531866-2007371735.png" alt="boostrap aggregating/bagging"></p>
<p>boosting<br><img src="https://kezunlin.me/images/posts/635233-20190619172323472-1369002181.png" alt="boosting"><br><img src="https://kezunlin.me/images/posts/635233-20190619172620343-1105158442.jpg" alt="boosting"></p>
<p>model stacking<br><img src="https://kezunlin.me/images/posts/635233-20190617172129437-38352695.png" alt="stacking"><br><img src="https://kezunlin.me/images/posts/635233-20190617172758390-616098962.png" alt="stacking"></p>
<h2 id="Model-Tuning"><a href="#Model-Tuning" class="headerlink" title="Model Tuning"></a>Model Tuning</h2><h3 id="decision-trees"><a href="#decision-trees" class="headerlink" title="decision trees"></a>decision trees</h3><ul>
<li>information gain: IG 信息增益</li>
<li>gini impurity: GI 基尼不纯度</li>
</ul>
<h3 id="bias-variance-tradeoff"><a href="#bias-variance-tradeoff" class="headerlink" title="bias-variance tradeoff"></a>bias-variance tradeoff</h3><p>The main causes of error in learning are due to <strong>noise, bias and variance</strong>.</p>
<p>extreme cases of bias-variance</p>
<ul>
<li>underfitting: higt bias, low variance</li>
<li>overfitting: lower bias, high vairance</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://scott.fortmann-roe.com/docs/BiasVariance.html">bias-variance tradeoff</a></p>
<p><img src="https://kezunlin.me/images/posts/635233-20190613163856662-2107028438.png" alt="bias-variance"></p>
<p><img src="https://kezunlin.me/images/posts/635233-20190613163654197-1290389410.png" alt="bias-variance model complexity"></p>
<p>see <a target="_blank" rel="noopener" href="https://www.learnopencv.com/bias-variance-tradeoff-in-machine-learning/">learnopencv</a></p>
<h3 id="cross-validation"><a href="#cross-validation" class="headerlink" title="cross validation"></a>cross validation</h3><p>train&#x2F;validation&#x2F;test </p>
<p>cross validation strategies:</p>
<ul>
<li>leave one out CV: n-1 samples as train, 1 sample as validate</li>
<li>k-fold CV: split into k equal subsets. k-1 subsets as train, 1 subset as validate<blockquote>
<p>5-fold, 10-fold in pratice</p>
</blockquote>
</li>
</ul>
<h3 id="hyperparameter-tuning-strategies"><a href="#hyperparameter-tuning-strategies" class="headerlink" title="hyperparameter tuning strategies"></a>hyperparameter tuning strategies</h3><ul>
<li>grid search: manually specifying the grid,  parallelizable</li>
<li>randomized search: automatic</li>
</ul>
<h2 id="Model-Interpertation"><a href="#Model-Interpertation" class="headerlink" title="Model Interpertation"></a>Model Interpertation</h2><p>tools </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/marcotcr/lime">lime</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/oracle/Skater">skater</a></li>
</ul>
<p>global vs local interpertation</p>
<ul>
<li>global interpertation: based on the whole dataset (feature_importance, partial_dependence plot)</li>
<li>local interpertation: based on a single prediction</li>
</ul>
<p>global interpertation<br><img src="https://kezunlin.me/images/posts/635233-20190620094807673-860707178.png" alt="feature_importance"></p>
<p><img src="https://kezunlin.me/images/posts/635233-20190620094700378-2134283575.png" alt="one-way partial_dependence plot"></p>
<p><img src="https://kezunlin.me/images/posts/635233-20190620094713232-826398055.png" alt="two-way partial_dependence plot"></p>
<p>local interpertation<br><img src="https://kezunlin.me/images/posts/635233-20190620095026602-495994008.png" alt="local interpertation"></p>
<p>model decision surface&#x2F; hypersurface<br><img src="https://kezunlin.me/images/posts/635233-20190619163426323-438972719.png" alt="model decision surface"></p>
<h2 id="Model-Deployment"><a href="#Model-Deployment" class="headerlink" title="Model Deployment"></a>Model Deployment</h2><ul>
<li>rest api </li>
<li>micro service</li>
<li>model deployment as a service, anything as a service(XAAS)</li>
</ul>
<h2 id="Real-world-case-studies"><a href="#Real-world-case-studies" class="headerlink" title="Real-world case studies"></a>Real-world case studies</h2><h3 id="customer-segmentation"><a href="#customer-segmentation" class="headerlink" title="customer segmentation"></a>customer segmentation</h3><p>clustering problem</p>
<p>factors</p>
<ul>
<li>geographic　地理因素</li>
<li>demographic 人口统计因素</li>
<li>psychographic 心理因素</li>
<li>behavioural 行为因素</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190618093024515-262889608.jpg" alt="customer segmentation"></p>
<p>RFM Model for customer value</p>
<ul>
<li>recency</li>
<li>frequency</li>
<li>monetary value</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190618141557519-155852148.jpg" alt="RFM Model"></p>
<h3 id="association-rule-mining"><a href="#association-rule-mining" class="headerlink" title="association-rule mining"></a>association-rule mining</h3><p>assiciation rule-mining&#x2F;market basket analysis(购物篮分析)</p>
<p>basics</p>
<ul>
<li>association rule: {item1,item2,item3 —&gt; itemK}</li>
<li>itemset:  {milk,bread} {beer,diaper}</li>
<li>frequent itemset: {milk,bread}</li>
</ul>
<p>metrics</p>
<ul>
<li>support &#x3D; frq(X,Y)&#x2F;N</li>
<li>confidence &#x3D; support(X,Y)&#x2F;support(X) &#x3D; frq(X,Y)&#x2F;frq(X)</li>
<li>lift &#x3D; support(X,Y)&#x2F;(support(X)*support(Y)) &#x3D; N*frq(X,Y)&#x2F;(frq(X)*frq(Y))</li>
</ul>
<p>good rules: large confidence, large support, lift &gt;1</p>
<blockquote>
<p>lift(X-&gt;Y) &#x3D; 0　means X and Y not occur at the same time<br>lift(X-&gt;Y) &#x3D; 1　means X and Y are independent of each other.<br><img src="https://kezunlin.me/images/posts/635233-20190618165330230-815144975.jpg" alt="support"><br><img src="https://kezunlin.me/images/posts/635233-20190618170045470-955987317.png" alt="support"><br><img src="https://kezunlin.me/images/posts/635233-20190618170418412-1948436415.jpg" alt="demo">        </p>
</blockquote>
<p>algorithms</p>
<ul>
<li>apriori algorithm: generate all 2^k itemsets, TOO EXPENSIVE</li>
<li>FP growth: no need to generate all 2^k itemsets, use special structure FP-tree, divide-and-conquer stragety</li>
</ul>
<p>k unique products, then 2^k itemsets.</p>
<h3 id="recommender-system"><a href="#recommender-system" class="headerlink" title="recommender system"></a>recommender system</h3><p>recommender systems&#x2F; recommendation engines</p>
<h4 id="big-data-with-pandas"><a href="#big-data-with-pandas" class="headerlink" title="big data with pandas"></a>big data with pandas</h4><p>how to process big data with pandas ?</p>
<pre><code>import pandas as pd
for chunk in pd.read_csv(&lt;filepath&gt;, chunksize=&lt;your_chunksize_here&gt;)
    do_processing()
    train_algorithm()
</code></pre>
<blockquote>
<p>read by chunk<br>see <a target="_blank" rel="noopener" href="https://datascience.stackexchange.com/questions/27767/opening-a-20gb-file-for-analysis-with-pandas">opening-a-20gb-file-for-analysis-with-pandas</a></p>
</blockquote>
<p>other tools</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.dask.org/en/latest/">dask</a></li>
<li><a target="_blank" rel="noopener" href="https://ml.dask.org/">dask-ml</a></li>
</ul>
<p>other refs</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8a1956a86c0c">dask+numba</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.itpub.net/31509949/viewspace-2212324/">dask parallize feature engineering</a></li>
</ul>
<h4 id="types-of-recommendation-engines"><a href="#types-of-recommendation-engines" class="headerlink" title="types of recommendation engines"></a>types of recommendation engines</h4><p>3 types</p>
<ul>
<li>user-based recommendation engines</li>
<li>content-based recommendation engines</li>
<li>hybrid&#x2F;collaborative filtering(协同过滤) recommendation engines<blockquote>
<p>based on similarity</p>
</blockquote>
</li>
</ul>
<p>different cases</p>
<ul>
<li>popularity-based: most liked songs by all users </li>
<li>similarity-based: similar songs for given user</li>
<li>matrix factorization based: use svd to get low rand approximation of the utility matrix</li>
</ul>
<h4 id="similarity"><a href="#similarity" class="headerlink" title="similarity"></a>similarity</h4><ul>
<li>Jaccard Index&#x2F;Jaccard similarity coefficient, (0-1)</li>
<li>cosine similarity</li>
</ul>
<blockquote>
<p>Jaccard Distance &#x3D; 1 - Jaccard Index<br><img src="https://kezunlin.me/images/posts/635233-20190620144813357-729179583.png" alt="Jaccard Index"><br><img src="https://kezunlin.me/images/posts/635233-20190620144830190-1685149186.jpg" alt="Jaccard Index"><br><img src="https://kezunlin.me/images/posts/635233-20190620144849854-1119859739.png" alt="demo"></p>
</blockquote>
<h4 id="matrix-factorization"><a href="#matrix-factorization" class="headerlink" title="matrix factorization"></a>matrix factorization</h4><p>矩阵分解<br>use matrix factorization to discover latent features between two different kinds of entities</p>
<p><img src="https://kezunlin.me/images/posts/635233-20190620153656632-1809021630.png" alt="utility matrix"></p>
<blockquote>
<p>sparse matrix</p>
</blockquote>
<p><img src="https://kezunlin.me/images/posts/635233-20190620153716968-1600019675.png" alt="matrix factorization"></p>
<blockquote>
<p>use SVD: matrix factorization, PCA </p>
</blockquote>
<p>implicit feedback 隐式反馈: song play count—&gt; likeness</p>
<h4 id="recommendation-engine-libraries"><a href="#recommendation-engine-libraries" class="headerlink" title="recommendation engine libraries"></a>recommendation engine libraries</h4><ul>
<li>scikit-surprise (Simple Python Recommendation System Engine)</li>
<li>lightfm</li>
<li>crab</li>
<li>rec_sys</li>
</ul>
<h3 id="time-series-forecasting"><a href="#time-series-forecasting" class="headerlink" title="time series forecasting"></a>time series forecasting</h3><h4 id="basics"><a href="#basics" class="headerlink" title="basics"></a>basics</h4><p>predictive modeling</p>
<p>time series analysis&#x2F;forecasting:</p>
<ul>
<li>traditional approaches<ul>
<li>Moving Average: MV</li>
<li>Exponential Smoothing: EWMA</li>
<li>Holt-Winter EWMA</li>
<li>Box-jenkins methodologies: AR, MA, ARIMA, S-ARIMA</li>
</ul>
</li>
<li>deep learning approaches: RNN, eg. LSTM <ul>
<li>regression modeling (x1,x2,..x6,—&gt;x7): many-to-one</li>
<li>sequence modeling: squence -&gt; sequence</li>
</ul>
</li>
</ul>
<p>two domains</p>
<ul>
<li>frequency domain: spectral and wavelet analysis</li>
<li>time domain: auto- and cross-correlation analysis</li>
</ul>
<p>where to get data ?</p>
<ul>
<li>Yahho</li>
<li>quandl:</li>
</ul>
<p>tools to fetch data:</p>
<ul>
<li>quandl: register for key first</li>
<li>pandas-datareader</li>
</ul>
<h4 id="time-series-components"><a href="#time-series-components" class="headerlink" title="time series components"></a>time series components</h4><p>3 major components:</p>
<ul>
<li>seasonality</li>
<li>trend</li>
<li>residual</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190621164523138-274852883.png" alt="major components"></p>
<p>smoothing techniques</p>
<ul>
<li>Moving Average: MV</li>
<li>Exponential Smoothing: EWMA</li>
</ul>
<h4 id="ARIMA"><a href="#ARIMA" class="headerlink" title="ARIMA"></a>ARIMA</h4><p>AR vs MV</p>
<ul>
<li>auto regressive</li>
<li>moving average<blockquote>
<p>ARIMA: auto regressive integrated moving average</p>
</blockquote>
</li>
</ul>
<p>key concepts</p>
<ul>
<li>Stationarity(平稳性):  One the key assumptions behind the ARIMA models. Stationarity refers to the property where for a time series its mean, variance, and autocorrelation are time invariant. <strong>In other words, mean, variance,and autocorrelation do not change with time</strong></li>
<li>Differencing(差分): differencing is widely used to stabilize the mean of a time series.　We can then apply different tests to confirm if the resulting series is stationary　or not.</li>
<li>Unit Root Tests: Statistical tests that help us understand if a given series is stationary<br>or not. <ul>
<li><code>ad_fuller_test</code>: The Augmented Dickey Fuller test begins with a null hypothesis of series being non-stationary</li>
<li><code>kpss_test</code>: while Kwiatkowski-Phillips-Schmidt-Shin test or KPSS has a null hypothesis that the series is stationary.</li>
</ul>
</li>
</ul>
<p>ad_fuller_test<br><img src="https://kezunlin.me/images/posts/635233-20190621171312867-1233129563.png" alt="ad_fuller_test 1"></p>
<blockquote>
<p>not statistically significant, accpet H0: non-stationary<br><img src="https://kezunlin.me/images/posts/635233-20190621171410960-353658517.png" alt="validate 1"></p>
</blockquote>
<p><img src="https://kezunlin.me/images/posts/635233-20190621171441978-1844678361.png" alt="ad_fuller_test 2"></p>
<blockquote>
<p>statistically significant, reject H0 and accept Ha: stationary<br><img src="https://kezunlin.me/images/posts/635233-20190621171504882-1622081726.png" alt="validate 2"></p>
</blockquote>
<p><code>ARIMA(p,d,q)</code> model<br>where,</p>
<ul>
<li>p is the order of Autoregression</li>
<li>q is the order of Moving average</li>
<li>d is the order of differencing</li>
</ul>
<p>how to choose p and q?</p>
<ul>
<li>ACF or Auto Correlation Function plot —&gt; q &#x3D; 1</li>
<li>PACF or the Partial Auto Correlation Function plot —&gt; p &#x3D; 1</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190621172513678-1126519018.png" alt="ACF PACF"></p>
<p>use grid search to choose p and q based on AIC</p>
<blockquote>
<p>AIC or Akaike Information Criterion measures the<br>goodness of fit and parsimony.<br><img src="https://kezunlin.me/images/posts/635233-20190621172850470-1417181261.png" alt="auto ARIMA"></p>
</blockquote>
<h4 id="LSTM"><a href="#LSTM" class="headerlink" title="LSTM"></a>LSTM</h4><p>Efficient Market Hypothesis: which says that it is almost impossible to beat the market consistently and there<br>are others which disagree with it.</p>
<p>modeling</p>
<ul>
<li>regression modeling</li>
<li>sequence modeling</li>
</ul>
<p><img src="https://kezunlin.me/images/posts/635233-20190621173532633-594452091.png" alt="regression modeling"></p>
<p><code>(N,W,F)</code> format as input</p>
<ul>
<li>number of sequence</li>
<li>window: length of sequence</li>
<li>features per timestamp</li>
</ul>
<p>for regression<br><img src="https://kezunlin.me/images/posts/635233-20190621173607256-348222903.png" alt="regression"></p>
<p>for sequence<br><img src="https://kezunlin.me/images/posts/635233-20190621173631098-1609541895.png" alt="sequence"></p>
<blockquote>
<p>we need to pad test sequence to match input shape.</p>
</blockquote>
<p>other time series tools</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/prophet">facebook prophet</a></li>
</ul>
<h2 id="New-Concepts"><a href="#New-Concepts" class="headerlink" title="New Concepts"></a>New Concepts</h2><ul>
<li>Linear Discriminant Analysis(LDA)线性判别分析</li>
<li>Quadratic Discriminant Analysis(QDA)线性判别分析</li>
</ul>
<p>sklearn code</p>
<pre><code>from sklearn.discriminant_analysis import QuadraticDiscriminantAnalysis
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://cn.bing.com/images/search">bing images</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dipanjanS/practical-machine-learning-with-python">pratical machine learning with python</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Apress/practical-ml-w-python">code for practical-ml-w-python</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190516: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/live-video-streaming-over-network-with-opencv-and-imagezmq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/live-video-streaming-over-network-with-opencv-and-imagezmq/" class="post-title-link" itemprop="url">stream live video over network with opencv and imagezmq </a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-05-06 17:27:00" itemprop="dateCreated datePublished" datetime="2019-05-06T17:27:00+08:00">2019-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="imagezmq"><a href="#imagezmq" class="headerlink" title="imagezmq"></a>imagezmq</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/jeffbass/imagezmq.git</span><br></pre></td></tr></table></figure>

<p>imagezmq has been tested with:</p>
<ol>
<li>Python 3.5 and 3.6</li>
<li>OpenCV 3.3</li>
<li>Raspian Stretch and Raspian Jessie</li>
<li>PyZMQ 16.0</li>
<li>imutils 0.4.3 (used get to images from PiCamera)</li>
</ol>
<h3 id="install-tools"><a href="#install-tools" class="headerlink" title="install tools"></a>install tools</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">workon py3cv3  <span class="comment"># use your virtual environment name</span></span><br><span class="line">pip install pyzmq</span><br><span class="line">pip install imutils</span><br></pre></td></tr></table></figure>

<h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terminal 1</span></span><br><span class="line"><span class="built_in">cd</span> imagezmq/tests</span><br><span class="line">python test_1_receive_images.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># terminal 2</span></span><br><span class="line"><span class="built_in">cd</span> imagezmq/tests</span><br><span class="line">python test_1_send_images.py</span><br></pre></td></tr></table></figure>

<p>received image snapshot </p>
<p><img src="https://kezunlin.me/images/posts/1864218-20191126082032239-1816648652.png" alt="receive image"></p>
<p><img src="https://kezunlin.me/images/posts/1864218-20191126082034446-206139701.png" alt="receive image 2"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.pyimagesearch.com/2019/04/15/live-video-streaming-over-network-with-opencv-and-imagezmq/">live-video-streaming-over-network-with-opencv-and-imagezmq</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jeffbass/imagezmq">imagezmq</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190506: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/cpp-ref/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/cpp-ref/" class="post-title-link" itemprop="url">cpp ref</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-29 07:56:00" itemprop="dateCreated datePublished" datetime="2019-04-29T07:56:00+08:00">2019-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="sizeof-array"><a href="#sizeof-array" class="headerlink" title="sizeof(array)"></a>sizeof(array)</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">print_size1</span><span class="params">(<span class="type">int</span> a[], <span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">// int add(int*, int)</span></span><br><span class="line">	std::cout&lt;&lt; <span class="built_in">sizeof</span>(a) &lt;&lt; std::endl; </span><br><span class="line">	<span class="comment">// we get sizeof(int*)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">print_size2</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">// int add(int*, int)</span></span><br><span class="line">	std::cout&lt;&lt; <span class="built_in">sizeof</span>(a) &lt;&lt; std::endl;</span><br><span class="line">	<span class="comment">// we get sizeof(int*)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_ELEMENTS(array) (sizeof(array)/sizeof((array)[0])) </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_array</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> a[<span class="number">5</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;</span><br><span class="line">	<span class="type">int</span> n = <span class="built_in">N_ELEMENTS</span>(a); </span><br><span class="line">	std::cout&lt;&lt;<span class="string">&quot;num  = &quot;</span>&lt;&lt; n &lt;&lt; std::endl; <span class="comment">// 5</span></span><br><span class="line">	std::cout&lt;&lt; <span class="built_in">sizeof</span>(<span class="type">int</span>) &lt;&lt; std::endl; <span class="comment">// int size</span></span><br><span class="line">	std::cout&lt;&lt; <span class="built_in">sizeof</span>(<span class="type">int</span>*) &lt;&lt; std::endl; <span class="comment">// pointer size</span></span><br><span class="line">	std::cout&lt;&lt; <span class="built_in">sizeof</span>(a) &lt;&lt; std::endl; <span class="comment">// 20</span></span><br><span class="line">	<span class="built_in">print_size1</span>(a, <span class="number">5</span>);</span><br><span class="line">	<span class="built_in">print_size2</span>(a, <span class="number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>An array-type is implicitly converted into pointer type when you pass it in to a function.<br>int a[]作为函数参数，隐式的转换为int *a. </p>
</blockquote>
<p>编译会产生warning.</p>
<pre><code>warning: ‘sizeof’ on array function parameter ‘a’ will return size of ‘int*’ [-Wsizeof-array-argument]
  std::cout&lt;&lt; sizeof(a) &lt;&lt; std::endl; // pointer size
</code></pre>
<h3 id="char-string"><a href="#char-string" class="headerlink" title="char* string"></a>char* string</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_str1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// warning: ISO C++ forbids converting a string constant to ‘char*’ [-Wwrite-strings]</span></span><br><span class="line">    <span class="type">char</span>* str = <span class="string">&quot;Hello&quot;</span>;  <span class="comment">//Warning</span></span><br><span class="line">  </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* str1 = <span class="string">&quot;Hello&quot;</span>; <span class="comment">// No warning </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// trying to modify const string literal </span></span><br><span class="line">    <span class="comment">// gives Runtime error  </span></span><br><span class="line">	<span class="comment">// segmentation fault (core dumped)</span></span><br><span class="line">    <span class="comment">//str[1] = &#x27;o&#x27;; </span></span><br><span class="line">  </span><br><span class="line">    cout &lt;&lt; str &lt;&lt; endl; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Hello常量字符串，存放在静态数据区; 由于字符串常量无需改动，放在静态内存区会提高效率.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_str2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> str1[] = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">	<span class="type">char</span> str2[] = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> str3[] = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> str4[] = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *str5 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *str6 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">	cout &lt;&lt; ( str1 == str2 ) &lt;&lt; endl; <span class="comment">// 0</span></span><br><span class="line">	cout &lt;&lt; ( str3 == str4 ) &lt;&lt; endl; <span class="comment">// 0</span></span><br><span class="line">	cout &lt;&lt; ( str5 == str6 ) &lt;&lt; endl; <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">	str1[<span class="number">1</span>] = <span class="string">&#x27;B&#x27;</span>; <span class="comment">// OK </span></span><br><span class="line">	<span class="comment">//str3[1] = &#x27;B&#x27;; // Compiler ERROR</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">str1,str2,str3,str4是数组变量。它们有各自的内存空间；</span></span><br><span class="line"><span class="comment">而str5,str6是指针，它们指向同样的常量字符串。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">return_str</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="type">const</span> <span class="type">char</span> *p=<span class="string">&quot;abc&quot;</span>;</span><br><span class="line"> 	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_str3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="type">const</span> <span class="type">char</span> *str=<span class="literal">NULL</span>; </span><br><span class="line"> 	str= <span class="built_in">return_str</span>();</span><br><span class="line"> 	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str); <span class="comment">// abc</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">由于&quot;abc&quot;是一个字符串常量，存放在静态数据区。把该字符串常量存放的静态数据区的首地址赋值给了指针。</span></span><br><span class="line"><span class="comment">所以return_str函数退出时，该字符串常量所在内存不会被回收。故可以通过指针顺利无误的訪问。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span>* <span class="title">return_str2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="type">char</span> p[] =<span class="string">&quot;abc&quot;</span>;</span><br><span class="line"> 	<span class="keyword">return</span> p; <span class="comment">// warning: address of local variable ‘p’ returned [-Wreturn-local-addr]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_str4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="type">char</span> *str=<span class="literal">NULL</span>; </span><br><span class="line"> 	str= <span class="built_in">return_str2</span>();</span><br><span class="line"> 	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str); <span class="comment">// null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&quot;abc&quot;是一个字符串常量，存放在静态数据区。</span></span><br><span class="line"><span class="comment">可是把一个字符串常量赋值给了一个局部变量(char []型数组)，该局部变量存放在栈中，该数组空间中也存储&quot;abc&quot;的一份拷贝。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">也就是说`char p[]=&quot;abc&quot;;`这条语句让&quot;abc&quot;这个字符串在内存中有两份拷贝，一份在动态分配的栈中，还有一份在静态存储区。</span></span><br><span class="line"><span class="comment">这是与前者return_str1最本质的差别，当return_str2函数退出时，栈要清空，局部变量的内存也被清空了。</span></span><br><span class="line"><span class="comment">所以这时的函数返回的是一个已被释放的内存地址。所以打印出来的是null。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span>* <span class="title">return_str3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="type">static</span> <span class="type">char</span> p[]=<span class="string">&quot;abc&quot;</span>; <span class="comment">//p存放在静态存储区，内容为abc</span></span><br><span class="line"> 	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_str5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="type">char</span> *str=<span class="literal">NULL</span>; </span><br><span class="line"> 	str= <span class="built_in">return_str3</span>();</span><br><span class="line"> 	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str); <span class="comment">// abc</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">如果函数的返回值非要是一个局部变量的地址，那么该局部变量一定要申明为static类型。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/char-vs-stdstring-vs-char-c/">char*-vs-stdstring</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gavanwanggw/p/7246880.html">const string</a></p>
<h3 id="NULL-vs-nullptr"><a href="#NULL-vs-nullptr" class="headerlink" title="NULL vs nullptr"></a>NULL vs nullptr</h3><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/understanding-nullptr-c/">nullptr</a><br>NULL  (void *)0 </p>
<ul>
<li>convert to integer</li>
<li>pointer</li>
</ul>
<p>nullptr keyword</p>
<ul>
<li>pointer </li>
<li>CAN NOT convert to integer</li>
<li>nullptr is convertible to bool.</li>
</ul>
<h3 id="const-vs-non-const"><a href="#const-vs-non-const" class="headerlink" title="const vs non-const"></a>const vs non-const</h3><blockquote>
<p>Use const whenever possible.</p>
</blockquote>
<blockquote>
<p>将某些东西声明为const可以帮助编译器侦测出错误的用法。const可以被施加于任何作用域内的对象、函数参数、函数返回类型、成员函数本体。<br>当const和non-const成员函数有实质等价的实现时，令non-const版本去调用const版本可以避免代码重复。反之则不可。</p>
</blockquote>
<h4 id="code"><a href="#code" class="headerlink" title="code"></a>code</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TextBlock</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">...</span><br><span class="line">    <span class="comment">//const：和原先一样</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>&amp; <span class="keyword">operator</span>[] (std::<span class="type">size_t</span> position) <span class="type">const</span> </span><br><span class="line">    &#123; </span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> text[position]; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//non-const：发生区别，直接调用了const op[]</span></span><br><span class="line">    <span class="type">char</span>&amp; <span class="keyword">operator</span>[] (std::<span class="type">size_t</span> position)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>   <span class="comment">//直接return</span></span><br><span class="line">            <span class="built_in">const_cast</span>&lt;<span class="type">char</span>&amp;&gt;(  <span class="comment">//(3)将op[]返回值的const移除</span></span><br><span class="line">                <span class="built_in">static_cast</span>&lt;<span class="type">const</span> TextBlock&amp;&gt;(*<span class="keyword">this</span>)    <span class="comment">//(1)为*this加上const</span></span><br><span class="line">                    [position]    <span class="comment">//(2)调用const op[]</span></span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>两次转型:<br>第一次，用来为<em>this添加 const，将</em>this从其原始类型TextBlock&amp; 转换为const TextBlock&amp;，使得接下来调用operator[]是可以条用const的版本，使用<code>static_cast</code>。<br>第二次，则是从const operator[]的返回值中移除const，利用<code>const_cast</code>来完成。</p>
</blockquote>
<h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><ul>
<li>static: internal linkage</li>
<li>extern: external linkage</li>
</ul>
<h3 id="extern"><a href="#extern" class="headerlink" title="extern"></a>extern</h3><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/understanding-extern-keyword-in-c/">extern</a></p>
<blockquote>
<p>extern is present by default with C functions.<br>Since the declaration can be done any number of times and definition can be done only once</p>
</blockquote>
<h3 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h3><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/understanding-volatile-qualifier-c-set-1-introduction/">volatile</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yc_sunniwell/archive/2010/06/24/1764231.html">volatile cnblogs</a></p>
<blockquote>
<p>volatile 异变的，告诉compiler这个值可能会在当前线程外部被改变，因此不要进行优化，每次都从ram地址读取，而不要从register读取缓存的副本。</p>
</blockquote>
<h3 id="Internal-Linkage-and-External-Linkage-in-C"><a href="#Internal-Linkage-and-External-Linkage-in-C" class="headerlink" title="Internal Linkage and External Linkage in C"></a>Internal Linkage and External Linkage in C</h3><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/internal-linkage-external-linkage-c/">internal linkage and external linkage</a><br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1358400/what-is-external-linkage-and-internal-linkage">what-is-external-linkage-and-internal-linkage</a></p>
<blockquote>
<p>scope is a property handled by compiler, whereas linkage is a property handled by linker.<br>external linkage means the symbol (function or global variable) is accessible throughout your program and internal linkage means that it’s only accessible in one translation unit.<br>You can explicitly control the linkage of a symbol by using the extern and static keywords. If the linkage isn’t specified then the default linkage is extern for non-const symbols and static (internal) for const symbols.<br>The keyword static plays a double role. (1) When used in the definitions of global variables, it specifies internal linkage. (2) When used in the definitions of the local variables, it specifies that the lifetime of the variable is going to be the duration of the program instead of being the duration of the function.</p>
</blockquote>
<h3 id="constexpr"><a href="#constexpr" class="headerlink" title="constexpr"></a>constexpr</h3><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/understanding-constexper-specifier-in-c/">constexper</a></p>
<blockquote>
<p>constexpr is a feature added in C++ 11. The main idea is performance improvement of programs by doing computations at compile time rather than run time.</p>
</blockquote>
<h4 id="constexpr-vs-inline-functions"><a href="#constexpr-vs-inline-functions" class="headerlink" title="constexpr vs inline functions"></a>constexpr vs inline functions</h4><blockquote>
<p>Both are for performance improvements, inline functions are request to compiler to expand at compile time and save time of function call overheads. In inline functions, expressions are always evaluated at run time. constexpr is different, here expressions are evaluated at compile time.</p>
</blockquote>
<h3 id="vtable-and-vptr"><a href="#vtable-and-vptr" class="headerlink" title="vtable and vptr"></a>vtable and vptr</h3><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/virtual-functions-and-runtime-polymorphism-in-c-set-1-introduction/">virtual-functions-and-runtime-polymorphism</a><br><a target="_blank" rel="noopener" href="https://practice.geeksforgeeks.org/problems/what-are-vtable-and-vptr">what-are-vtable-and-vptr</a><br><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/calling-virtual-methods-in-constructordestructor-in-cpp/">calling-virtual-methods-in-constructordestructor-in-cpp</a></p>
<blockquote>
<p>It is highly recommended to avoid calling virtual methods from constructor&#x2F;destructor.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hellogiser/p/virtual-function-table.html">virtual-function-table</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hellogiser/p/class-memory-layout.html">class-memory-layout</a></p>
<h3 id="Virtual-Constructor"><a href="#Virtual-Constructor" class="headerlink" title="Virtual Constructor"></a>Virtual Constructor</h3><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/advanced-c-virtual-constructor/">Virtual Constructor</a></p>
<blockquote>
<p>Virtual Constructor, NO<br>Can we make a class constructor virtual in C++ to create polymorphic objects? No. C++ being static typed (the purpose of RTTI is different) language, it is meaningless to the C++ compiler to create an object polymorphically. The compiler must be aware of the class type to create the object. In other words, what type of object to be created is a compile time decision from C++ compiler perspective. If we make constructor virtual, compiler flags an error.</p>
</blockquote>
<h3 id="Virtual-Destructor"><a href="#Virtual-Destructor" class="headerlink" title="Virtual Destructor"></a>Virtual Destructor</h3><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/virtual-destructor/">Virtual Destructor</a></p>
<blockquote>
<p>Deleting a derived class object using a pointer to a base class that has a non-virtual destructor results in undefined behavior.</p>
</blockquote>
<h3 id="Advanced"><a href="#Advanced" class="headerlink" title="Advanced"></a>Advanced</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/order-constructor-destructor-call-c/">Order of Constructor&#x2F; Destructor Call in C++</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/make-class-whose-objects-can-dynamically-allocated/">How to make a C++ class whose objects can only be dynamically allocated?</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/possible-call-constructor-destructor-explicitly/">Is it possible to call constructor and destructor explicitly?</a></p>
<blockquote>
<p>Yes, it is possible to call special member functions explicitly by programmer.<br>When the constructor is called explicitly the compiler creates a nameless temporary object and it is immediately destroyed.<br>we should never call destructor explicitly on local (automatic) object, because really bad results can be acquired by doing that.<br>Local objects are automatically destroyed by compiler when they go out of scope and this is the guarantee of C++ language.</p>
</blockquote>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/output-of-c-program-set-18-3/">Print 1 to 100 in C++, without loop and recursion</a></p>
<blockquote>
<p> Template Metaprogramming</p>
</blockquote>
</li>
</ul>
<p>thread </p>
<ul>
<li>pass by value by default</li>
<li>pass by ref: <code>std::ref(variable)</code></li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/cplusplus/cpp_overloading.htm">tutorialspoint full (easy)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/c-plus-plus/">geeksforgeeks full (medium)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/multithreading-in-cpp/">geeksforgeeks multithreading</a></li>
<li><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/container/unordered_map">cppreference</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190429: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/cpp11-push-back-and-emplace-back/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/cpp11-push-back-and-emplace-back/" class="post-title-link" itemprop="url">difference between push_back and emplace_back with C++ 11</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-22 17:25:00" itemprop="dateCreated datePublished" datetime="2019-04-22T17:25:00+08:00">2019-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="case1"><a href="#case1" class="headerlink" title="case1"></a>case1</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">A</span> (<span class="type">int</span> x_arg) : <span class="built_in">x</span> (x_arg) &#123; std::cout &lt;&lt; <span class="string">&quot;A (x_arg)\n&quot;</span>; &#125;</span><br><span class="line">  <span class="built_in">A</span> () &#123; x = <span class="number">0</span>; std::cout &lt;&lt; <span class="string">&quot;A ()\n&quot;</span>; &#125;</span><br><span class="line">  <span class="built_in">A</span> (<span class="type">const</span> A &amp;rhs) <span class="keyword">noexcept</span> &#123; x = rhs.x; std::cout &lt;&lt; <span class="string">&quot;A (A &amp;)\n&quot;</span>; &#125;</span><br><span class="line">  <span class="built_in">A</span> (A &amp;&amp;rhs) <span class="keyword">noexcept</span> &#123; x = rhs.x; std::cout &lt;&lt; <span class="string">&quot;A (A &amp;&amp;)\n&quot;</span>; &#125;</span><br><span class="line">  ~<span class="built_in">A</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;~A ()\n&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="type">int</span> x;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_emplace_back_1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// For emplace_back constructor A (int x_arg) will be called.</span></span><br><span class="line">	<span class="comment">// And for push_back A (int x_arg) is called first and </span></span><br><span class="line">	<span class="comment">// move A (A &amp;&amp;rhs) is called afterwards</span></span><br><span class="line">  &#123;</span><br><span class="line">    std::vector&lt;A&gt; a;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;call emplace_back:\n&quot;</span>;</span><br><span class="line">    a.<span class="built_in">emplace_back</span>(<span class="number">0</span>); </span><br><span class="line">	<span class="comment">// (1) direct object creation inside vector</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    std::vector&lt;A&gt; a;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;call push_back:\n&quot;</span>;</span><br><span class="line">    a.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="comment">// (1) create temp object and </span></span><br><span class="line">	<span class="comment">// (2) then move copy to vector and </span></span><br><span class="line">	<span class="comment">// (3) free temp object</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">call emplace_back:</span></span><br><span class="line"><span class="comment">A (x_arg)</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment">call push_back:</span></span><br><span class="line"><span class="comment">A (x_arg)</span></span><br><span class="line"><span class="comment">A (A &amp;&amp;)</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>see <img src="https://kezunlin.me/images/posts/635233-20191015111647199-971244470.jpg" alt="kezunlin"></p>
<blockquote>
<p>image from <a target="_blank" rel="noopener" href="http://candcplusplus.com/c-difference-between-emplace_back-and-push_back-function">c-difference-between-emplace_back-and-push_back-function</a></p>
</blockquote>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<h3 id="case2"><a href="#case2" class="headerlink" title="case2"></a>case2</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_emplace_back_2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// emplace_back and push_back for `A(0)`, it&#x27;s same.</span></span><br><span class="line">	<span class="comment">// A (int x_arg) is called first and </span></span><br><span class="line">	<span class="comment">// move A (A &amp;&amp;rhs) is called afterwards</span></span><br><span class="line">  &#123;</span><br><span class="line">    std::vector&lt;A&gt; a;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;call emplace_back:\n&quot;</span>;</span><br><span class="line">    a.<span class="built_in">emplace_back</span>(<span class="built_in">A</span>(<span class="number">0</span>)); </span><br><span class="line">	<span class="comment">// (1) create temp object and </span></span><br><span class="line">	<span class="comment">// (2) then move copy to vector and </span></span><br><span class="line">	<span class="comment">// (3) free temp object</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    std::vector&lt;A&gt; a;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;call push_back:\n&quot;</span>;</span><br><span class="line">    a.<span class="built_in">push_back</span>(<span class="built_in">A</span>(<span class="number">1</span>));</span><br><span class="line">	<span class="comment">// (1) create temp object and </span></span><br><span class="line">	<span class="comment">// (2) then move copy to vector and </span></span><br><span class="line">	<span class="comment">// (3) free temp object</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">call emplace_back:</span></span><br><span class="line"><span class="comment">A (x_arg)</span></span><br><span class="line"><span class="comment">A (A &amp;&amp;)</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment">call push_back:</span></span><br><span class="line"><span class="comment">A (x_arg)</span></span><br><span class="line"><span class="comment">A (A &amp;&amp;)</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h3 id="case-3"><a href="#case-3" class="headerlink" title="case 3"></a>case 3</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_emplace_back_3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// emplace_back and push_back for `A obj(0)`, it&#x27;s same.</span></span><br><span class="line">	<span class="comment">// A (int x_arg) is called first and </span></span><br><span class="line">	<span class="comment">// copy constructor A (A &amp;) is called afterwards</span></span><br><span class="line">  &#123;</span><br><span class="line">    std::vector&lt;A&gt; a;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;call emplace_back:\n&quot;</span>;</span><br><span class="line">    <span class="function">A <span class="title">obj</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">    a.<span class="built_in">emplace_back</span>(obj); </span><br><span class="line">	 <span class="comment">// copy constructor to vector</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    std::vector&lt;A&gt; a;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;call push_back:\n&quot;</span>;</span><br><span class="line">    <span class="function">A <span class="title">obj</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">    a.<span class="built_in">push_back</span>(obj);</span><br><span class="line">	 <span class="comment">// copy constructor to vector</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">call emplace_back:</span></span><br><span class="line"><span class="comment">A (x_arg)</span></span><br><span class="line"><span class="comment">A (A &amp;)</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment">call push_back:</span></span><br><span class="line"><span class="comment">A (x_arg)</span></span><br><span class="line"><span class="comment">A (A &amp;)</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment">~A ()</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>


<h3 id="extract-subvector"><a href="#extract-subvector" class="headerlink" title="extract subvector"></a>extract subvector</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;<span class="type">int</span>&gt;::const_iterator first = myVec.<span class="built_in">begin</span>() + <span class="number">10</span>;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt;::const_iterator last = myVec.<span class="built_in">begin</span>() + <span class="number">15</span>;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">newVec</span><span class="params">(first, last)</span></span>; <span class="comment">// [10,15)</span></span><br></pre></td></tr></table></figure>


<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4303513/push-back-vs-emplace-back">push-back-vs-emplace-back</a></li>
<li><a target="_blank" rel="noopener" href="http://candcplusplus.com/c-difference-between-emplace_back-and-push_back-function">c-difference-between-emplace_back-and-push_back-function</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/yockie/article/details/52674366">push_back and emplace_back</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190422: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/tensorrt-fp32-fp16-tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/tensorrt-fp32-fp16-tutorial/" class="post-title-link" itemprop="url">use nvidia tensorrt fp32 fp16 to do inference with caffe and pytorch model</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-22 15:38:00" itemprop="dateCreated datePublished" datetime="2019-04-22T15:38:00+08:00">2019-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/" itemprop="url" rel="index"><span itemprop="name">deep learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><a href="https://kezunlin.me/post/dacc4196/">Part 1: install and configure tensorrt 4 on ubuntu 16.04</a></li>
<li><strong><a href="https://kezunlin.me/post/bcdfb73c/">Part 2: tensorrt fp32 fp16 tutorial</a></strong></li>
<li><a href="https://kezunlin.me/post/30e0cb19/">Part 3: tensorrt int8 tutorial</a></li>
</ul>
<h2 id="Code-Example"><a href="#Code-Example" class="headerlink" title="Code Example"></a>Code Example</h2><h3 id="include-headers"><a href="#include-headers" class="headerlink" title="include headers"></a>include headers</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cuda_runtime_api.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;NvCaffeParser.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;NvOnnxConfig.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;NvOnnxParser.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;NvInfer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> nvinfer1;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> nvcaffeparser1;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> Logger gLogger;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attributes of MNIST Caffe model</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> INPUT_H = <span class="number">28</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> INPUT_W = <span class="number">28</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> OUTPUT_SIZE = <span class="number">10</span>;</span><br><span class="line"><span class="comment">//const char* INPUT_BLOB_NAME = &quot;data&quot;;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* OUTPUT_BLOB_NAME = <span class="string">&quot;prob&quot;</span>;</span><br><span class="line"><span class="type">const</span> std::string mnist_data_dir = <span class="string">&quot;data/mnist/&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple PGM (portable greyscale map) reader</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readPGMFile</span><span class="params">(<span class="type">const</span> std::string&amp; fileName, <span class="type">uint8_t</span> buffer[INPUT_H * INPUT_W])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">readPGMFile</span>(fileName, buffer, INPUT_H, INPUT_W);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="caffe-model-to-tensorrt"><a href="#caffe-model-to-tensorrt" class="headerlink" title="caffe model to tensorrt"></a>caffe model to tensorrt</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">caffeToTRTModel</span><span class="params">(<span class="type">const</span> std::string&amp; deployFilepath,       <span class="comment">// Path of Caffe prototxt file</span></span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">const</span> std::string&amp; modelFilepath,        <span class="comment">// Path of Caffe model file</span></span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">const</span> std::vector&lt;std::string&gt;&amp; outputs, <span class="comment">// Names of network outputs</span></span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">unsigned</span> <span class="type">int</span> maxBatchSize,               <span class="comment">// Note: Must be at least as large as the batch we want to run with</span></span></span></span><br><span class="line"><span class="params"><span class="function">                     IHostMemory*&amp; trtModelStream)</span>            <span class="comment">// Output buffer for the TRT model</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Create builder</span></span><br><span class="line">    IBuilder* builder = <span class="built_in">createInferBuilder</span>(gLogger);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse caffe model to populate network, then set the outputs</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Reading Caffe prototxt: &quot;</span> &lt;&lt; deployFilepath &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Reading Caffe model: &quot;</span> &lt;&lt; modelFilepath &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    INetworkDefinition* network = builder-&gt;<span class="built_in">createNetwork</span>();</span><br><span class="line">    ICaffeParser* parser = <span class="built_in">createCaffeParser</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> useFp16 = builder-&gt;<span class="built_in">platformHasFastFp16</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;platformHasFastFp16: &quot;</span> &lt;&lt; useFp16 &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> useInt8 = builder-&gt;<span class="built_in">platformHasFastInt8</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;platformHasFastInt8: &quot;</span> &lt;&lt; useInt8 &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a 16-bit model if it&#x27;s natively supported</span></span><br><span class="line">    DataType modelDataType = useFp16 ? DataType::kHALF : DataType::kFLOAT; </span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> IBlobNameToTensor* blobNameToTensor = parser-&gt;<span class="built_in">parse</span>(deployFilepath.<span class="built_in">c_str</span>(),</span><br><span class="line">                                                              modelFilepath.<span class="built_in">c_str</span>(),</span><br><span class="line">                                                              *network,</span><br><span class="line">                                                              modelDataType);</span><br><span class="line">    <span class="comment">// Specify output tensors of network</span></span><br><span class="line">    <span class="comment">// ERROR: Network must have at least one output</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; s : outputs)&#123;</span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;output = &quot;</span>&lt;&lt; s.<span class="built_in">c_str</span>() &lt;&lt; std::endl;</span><br><span class="line">        network-&gt;<span class="built_in">markOutput</span>(*blobNameToTensor-&gt;<span class="built_in">find</span>(s.<span class="built_in">c_str</span>())); <span class="comment">// prob</span></span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    builder-&gt;<span class="built_in">setMaxBatchSize</span>(maxBatchSize);</span><br><span class="line">    builder-&gt;<span class="built_in">setMaxWorkspaceSize</span>(<span class="number">1</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set up the network for paired-fp16 format if available</span></span><br><span class="line">    <span class="keyword">if</span>(useFp16)</span><br><span class="line">        builder-&gt;<span class="built_in">setFp16Mode</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build engine</span></span><br><span class="line">    ICudaEngine* engine = builder-&gt;<span class="built_in">buildCudaEngine</span>(*network);</span><br><span class="line">    <span class="built_in">assert</span>(engine);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Destroy parser and network</span></span><br><span class="line">    network-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">    parser-&gt;<span class="built_in">destroy</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Serialize engine and destroy it</span></span><br><span class="line">    trtModelStream = engine-&gt;<span class="built_in">serialize</span>();</span><br><span class="line">    engine-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">    builder-&gt;<span class="built_in">destroy</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//shutdownProtobufLibrary();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="pytorch-onnx-to-tensorrt"><a href="#pytorch-onnx-to-tensorrt" class="headerlink" title="pytorch onnx to tensorrt"></a>pytorch onnx to tensorrt</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">onnxToTRTModel</span><span class="params">( <span class="type">const</span> std::string&amp; modelFilepath,        <span class="comment">// name of the onnx model </span></span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">unsigned</span> <span class="type">int</span> maxBatchSize,            <span class="comment">// batch size - NB must be at least as large as the batch we want to run with</span></span></span></span><br><span class="line"><span class="params"><span class="function">                     IHostMemory *&amp;trtModelStream)</span>      <span class="comment">// output buffer for the TensorRT model</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// create the builder</span></span><br><span class="line">    IBuilder* builder = <span class="built_in">createInferBuilder</span>(gLogger);</span><br><span class="line"></span><br><span class="line">    nvonnxparser::IOnnxConfig* config = nvonnxparser::<span class="built_in">createONNXConfig</span>();</span><br><span class="line">    config-&gt;<span class="built_in">setModelFileName</span>(modelFilepath.<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    nvonnxparser::IONNXParser* parser = nvonnxparser::<span class="built_in">createONNXParser</span>(*config);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Optional - uncomment below lines to view network layer information</span></span><br><span class="line">    <span class="comment">//config-&gt;setPrintLayerInfo(true);</span></span><br><span class="line">    <span class="comment">//parser-&gt;reportParsingInfo();</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!parser-&gt;<span class="built_in">parse</span>(modelFilepath.<span class="built_in">c_str</span>(), DataType::kFLOAT))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">string <span class="title">msg</span><span class="params">(<span class="string">&quot;failed to parse onnx file&quot;</span>)</span></span>;</span><br><span class="line">        gLogger.<span class="built_in">log</span>(nvinfer1::ILogger::Severity::kERROR, msg.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!parser-&gt;<span class="built_in">convertToTRTNetwork</span>()) &#123;</span><br><span class="line">        <span class="function">string <span class="title">msg</span><span class="params">(<span class="string">&quot;ERROR, failed to convert onnx network into TRT network&quot;</span>)</span></span>;</span><br><span class="line">        gLogger.<span class="built_in">log</span>(nvinfer1::ILogger::Severity::kERROR, msg.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    nvinfer1::INetworkDefinition* network = parser-&gt;<span class="built_in">getTRTNetwork</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Build the engine</span></span><br><span class="line">    builder-&gt;<span class="built_in">setMaxBatchSize</span>(maxBatchSize);</span><br><span class="line">    builder-&gt;<span class="built_in">setMaxWorkspaceSize</span>(<span class="number">1</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    ICudaEngine* engine = builder-&gt;<span class="built_in">buildCudaEngine</span>(*network);</span><br><span class="line">    <span class="built_in">assert</span>(engine);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we don&#x27;t need the network any more, and we can destroy the parser</span></span><br><span class="line">    network-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">    parser-&gt;<span class="built_in">destroy</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// serialize the engine, then close everything down</span></span><br><span class="line">    trtModelStream = engine-&gt;<span class="built_in">serialize</span>();</span><br><span class="line">    engine-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">    builder-&gt;<span class="built_in">destroy</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//shutdownProtobufLibrary();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="do-inference"><a href="#do-inference" class="headerlink" title="do inference"></a>do inference</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">doInference</span><span class="params">(IExecutionContext&amp; context, <span class="type">float</span>* input, <span class="type">float</span>* output, <span class="type">int</span> batchSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> ICudaEngine&amp; engine = context.<span class="built_in">getEngine</span>();</span><br><span class="line">    <span class="comment">// Pointers to input and output device buffers to pass to engine.</span></span><br><span class="line">    <span class="comment">// Engine requires exactly IEngine::getNbBindings() number of buffers.</span></span><br><span class="line">    <span class="built_in">assert</span>(engine.<span class="built_in">getNbBindings</span>() == <span class="number">2</span>);</span><br><span class="line">    <span class="type">void</span>* buffers[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// In order to bind the buffers, we need to know the names of the input and output tensors.</span></span><br><span class="line">    <span class="comment">// Note that indices are guaranteed to be less than IEngine::getNbBindings()</span></span><br><span class="line">    <span class="type">int</span> inputIndex, outputIndex;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Bindings after deserializing:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> bi = <span class="number">0</span>; bi &lt; engine.<span class="built_in">getNbBindings</span>(); bi++) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (engine.<span class="built_in">bindingIsInput</span>(bi) == <span class="literal">true</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            inputIndex = bi;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Binding %d (%s): Input.\n&quot;</span>,  bi, engine.<span class="built_in">getBindingName</span>(bi));</span><br><span class="line">        &#125; <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            outputIndex = bi;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Binding %d (%s): Output.\n&quot;</span>, bi, engine.<span class="built_in">getBindingName</span>(bi));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//const int inputIndex = engine.getBindingIndex(INPUT_BLOB_NAME);</span></span><br><span class="line">    <span class="comment">//const int outputIndex = engine.getBindingIndex(OUTPUT_BLOB_NAME);</span></span><br><span class="line"></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;inputIndex = &quot;</span>&lt;&lt; inputIndex &lt;&lt; std::endl; <span class="comment">// 0   data</span></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;outputIndex = &quot;</span>&lt;&lt; outputIndex &lt;&lt; std::endl; <span class="comment">// 1  prob</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create GPU buffers on device</span></span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="built_in">cudaMalloc</span>(&amp;buffers[inputIndex], batchSize * INPUT_H * INPUT_W * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="built_in">cudaMalloc</span>(&amp;buffers[outputIndex], batchSize * OUTPUT_SIZE * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create stream</span></span><br><span class="line">    cudaStream_t stream;</span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="built_in">cudaStreamCreate</span>(&amp;stream));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DMA input batch data to device, infer on the batch asynchronously, and DMA output back to host</span></span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="built_in">cudaMemcpyAsync</span>(buffers[inputIndex], input, batchSize * INPUT_H * INPUT_W * <span class="built_in">sizeof</span>(<span class="type">float</span>), cudaMemcpyHostToDevice, stream));</span><br><span class="line">    context.<span class="built_in">enqueue</span>(batchSize, buffers, stream, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="built_in">cudaMemcpyAsync</span>(output, buffers[outputIndex], batchSize * OUTPUT_SIZE * <span class="built_in">sizeof</span>(<span class="type">float</span>), cudaMemcpyDeviceToHost, stream));</span><br><span class="line">    <span class="built_in">cudaStreamSynchronize</span>(stream);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Release stream and buffers</span></span><br><span class="line">    <span class="built_in">cudaStreamDestroy</span>(stream);</span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="built_in">cudaFree</span>(buffers[inputIndex]));</span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="built_in">cudaFree</span>(buffers[outputIndex]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<h3 id="save-and-load-engine"><a href="#save-and-load-engine" class="headerlink" title="save and load engine"></a>save and load engine</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SaveEngine</span><span class="params">(<span class="type">const</span> nvinfer1::IHostMemory&amp; trtModelStream, <span class="type">const</span> std::string&amp; engine_filepath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::ofstream file;</span><br><span class="line">    file.<span class="built_in">open</span>(engine_filepath, std::ios::binary | std::ios::out);</span><br><span class="line">    <span class="keyword">if</span>(!file.<span class="built_in">is_open</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;read create engine file&quot;</span> &lt;&lt; engine_filepath &lt;&lt;<span class="string">&quot; failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    file.<span class="built_in">write</span>((<span class="type">const</span> <span class="type">char</span>*)trtModelStream.<span class="built_in">data</span>(), trtModelStream.<span class="built_in">size</span>());</span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">ICudaEngine* <span class="title">LoadEngine</span><span class="params">(IRuntime&amp; runtime, <span class="type">const</span> std::string&amp; engine_filepath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ifstream file;</span><br><span class="line">    file.<span class="built_in">open</span>(engine_filepath, ios::binary | ios::in);</span><br><span class="line">    file.<span class="built_in">seekg</span>(<span class="number">0</span>, ios::end); </span><br><span class="line">    <span class="type">int</span> length = file.<span class="built_in">tellg</span>();         </span><br><span class="line">    file.<span class="built_in">seekg</span>(<span class="number">0</span>, ios::beg); </span><br><span class="line"></span><br><span class="line">    <span class="function">std::shared_ptr&lt;<span class="type">char</span>&gt; <span class="title">data</span><span class="params">(<span class="keyword">new</span> <span class="type">char</span>[length], std::default_delete&lt;<span class="type">char</span>[]&gt;())</span></span>;</span><br><span class="line">    file.<span class="built_in">read</span>(data.<span class="built_in">get</span>(), length);</span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// runtime-&gt;deserializeCudaEngine(trtModelStream-&gt;data(), trtModelStream-&gt;size(), nullptr);</span></span><br><span class="line">    ICudaEngine* engine = runtime.<span class="built_in">deserializeCudaEngine</span>(data.<span class="built_in">get</span>(), length, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">assert</span>(engine != <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">return</span> engine;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">demo_save_caffe_to_trt</span><span class="params">(<span class="type">const</span> std::string&amp; engine_filepath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string deploy_filepath = mnist_data_dir + <span class="string">&quot;mnist.prototxt&quot;</span>;</span><br><span class="line">    std::string model_filepath = mnist_data_dir + <span class="string">&quot;mnist.caffemodel&quot;</span>;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">// Create TRT model from caffe model and serialize it to a stream</span></span><br><span class="line">    IHostMemory* trtModelStream&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="built_in">caffeToTRTModel</span>(deploy_filepath, model_filepath, std::vector&lt;std::string&gt;&#123;OUTPUT_BLOB_NAME&#125;, <span class="number">1</span>, trtModelStream);</span><br><span class="line">    <span class="built_in">assert</span>(trtModelStream != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SaveEngine</span>(*trtModelStream, engine_filepath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// destroy stream</span></span><br><span class="line">    trtModelStream-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">demo_save_onnx_to_trt</span><span class="params">(<span class="type">const</span> std::string&amp; engine_filepath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string onnx_filepath = mnist_data_dir + <span class="string">&quot;mnist.onnx&quot;</span>;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">// Create TRT model from caffe model and serialize it to a stream</span></span><br><span class="line">    IHostMemory* trtModelStream&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    <span class="built_in">onnxToTRTModel</span>(onnx_filepath, <span class="number">1</span>, trtModelStream);</span><br><span class="line">    <span class="built_in">assert</span>(trtModelStream != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SaveEngine</span>(*trtModelStream, engine_filepath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// destroy stream</span></span><br><span class="line">    trtModelStream-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">mnist_demo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">bool</span> use_caffe = <span class="literal">false</span>; </span><br><span class="line">    std::string engine_filepath;</span><br><span class="line">    <span class="keyword">if</span> (use_caffe)&#123;</span><br><span class="line">        engine_filepath = <span class="string">&quot;cfg/mnist/caffe_minist_fp32.trt&quot;</span>;</span><br><span class="line">        <span class="built_in">demo_save_caffe_to_trt</span>(engine_filepath);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        engine_filepath = <span class="string">&quot;cfg/mnist/onnx_minist_fp32.trt&quot;</span>;</span><br><span class="line">        <span class="built_in">demo_save_onnx_to_trt</span>(engine_filepath);</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;[API] Save engine to &quot;</span>&lt;&lt; engine_filepath &lt;&lt;std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> num = <span class="number">6</span>;</span><br><span class="line">    std::string digit_filepath = mnist_data_dir + std::<span class="built_in">to_string</span>(num) + <span class="string">&quot;.pgm&quot;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Read a digit file</span></span><br><span class="line">    <span class="type">uint8_t</span> fileData[INPUT_H * INPUT_W];</span><br><span class="line">    <span class="built_in">readPGMFile</span>(digit_filepath, fileData);</span><br><span class="line">    <span class="type">float</span> data[INPUT_H * INPUT_W];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (use_caffe)&#123;</span><br><span class="line"></span><br><span class="line">        std::string mean_filepath = mnist_data_dir + <span class="string">&quot;mnist_mean.binaryproto&quot;</span>;</span><br><span class="line">        <span class="comment">// Parse mean file</span></span><br><span class="line">        ICaffeParser* parser = <span class="built_in">createCaffeParser</span>();</span><br><span class="line">        IBinaryProtoBlob* meanBlob = parser-&gt;<span class="built_in">parseBinaryProto</span>(mean_filepath.<span class="built_in">c_str</span>());</span><br><span class="line">        parser-&gt;<span class="built_in">destroy</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Subtract mean from image</span></span><br><span class="line">        <span class="type">const</span> <span class="type">float</span>* meanData = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">float</span>*&gt;(meanBlob-&gt;<span class="built_in">getData</span>()); <span class="comment">// size 786</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; INPUT_H * INPUT_W; i++)</span><br><span class="line">            data[i] = <span class="built_in">float</span>(fileData[i]) - meanData[i];</span><br><span class="line">        </span><br><span class="line">        meanBlob-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; INPUT_H * INPUT_W; i++)</span><br><span class="line">            data[i] = <span class="number">1.0</span> - <span class="built_in">float</span>(fileData[i]/<span class="number">255.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Deserialize engine we serialized earlier</span></span><br><span class="line">    IRuntime* runtime = <span class="built_in">createInferRuntime</span>(gLogger);</span><br><span class="line">    <span class="built_in">assert</span>(runtime != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;[API] Load engine from &quot;</span>&lt;&lt; engine_filepath &lt;&lt;std::endl;</span><br><span class="line">    ICudaEngine* engine = <span class="built_in">LoadEngine</span>(*runtime, engine_filepath);</span><br><span class="line">    <span class="built_in">assert</span>(engine != <span class="literal">nullptr</span>);</span><br><span class="line">    </span><br><span class="line">    IExecutionContext* context = engine-&gt;<span class="built_in">createExecutionContext</span>();</span><br><span class="line">    <span class="built_in">assert</span>(context != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Run inference on input data</span></span><br><span class="line">    <span class="type">float</span> prob[OUTPUT_SIZE];</span><br><span class="line">    <span class="built_in">doInference</span>(*context, data, prob, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Destroy the engine</span></span><br><span class="line">    context-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">    engine-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">    runtime-&gt;<span class="built_in">destroy</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Print histogram of the output distribution</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\nOutput:\n\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for onnx,we get z as output, we need to use softmax to get probs</span></span><br><span class="line">    <span class="keyword">if</span> ( !use_caffe)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Calculate Softmax</span></span><br><span class="line">        <span class="type">float</span> sum&#123;<span class="number">0.0f</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; OUTPUT_SIZE; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            prob[i] = <span class="built_in">exp</span>(prob[i]);</span><br><span class="line">            sum += prob[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; OUTPUT_SIZE; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            prob[i] /= sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// find max probs</span></span><br><span class="line">    <span class="type">float</span> val&#123;<span class="number">0.0f</span>&#125;;</span><br><span class="line">    <span class="type">int</span> idx&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        val = std::<span class="built_in">max</span>(val, prob[i]);</span><br><span class="line">        <span class="keyword">if</span> (val == prob[i]) &#123;</span><br><span class="line">            idx = i;</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot; Prob &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;  &quot;</span>&lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">5</span>) &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">4</span>) &lt;&lt; prob[i];</span><br><span class="line">        std::cout &lt;&lt; i &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; std::<span class="built_in">string</span>(<span class="built_in">int</span>(std::<span class="built_in">floor</span>(prob[i] * <span class="number">10</span> + <span class="number">0.5f</span>)), <span class="string">&#x27;*&#x27;</span>) &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (idx == num &amp;&amp; val &gt; <span class="number">0.9f</span>) ? EXIT_SUCCESS : EXIT_FAILURE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">mnist_demo</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="results"><a href="#results" class="headerlink" title="results"></a>results</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">./bin/sample_mnist </span><br><span class="line">[API] Save engine to cfg/mnist/onnx_minist_fp32.trt</span><br><span class="line">[API] Load engine from cfg/mnist/onnx_minist_fp32.trt</span><br><span class="line">Bindings after deserializing:</span><br><span class="line">Binding 0 (Input3): Input.</span><br><span class="line">Binding 1 (Plus214_Output_0): Output.</span><br><span class="line">inputIndex = 0</span><br><span class="line">outputIndex = 1</span><br><span class="line"></span><br><span class="line">Output:</span><br><span class="line"></span><br><span class="line"> Prob 0  0.00000: </span><br><span class="line"> Prob 1  0.00001: </span><br><span class="line"> Prob 2  0.00002: </span><br><span class="line"> Prob 3  0.00003: </span><br><span class="line"> Prob 4  0.00004: </span><br><span class="line"> Prob 5  0.00005: </span><br><span class="line"> Prob 6  1.00006: **********</span><br><span class="line"> Prob 7  0.00007: </span><br><span class="line"> Prob 8  0.00008: </span><br><span class="line"> Prob 9  0.00009: </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-api/">tensorrt-api</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190422 created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/python-tkinter-tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/python-tkinter-tutorial/" class="post-title-link" itemprop="url">python tkinter tutorial</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-11 17:14:00" itemprop="dateCreated datePublished" datetime="2019-04-11T17:14:00+08:00">2019-04-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="main-ui"><a href="#main-ui" class="headerlink" title="main ui"></a>main ui</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">messagebox</span><br><span class="line">- showinfo()</span><br><span class="line">- showwarning()</span><br><span class="line">- showerror()</span><br><span class="line">- askquestion()</span><br><span class="line">- askokcancel()</span><br><span class="line">- askyesno()</span><br><span class="line">- askretrycancel()</span><br><span class="line">- askyesnocancel()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filedialog</span><br><span class="line">- asksaveasfilename() </span><br><span class="line">- asksaveasfile()</span><br><span class="line">- askopenfilename()</span><br><span class="line">- askopenfile()</span><br><span class="line">- askdirectory()</span><br><span class="line">- askopenfilenames()</span><br><span class="line">- askopenfiles()</span><br></pre></td></tr></table></figure>

<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> numpy.random <span class="keyword">import</span> seed, uniform</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> uint8, uint16, load, save</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cv2 <span class="keyword">import</span> imread, imwrite</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> listdir, makedirs</span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> exists, basename</span><br><span class="line"></span><br><span class="line"><span class="comment"># for python 3</span></span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> Tk, Frame, messagebox, filedialog, Button, Label, StringVar</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyGUI</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.root = Tk()</span><br><span class="line"></span><br><span class="line">        sw = <span class="variable language_">self</span>.root.winfo_screenwidth()</span><br><span class="line">        sh = <span class="variable language_">self</span>.root.winfo_screenheight()</span><br><span class="line">       </span><br><span class="line">        ww = <span class="number">700</span></span><br><span class="line">        wh = <span class="number">200</span></span><br><span class="line">        x = (sw-ww) / <span class="number">2</span></span><br><span class="line">        y = (sh-wh) / <span class="number">2</span></span><br><span class="line">        <span class="variable language_">self</span>.root.title(<span class="string">&#x27;Image Compress Tool&#x27;</span>)</span><br><span class="line">        <span class="comment"># center</span></span><br><span class="line">        <span class="variable language_">self</span>.root.geometry(<span class="string">&quot;%dx%d+%d+%d&quot;</span> % (ww, wh, x, y))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># frame1</span></span><br><span class="line">        frame1 = Frame(<span class="variable language_">self</span>.root) </span><br><span class="line">        frame1.grid(row=<span class="number">0</span>, column=<span class="number">0</span>, sticky=<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.input_btn = Button(frame1, text=<span class="string">&quot;Input Folder&quot;</span>, width=<span class="number">10</span>, height=<span class="number">3</span>, command=<span class="variable language_">self</span>.set_input_folder)</span><br><span class="line">        <span class="variable language_">self</span>.input_btn.pack(side=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.input_label_text = StringVar()</span><br><span class="line">        <span class="variable language_">self</span>.input_label_text.<span class="built_in">set</span>(<span class="string">&quot;Input Folder&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.input_label = Label(frame1, textvariable=<span class="variable language_">self</span>.input_label_text, width=<span class="number">70</span>, height=<span class="number">3</span>)</span><br><span class="line">        <span class="variable language_">self</span>.input_label.pack(side=<span class="string">&#x27;left&#x27;</span>) </span><br><span class="line"></span><br><span class="line">        <span class="comment"># frame2</span></span><br><span class="line">        frame2 = Frame(<span class="variable language_">self</span>.root) </span><br><span class="line">        frame2.grid(row=<span class="number">1</span>, column=<span class="number">0</span>, sticky=<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.output_btn = Button(frame2, text=<span class="string">&quot;Output Folder&quot;</span>, width=<span class="number">10</span>, height=<span class="number">3</span>, command=<span class="variable language_">self</span>.set_output_folder)</span><br><span class="line">        <span class="variable language_">self</span>.output_btn.pack(side=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.output_label_text = StringVar()</span><br><span class="line">        <span class="variable language_">self</span>.output_label_text.<span class="built_in">set</span>(<span class="string">&quot;Output Folder&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.output_label = Label(frame2, textvariable = <span class="variable language_">self</span>.output_label_text, width=<span class="number">70</span>, height=<span class="number">3</span>)</span><br><span class="line">        <span class="variable language_">self</span>.output_label.pack(side=<span class="string">&#x27;left&#x27;</span>) </span><br><span class="line"></span><br><span class="line">        <span class="comment"># frame3</span></span><br><span class="line">        frame3 = Frame(<span class="variable language_">self</span>.root)</span><br><span class="line">        frame3.grid(row=<span class="number">2</span>, column=<span class="number">0</span>, sticky=<span class="string">&#x27;nw&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.run_btn = Button(frame3, text=<span class="string">&quot;执行加密&quot;</span>, width=<span class="number">10</span>, height=<span class="number">3</span>, command=<span class="variable language_">self</span>.run_task)</span><br><span class="line">        <span class="variable language_">self</span>.run_btn.pack(side=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.run_label_text = StringVar()</span><br><span class="line">        <span class="variable language_">self</span>.run_label_text.<span class="built_in">set</span>(<span class="string">&quot;Ready&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.run_label = Label(frame3, textvariable = <span class="variable language_">self</span>.run_label_text, width=<span class="number">70</span>, height=<span class="number">3</span>)</span><br><span class="line">        <span class="variable language_">self</span>.run_label.pack(side=<span class="string">&#x27;left&#x27;</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mainloop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.root.mainloop() </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_input_folder</span>(<span class="params">self</span>):</span><br><span class="line">        result = filedialog.askdirectory()</span><br><span class="line">        <span class="variable language_">self</span>.input_label_text.<span class="built_in">set</span>(result)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_output_folder</span>(<span class="params">self</span>):</span><br><span class="line">        result = filedialog.askdirectory()</span><br><span class="line">        <span class="variable language_">self</span>.output_label_text.<span class="built_in">set</span>(result)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_task</span>(<span class="params">self</span>):</span><br><span class="line">        input_folder = <span class="variable language_">self</span>.input_label_text.get()</span><br><span class="line">        output_folder = <span class="variable language_">self</span>.output_label_text.get()</span><br><span class="line">        <span class="comment">#print(&quot;input_folder: &quot;+input_folder)</span></span><br><span class="line">        <span class="comment">#print(&quot;output_folder: &quot;+output_folder)</span></span><br><span class="line">        <span class="keyword">if</span> exists(input_folder):</span><br><span class="line">            <span class="comment">#batch_compress(input_folder, output_folder)</span></span><br><span class="line">            <span class="variable language_">self</span>.run_label_text.<span class="built_in">set</span>(<span class="string">&quot;Compress OK.&quot;</span>)</span><br><span class="line">            messagebox.showinfo(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;Compress OK.&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            messagebox.showwarning(<span class="string">&quot;Warn&quot;</span>, <span class="string">&quot;Please input folder&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gui</span>():</span><br><span class="line">    app = MyGUI()</span><br><span class="line">    app.mainloop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    gui()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>snapshots<br><img src="https://kezunlin.me/images/posts/635233-20190411172357148-1179952371.png" alt="tkinter demo"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/progor/p/8506513.html">tkinter demo</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3.5/library/tkinter.html">tkinter docs</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190411: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/speed-up-opencv-image-processing-with-openmp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/speed-up-opencv-image-processing-with-openmp/" class="post-title-link" itemprop="url">speed up opencv image processing with openmp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-03 16:14:00" itemprop="dateCreated datePublished" datetime="2019-04-03T16:14:00+08:00">2019-04-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><a href="https://kezunlin.me/post/15f5c3e8/">Part 1: compile opencv on ubuntu 16.04</a></li>
<li><a href="https://kezunlin.me/post/6580691f/">Part 2: compile opencv with CUDA support on windows 10</a></li>
<li><a href="https://kezunlin.me/post/61d55ab4/">Part 3: opencv mat for loop</a></li>
<li><strong><a href="https://kezunlin.me/post/7a6ba82e/">Part 4: speed up opencv image processing with openmp</a></strong></li>
</ul>
<h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><ul>
<li>linux&#x2F;window:  cmake with <code>CXX_FLAGS=-fopenmp</code></li>
<li>window VS: VS also support openmp, <code>C/C++| Language | /openmp</code></li>
</ul>
<h3 id="usage"><a href="#usage" class="headerlink" title="usage"></a>usage</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line">	<span class="keyword">for</span> loop ...</span><br></pre></td></tr></table></figure>

<h3 id="code"><a href="#code" class="headerlink" title="code"></a>code</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 4, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 5, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 6, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 7, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 3, I am Thread 1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="CMakeLists-txt"><a href="#CMakeLists-txt" class="headerlink" title="CMakeLists.txt"></a>CMakeLists.txt</h3><p>use <code>CXX_FLAGS=-fopenmp</code> in CMakeLists.txt</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.0</span>.<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(hello)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(OpenMP REQUIRED)</span><br><span class="line"><span class="keyword">if</span>(OPENMP_FOUND)</span><br><span class="line">    <span class="keyword">message</span>(<span class="string">&quot;OPENMP FOUND&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">message</span>([main] <span class="string">&quot; OpenMP_C_FLAGS=$&#123;OpenMP_C_FLAGS&#125;&quot;</span>) <span class="comment"># -fopenmp</span></span><br><span class="line">    <span class="keyword">message</span>([main] <span class="string">&quot; OpenMP_CXX_FLAGS&#125;=$&#123;OpenMP_CXX_FLAGS&#125;&quot;</span>) <span class="comment"># -fopenmp</span></span><br><span class="line">    <span class="keyword">message</span>([main] <span class="string">&quot; OpenMP_EXE_LINKER_FLAGS=$&#123;OpenMP_EXE_LINKER_FLAGS&#125;&quot;</span>) <span class="comment"># ***</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># no use for xxx_INCLUDE_DIRS and xxx_libraries for OpenMP</span></span><br><span class="line">    <span class="keyword">message</span>([main] <span class="string">&quot; OpenMP_INCLUDE_DIRS=$&#123;OpenMP_INCLUDE_DIRS&#125;&quot;</span>) <span class="comment"># ***</span></span><br><span class="line">    <span class="keyword">message</span>([main] <span class="string">&quot; OpenMP_LIBRARIES=$&#123;OpenMP_LIBRARIES&#125;&quot;</span>) <span class="comment"># ***</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span>(CMAKE_C_FLAGS <span class="string">&quot;$&#123;CMAKE_C_FLAGS&#125; $&#123;OpenMP_C_FLAGS&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; $&#123;OpenMP_CXX_FLAGS&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">set</span>(CMAKE_EXE_LINKER_FLAGS <span class="string">&quot;$&#123;CMAKE_EXE_LINKER_FLAGS&#125; $&#123;OpenMP_EXE_LINKER_FLAGS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(hello hello.cpp)</span><br><span class="line"><span class="comment">#target_link_libraries(hello xxx)</span></span><br></pre></td></tr></table></figure>
<p>options<br><img src="https://kezunlin.me/images/posts/635233-20181031153435506-1474472980.png" alt="openmp"></p>
<p>or use <code>g++ hello.cpp -fopenmp</code> to compile</p>
<h3 id="view-demo"><a href="#view-demo" class="headerlink" title="view demo"></a>view demo</h3><p>list dynamic dependencies  (ldd)</p>
<pre><code>ldd hello 
    linux-vdso.so.1 =&gt;  (0x00007ffd71365000)
    libstdc++.so.6 =&gt; /usr/lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007f8ea7f00000)
    libgomp.so.1 =&gt; /usr/lib/x86_64-linux-gnu/libgomp.so.1 (0x00007f8ea7cde000)
    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f8ea7914000)
    libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f8ea760b000)
    /lib64/ld-linux-x86-64.so.2 (0x00007f8ea8282000)
    libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f8ea73f5000)
    libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f8ea71f1000)
    libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f8ea6fd4000)
</code></pre>
<blockquote>
<p><code>libgomp.so.1 =&gt; /usr/lib/x86_64-linux-gnu/libgomp.so.1</code> </p>
</blockquote>
<p>list names (nm) </p>
<pre><code>nm hello 
0000000000602080 B __bss_start
0000000000602190 b completed.7594
                 U __cxa_atexit@@GLIBC_2.2.5
0000000000602070 D __data_start
0000000000602070 W data_start
0000000000400b00 t deregister_tm_clones
0000000000400b80 t __do_global_dtors_aux
0000000000601df8 t __do_global_dtors_aux_fini_array_entry
0000000000602078 d __dso_handle
0000000000601e08 d _DYNAMIC
0000000000602080 D _edata
0000000000602198 B _end
0000000000400d44 T _fini
0000000000400ba0 t frame_dummy
0000000000601de8 t __frame_dummy_init_array_entry
0000000000400f18 r __FRAME_END__
0000000000602000 d _GLOBAL_OFFSET_TABLE_
0000000000400c28 t _GLOBAL__sub_I_main
                 w __gmon_start__
0000000000400d54 r __GNU_EH_FRAME_HDR
                 U GOMP_parallel@@GOMP_4.0
                 U __gxx_personality_v0@@CXXABI_1.3
00000000004009e0 T _init
0000000000601df8 t __init_array_end
0000000000601de8 t __init_array_start
0000000000400d50 R _IO_stdin_used
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
0000000000601e00 d __JCR_END__
0000000000601e00 d __JCR_LIST__
                 w _Jv_RegisterClasses
0000000000400d40 T __libc_csu_fini
0000000000400cd0 T __libc_csu_init
                 U __libc_start_main@@GLIBC_2.2.5
0000000000400bc6 T main
0000000000400c3d t main._omp_fn.0
                 U omp_get_num_threads@@OMP_1.0
                 U omp_get_thread_num@@OMP_1.0
0000000000400b40 t register_tm_clones
0000000000400ad0 T _start
0000000000602080 d __TMC_END__
0000000000400bea t _Z41__static_initialization_and_destruction_0ii
                 U _ZNSolsEPFRSoS_E@@GLIBCXX_3.4
                 U _ZNSt8ios_base4InitC1Ev@@GLIBCXX_3.4
                 U _ZNSt8ios_base4InitD1Ev@@GLIBCXX_3.4
0000000000602080 B _ZSt4cout@@GLIBCXX_3.4
                 U _ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_@@GLIBCXX_3.4
0000000000602191 b _ZStL8__ioinit
                 U _ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_c@@GLIBCXX_3.4
                 
</code></pre>
<blockquote>
<p><code>omp_get_num_threads</code>, <code>omp_get_thread_num</code></p>
</blockquote>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>



<h2 id="OpenMP-Introduction"><a href="#OpenMP-Introduction" class="headerlink" title="OpenMP Introduction"></a>OpenMP Introduction</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/51173703">openmp</a></li>
</ul>
<p>OpenMP的指令格式</p>
<pre><code>#pragma omp directive [clause[clause]…]
#pragma omp parallel private(i, j)
</code></pre>
<blockquote>
<p><code>parallel</code> is directive， <code>private</code> is clause</p>
</blockquote>
<h3 id="directive"><a href="#directive" class="headerlink" title="directive"></a>directive</h3><ul>
<li><strong>parallel</strong>，用在一个代码段之前，表示这段代码将被多个线程并行执行</li>
<li><strong>for</strong>，用于for循环之前，将循环分配到多个线程中并行执行，必须保证每次循环之间无相关性。</li>
<li><strong>parallel for</strong>， parallel 和 for语句的结合，也是用在一个for循环之前，表示for循环的代码将被多个线程并行执行。</li>
<li><strong>sections</strong>，用在可能会被并行执行的代码段之前</li>
<li><strong>parallel sections</strong>，parallel和sections两个语句的结合</li>
<li>critical，用在一段代码临界区之前</li>
<li>single，用在一段只被单个线程执行的代码段之前，表示后面的代码段将被单线程执行。</li>
<li>flush，</li>
<li>barrier，用于并行区内代码的线程同步，所有线程执行到barrier时要停止，直到所有线程都执行到barrier时才继续往下执行。</li>
<li>atomic，用于指定一块内存区域被制动更新</li>
<li>master，用于指定一段代码块由主线程执行</li>
<li>ordered， 用于指定并行区域的循环按顺序执行</li>
<li>threadprivate, 用于指定一个变量是线程私有的。</li>
</ul>
<h4 id="parallel-for"><a href="#parallel-for" class="headerlink" title="parallel for"></a>parallel for</h4><p>OpenMP 对可以多线程化的循环有如下五个要求：</p>
<ul>
<li>循环的变量变量（就是i）必须是有符号整形，其他的都不行。</li>
<li>循环的比较条件必须是&lt; &lt;&#x3D; &gt; &gt;&#x3D;中的一种</li>
<li>循环的增量部分必须是增减一个不变的值（即每次循环是不变的）。</li>
<li>如果比较符号是&lt; &lt;&#x3D;，那每次循环i应该增加，反之应该减小</li>
<li>循环必须是没有奇奇怪怪的东西，不能从内部循环跳到外部循环，goto和break只能在循环内部跳转，异常必须在循环内部被捕获。</li>
</ul>
<p>如果你的循环不符合这些条件，那就只好改写了.</p>
<blockquote>
<p>avoid race condition</p>
</blockquote>
<p>当一个循环满足以上五个条件时，依然可能因为数据依赖而不能够合理的并行化。当两个不同的迭代之间的数据存在依赖关系时，就会发生这种情况。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设数组已经初始化为1</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    factorial[i] = i * factorial[i<span class="number">-1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ERROR.</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp for</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>same as </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>


<h4 id="parallel-sections"><a href="#parallel-sections" class="headerlink" title="parallel sections"></a>parallel sections</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel sections # parallel </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> omp section # thread-1</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">function1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">　　<span class="meta">#<span class="keyword">pragma</span> omp section # thread-2</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">function2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>parallel sections里面的内容要并行执行，具体分工上，每个线程执行其中的一个section</p>
</blockquote>
<h3 id="clause"><a href="#clause" class="headerlink" title="clause"></a>clause</h3><ul>
<li><strong>private</strong>, 指定每个线程都有它自己的变量私有副本。</li>
<li>firstprivate，指定每个线程都有它自己的变量私有副本，并且变量要被继承主线程中的初值。</li>
<li>lastprivate，主要是用来指定将线程中的私有变量的值在并行处理结束后复制回主线程中的对应变量。</li>
<li><strong>reduce</strong>，用来指定一个或多个变量是私有的，并且在并行处理结束后这些变量要执行指定的运算。</li>
<li>nowait，忽略指定中暗含的等待</li>
<li><strong>num_threads</strong>，指定线程的个数</li>
<li><strong>schedule</strong>，指定如何调度for循环迭代</li>
<li>shared，指定一个或多个变量为多个线程间的共享变量</li>
<li>ordered，用来指定for循环的执行要按顺序执行</li>
<li>copyprivate，用于single指令中的指定变量为多个线程的共享变量</li>
<li>copyin，用来指定一个threadprivate的变量的值要用主线程的值进行初始化。</li>
<li>default，用来指定并行处理区域内的变量的使用方式，缺省是shared</li>
</ul>
<h4 id="private"><a href="#private" class="headerlink" title="private"></a>private</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x; <span class="comment">// private to each thread ? YES</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x; <span class="comment">// private to each thread ? YES</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>local variables are automatically private to each thread.<br>The reason for the existence of the <code>private</code> clause is so that you don’t have to change your code.<br>see <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6358375/openmp-are-local-variables-automatically-private">here</a></p>
</blockquote>
<p>The only way to parallelize the following code without the private clause</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i,j;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for private(j)</span></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>is to change the code. For example like this:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    <span class="type">int</span> j; <span class="comment">// mark j as local variable to worker thread</span></span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="reduction"><a href="#reduction" class="headerlink" title="reduction"></a>reduction</h4><p>例如累加</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    sum += array[i]; <span class="comment">// sum需要私有才能实现并行化，但是又必须是公有的才能产生正确结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的这个程序里，sum公有或者私有都不对，为了解决这个问题，OpenMP 提供了<code>reduction</code>语句；</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for reduction(+:sum)</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    sum += array[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>内部实现中，OpenMP为每个线程提供了私有的sum变量(初始化为0)，当线程退出时，OpenMP再把每个线程私有的sum加在一起得到最终结果。</p>
</blockquote>
<h4 id="num-threads"><a href="#num-threads" class="headerlink" title="num_threads"></a>num_threads</h4><p><code>num_threads(4)</code> same as <code>omp_set_num_threads(4)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `num_threads(4)` same as `omp_set_num_threads(4)`</span></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel num_threads(4)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Hello, I am Thread %d\n&quot;</span>, <span class="built_in">omp_get_thread_num</span>()); <span class="comment">// 0,1,2,3,</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="schedule"><a href="#schedule" class="headerlink" title="schedule"></a>schedule</h4><p>format</p>
<pre><code>#pragma omp parallel for schedule(kind [, chunk size])
</code></pre>
<p>kind: see <a target="_blank" rel="noopener" href="https://software.intel.com/en-us/articles/openmp-loop-scheduling">openmp-loop-scheduling</a> and <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10850155/whats-the-difference-between-static-and-dynamic-schedule-in-openmp">whats-the-difference-between-static-and-dynamic-schedule-in-openmp</a></p>
<ul>
<li><code>static</code>: Divide the loop into equal-sized chunks or as equal as possible in the case where the number of loop iterations is not evenly divisible by the number of threads multiplied by the chunk size. <code>By default, chunk size is loop_count/number_of_threads</code>.</li>
<li><code>dynamic</code>: Use the internal work queue to give a chunk-sized block of loop iterations to each thread. When a thread is finished, it retrieves the next block of loop iterations from the top of the work queue. <code>By default, the chunk size is 1</code>. Be careful when using this scheduling type because of the extra overhead involved.</li>
<li><code>guided</code>: special case of <code>dynamic</code>. Similar to dynamic scheduling, but the chunk size starts off large and decreases to better handle load imbalance between iterations. The optional chunk parameter specifies them minimum size chunk to use. <code>By default the chunk size is approximately loop_count/number_of_threads</code>.</li>
<li><code>auto</code>: When schedule (auto) is specified, the decision regarding <code>scheduling is delegated to the compiler</code>. The programmer gives the compiler the freedom to choose any possible mapping of iterations to threads in the team. </li>
<li><code>runtime</code>: with ENV<code>OMP_SCHEDULE</code>, we can test 3 types scheduling: <code>static,dynamic,guided</code> without recompile the code.</li>
</ul>
<blockquote>
<p>The optional parameter (chunk), when specified, must be a positive integer.</p>
</blockquote>
<p>默认情况下，OpenMP认为所有的循环迭代运行的时间都是一样的，这就导致了OpenMP会把不同的迭代等分到不同的核心上，并且让他们分布的尽可能减小内存访问冲突，这样做是因为循环一般会线性地访问内存, 所以把循环按照前一半后一半的方法分配可以最大程度的减少冲突. 然而对内存访问来说这可能是最好的方法, 但是对于负载均衡可能并不是最好的方法, 而且反过来最好的负载均衡可能也会破坏内存访问. 因此必须折衷考虑.</p>
<blockquote>
<p>内存访问vs负载均衡,需要折中考虑。<br>openmp默认使用的schedule是取决于编译器实现的。gcc默认使用schedule(dynamic,1)，也就是动态调度并且块大小是1.<br>线程数不要大于实际核数，否则就是oversubscription</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://software.intel.com/en-us/vtune-amplifier-cookbook-openmp-imbalance-and-scheduling-overhead">isprime</a>可以对dynamic做一个展示。</p>
<h3 id="functions"><a href="#functions" class="headerlink" title="functions"></a>functions</h3><ul>
<li><code>omp_get_num_procs</code>, 返回运行本线程的多处理机的处理器个数。</li>
<li><code>omp_set_num_threads</code>, 设置并行执行代码时的线程个数</li>
<li><code>omp_get_num_threads</code>, 返回当前并行区域中的活动线程(active thread)个数,如果没有设置，默认为1。</li>
<li><code>omp_get_thread_num</code>, 返回线程号(0,1,2,…)</li>
<li><code>omp_init_lock</code>, 初始化一个简单锁</li>
<li><code>omp_set_lock</code>， 上锁操作</li>
<li><code>omp_unset_lock</code>， 解锁操作，要和<code>omp_set_lock</code>函数配对使用</li>
<li><code>omp_destroy_lock</code>，关闭一个锁，要和 <code>omp_init_lock</code>函数配对使用</li>
</ul>
<p>check cpu</p>
<pre><code>cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c 
    8  Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz
</code></pre>
<blockquote>
<p><code>omp_get_num_procs</code> return <code>8</code>.</p>
</blockquote>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>



<h2 id="OpenMP-Example"><a href="#OpenMP-Example" class="headerlink" title="OpenMP Example"></a>OpenMP Example</h2><h3 id="omp-get-num-threads"><a href="#omp-get-num-threads" class="headerlink" title="omp_get_num_threads"></a>omp_get_num_threads</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;I am Thread %d,  omp_get_num_threads = %d, omp_get_num_procs = %d\n&quot;</span>, </span><br><span class="line">		<span class="built_in">omp_get_thread_num</span>(), </span><br><span class="line">		<span class="built_in">omp_get_num_threads</span>(),</span><br><span class="line">		<span class="built_in">omp_get_num_procs</span>()</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">I am Thread 0,  omp_get_num_threads = 1, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="parallel"><a href="#parallel" class="headerlink" title="parallel"></a>parallel</h3><h4 id="case1"><a href="#case1" class="headerlink" title="case1"></a>case1</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// `parallel`，用在一个代码段之前，表示这段代码block将被多个线程并行执行</span></span><br><span class="line">	<span class="comment">// if not set `omp_set_num_threads`, by default use `omp_get_num_procs`, eg 8</span></span><br><span class="line">	<span class="comment">//omp_set_num_threads(4); // 设置线程数，一般设置的线程数不超过CPU核心数</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Hello, I am Thread %d,  omp_get_num_threads = %d, omp_get_num_procs = %d\n&quot;</span>, </span><br><span class="line">			<span class="built_in">omp_get_thread_num</span>(), </span><br><span class="line">			<span class="built_in">omp_get_num_threads</span>(),</span><br><span class="line">			<span class="built_in">omp_get_num_procs</span>()</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Hello, I am Thread 3,  omp_get_num_threads = 8, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 7,  omp_get_num_threads = 8, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 1,  omp_get_num_threads = 8, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 6,  omp_get_num_threads = 8, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 5,  omp_get_num_threads = 8, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 4,  omp_get_num_threads = 8, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 2,  omp_get_num_threads = 8, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 0,  omp_get_num_threads = 8, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="case2"><a href="#case2" class="headerlink" title="case2"></a>case2</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1_2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// `parallel`，用在一个代码段之前，表示这段代码block将被多个线程并行执行</span></span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>); <span class="comment">// 设置线程数，一般设置的线程数不超过CPU核心数</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Hello, I am Thread %d,  omp_get_num_threads = %d, omp_get_num_procs = %d\n&quot;</span>, </span><br><span class="line">			<span class="built_in">omp_get_thread_num</span>(), </span><br><span class="line">			<span class="built_in">omp_get_num_threads</span>(),</span><br><span class="line">			<span class="built_in">omp_get_num_procs</span>()</span><br><span class="line">		);</span><br><span class="line">		<span class="comment">//std::cout &lt;&lt; &quot;Hello&quot; &lt;&lt; &quot;, I am Thread &quot; &lt;&lt; omp_get_thread_num() &lt;&lt; std::endl; // 0,1,2,3</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># use `cout`</span></span><br><span class="line"><span class="comment">HelloHello, I am Thread Hello, I am Thread , I am Thread Hello, I am Thread 2</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* use `printf`</span></span><br><span class="line"><span class="comment">Hello, I am Thread 0,  omp_get_num_threads = 4, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 3,  omp_get_num_threads = 4, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 1,  omp_get_num_threads = 4, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">Hello, I am Thread 2,  omp_get_num_threads = 4, omp_get_num_procs = 8</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>notice the difference of <code>std::cout</code> and <code>printf</code></p>
</blockquote>
<h4 id="case3"><a href="#case3" class="headerlink" title="case3"></a>case3</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1_3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// `parallel`，用在一个代码段之前，表示这段代码block将被多个线程并行执行</span></span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 0</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="omp-parallel-for"><a href="#omp-parallel-for" class="headerlink" title="omp parallel&#x2F;for"></a>omp parallel&#x2F;for</h3><h4 id="omp-parallel-omp-for"><a href="#omp-parallel-omp-for" class="headerlink" title="omp parallel + omp for"></a>omp parallel + omp for</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// `omp parallel` + `omp for` === `omp parallel for`</span></span><br><span class="line">	<span class="comment">// `omp for` 用在一个for循环之前，表示for循环的每一次iteration将被分配到多个线程并行执行。</span></span><br><span class="line">	<span class="comment">// 此处8次iteration被平均分配到4个thread执行，每个thread执行2次iteration</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	iter   #thread id</span></span><br><span class="line"><span class="comment">	0,1     0</span></span><br><span class="line"><span class="comment">	2,3     1</span></span><br><span class="line"><span class="comment">	4,5     2</span></span><br><span class="line"><span class="comment">	6,7     3</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp for</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 3, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 6, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 7, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 4, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 5, I am Thread 2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h4 id="omp-parallel-for-1"><a href="#omp-parallel-for-1" class="headerlink" title="omp parallel for"></a>omp parallel for</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2_2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// `parallel for`，用在一个for循环之前，表示for循环的每一次iteration将被分配到多个线程并行执行。</span></span><br><span class="line">	<span class="comment">// 此处8次iteration被平均分配到4个thread执行，每个thread执行2次iteration</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	iter   #thread id</span></span><br><span class="line"><span class="comment">	0,1     0</span></span><br><span class="line"><span class="comment">	2,3     1</span></span><br><span class="line"><span class="comment">	4,5     2</span></span><br><span class="line"><span class="comment">	6,7     3</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 4, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 5, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 6, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 7, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 3, I am Thread 1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="sqrt-case"><a href="#sqrt-case" class="headerlink" title="sqrt case"></a>sqrt case</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">base_sqrt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	boost::posix_time::ptime pt1 = boost::posix_time::microsec_clock::<span class="built_in">local_time</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000000000</span>;i++)</span><br><span class="line">        a = <span class="built_in">sqrt</span>(i);</span><br><span class="line">	</span><br><span class="line">	boost::posix_time::ptime pt2 = boost::posix_time::microsec_clock::<span class="built_in">local_time</span>();</span><br><span class="line">	<span class="type">int64_t</span> cost = (pt2 - pt1).<span class="built_in">total_milliseconds</span>();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Worker Thread = %d, cost = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), cost);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2_3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	boost::posix_time::ptime pt1 = boost::posix_time::microsec_clock::<span class="built_in">local_time</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">8</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">        <span class="built_in">base_sqrt</span>();</span><br><span class="line">    </span><br><span class="line">	boost::posix_time::ptime pt2 = boost::posix_time::microsec_clock::<span class="built_in">local_time</span>();</span><br><span class="line">	<span class="type">int64_t</span> cost = (pt2 - pt1).<span class="built_in">total_milliseconds</span>();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Main Thread = %d, cost = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), cost);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sequential</p>
<pre><code>time ./demo_openmp
Worker Thread = 0, cost = 1746 ms
Worker Thread = 0, cost = 1711 ms
Worker Thread = 0, cost = 1736 ms
Worker Thread = 0, cost = 1734 ms
Worker Thread = 0, cost = 1750 ms
Worker Thread = 0, cost = 1718 ms
Worker Thread = 0, cost = 1769 ms
Worker Thread = 0, cost = 1732 ms
Main Thread = 0, cost = 13899 ms
./demo_openmp  13.90s user 0.00s system 99% cpu 13.903 total
</code></pre>
<p>parallel </p>
<pre><code>time ./demo_openmp
Worker Thread = 1, cost = 1875 ms
Worker Thread = 6, cost = 1876 ms
Worker Thread = 0, cost = 1876 ms
Worker Thread = 7, cost = 1876 ms
Worker Thread = 5, cost = 1877 ms
Worker Thread = 3, cost = 1963 ms
Worker Thread = 4, cost = 2000 ms
Worker Thread = 2, cost = 2027 ms
Main Thread = 0, cost = 2031 ms
./demo_openmp  15.10s user 0.01s system 740% cpu 2.041 total
</code></pre>
<blockquote>
<p>2031s + 10ms(system) &#x3D; 2041ms (total)<br>2.041* 740% &#x3D; 15.1034 s</p>
</blockquote>
<h3 id="parallel-sections-1"><a href="#parallel-sections-1" class="headerlink" title="parallel sections"></a>parallel sections</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	boost::posix_time::ptime pt1 = boost::posix_time::microsec_clock::<span class="built_in">local_time</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line">	<span class="comment">// `parallel sections`里面的内容要并行执行，具体分工上，每个线程执行其中的一个`section`</span></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel sections <span class="comment">// parallel </span></span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp section <span class="comment">// thread-0</span></span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">base_sqrt</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp section <span class="comment">// thread-1</span></span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">base_sqrt</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp section <span class="comment">// thread-2</span></span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">base_sqrt</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp section <span class="comment">// thread-3</span></span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">base_sqrt</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	boost::posix_time::ptime pt2 = boost::posix_time::microsec_clock::<span class="built_in">local_time</span>();</span><br><span class="line">	<span class="type">int64_t</span> cost = (pt2 - pt1).<span class="built_in">total_milliseconds</span>();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Main Thread = %d, cost = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), cost);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">time ./demo_openmp</span></span><br><span class="line"><span class="comment">Worker Thread = 0, cost = 1843 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, cost = 1843 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, cost = 1844 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, cost = 1845 ms</span></span><br><span class="line"><span class="comment">Main Thread = 0, cost = 1845 ms</span></span><br><span class="line"><span class="comment">./demo_openmp  7.39s user 0.00s system 398% cpu 1.855 total</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="private-1"><a href="#private-1" class="headerlink" title="private"></a>private</h3><h4 id="error-case"><a href="#error-case" class="headerlink" title="error case"></a>error case</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4_error</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i,j;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line">	<span class="comment">// we get error result, because `j` is shared between all worker threads.</span></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Worker Thread = %d, j = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), j);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 3 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 7 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 0 ms</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>error results.</p>
</blockquote>
<h4 id="fix1-by-changing-code"><a href="#fix1-by-changing-code" class="headerlink" title="fix1 by changing code"></a>fix1 by changing code</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4_fix1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line">	<span class="comment">// we get error result, because `j` is shared between all worker threads.</span></span><br><span class="line">	<span class="comment">// fix1: we have to change original code to make j as local variable</span></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel for</span></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">		<span class="type">int</span> j;  <span class="comment">// fix1: `int j`</span></span><br><span class="line">		<span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123; </span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Worker Thread = %d, j = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), j);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 3 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 7 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 3 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 7 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 3 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 7 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 3 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 7 ms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="fix2-by-private-j"><a href="#fix2-by-private-j" class="headerlink" title="fix2 by private(j)"></a>fix2 by private(j)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4_fix2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i,j;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line">	<span class="comment">// we get error result, because `j` is shared between all worker threads.</span></span><br><span class="line">	<span class="comment">// fix1: we have to change original code to make j as local variable</span></span><br><span class="line">	<span class="comment">// fix2: use `private(j)`, no need to change original code</span></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel for private(j) <span class="comment">// fix2</span></span></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Worker Thread = %d, j = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), j);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 3 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, j = 7 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 3 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, j = 7 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 3 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 3 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, j = 7 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, j = 7 ms</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="reduction-1"><a href="#reduction-1" class="headerlink" title="reduction"></a>reduction</h3><h4 id="error-case-1"><a href="#error-case-1" class="headerlink" title="error case"></a>error case</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test5_error</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> array[<span class="number">8</span>] = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line"><span class="comment">//#pragma omp parallel for reduction(+:sum)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for  <span class="comment">// ERROR</span></span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">		sum += array[i];</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Worker Thread = %d, sum = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), sum);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Main Thread = %d, sum = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), sum);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// ERROR RESULT</span></span><br><span class="line"><span class="comment">Worker Thread = 0, sum = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, sum = 9 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, sum = 8 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, sum = 16 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, sum = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, sum = 19 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, sum = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, sum = 24 ms</span></span><br><span class="line"><span class="comment">Main Thread = 0, sum = 24 ms</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="reduction-sum"><a href="#reduction-sum" class="headerlink" title="reduction(+:sum)"></a>reduction(+:sum)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test5_fix</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> array[<span class="number">8</span>] = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	sum需要私有才能实现并行化，但是又必须是公有的才能产生正确结果;</span></span><br><span class="line"><span class="comment">	sum公有或者私有都不对，为了解决这个问题，OpenMP提供了reduction语句.</span></span><br><span class="line"><span class="comment">	内部实现中，OpenMP为每个线程提供了私有的sum变量(初始化为0)，</span></span><br><span class="line"><span class="comment">	当线程退出时，OpenMP再把每个线程私有的sum加在一起得到最终结果。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for reduction(+:sum)</span></span><br><span class="line"><span class="comment">//#pragma omp parallel for  // ERROR</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">		sum += array[i];</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Worker Thread = %d, sum = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), sum);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Main Thread = %d, sum = %d ms\n&quot;</span>,<span class="built_in">omp_get_thread_num</span>(), sum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Worker Thread = 0, sum = 0 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 0, sum = 1 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, sum = 2 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 1, sum = 5 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, sum = 6 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 3, sum = 13 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, sum = 4 ms</span></span><br><span class="line"><span class="comment">Worker Thread = 2, sum = 9 ms</span></span><br><span class="line"><span class="comment">Main Thread = 0, sum = 28 ms</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="num-threads-1"><a href="#num-threads-1" class="headerlink" title="num_threads"></a>num_threads</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test6</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// `num_threads(4)` same as `omp_set_num_threads(4)`</span></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel num_threads(4)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Hello, I am Thread %d\n&quot;</span>, <span class="built_in">omp_get_thread_num</span>()); <span class="comment">// 0,1,2,3,</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Hello, I am Thread 0</span></span><br><span class="line"><span class="comment">Hello, I am Thread 2</span></span><br><span class="line"><span class="comment">Hello, I am Thread 3</span></span><br><span class="line"><span class="comment">Hello, I am Thread 1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="schedule-1"><a href="#schedule-1" class="headerlink" title="schedule"></a>schedule</h3><h4 id="static-2"><a href="#static-2" class="headerlink" title="(static,2)"></a>(static,2)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test7_1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line">	<span class="comment">// static, num_loop/num_threads</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for schedule(static,2) </span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 3, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 6, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 7, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 4, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 5, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="static-4"><a href="#static-4" class="headerlink" title="(static,4)"></a>(static,4)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test7_2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line">	<span class="comment">// static, num_loop/num_threads</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for schedule(static,4) </span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 3, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 4, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 5, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 6, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 7, I am Thread 1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="dynamic-1"><a href="#dynamic-1" class="headerlink" title="(dynamic,1)"></a>(dynamic,1)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test7_3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line">	<span class="comment">// dynamic</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for schedule(dynamic,1) </span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 4, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 5, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 6, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 7, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 3, I am Thread 3</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="dynamic-3"><a href="#dynamic-3" class="headerlink" title="(dynamic,3)"></a>(dynamic,3)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test7_4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(<span class="number">4</span>);</span><br><span class="line">	<span class="comment">// dynamic</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for schedule(dynamic,3) </span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;i = %d, I am Thread %d\n&quot;</span>, i, <span class="built_in">omp_get_thread_num</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">i = 0, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 1, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 2, I am Thread 0</span></span><br><span class="line"><span class="comment">i = 6, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 7, I am Thread 2</span></span><br><span class="line"><span class="comment">i = 3, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 4, I am Thread 1</span></span><br><span class="line"><span class="comment">i = 5, I am Thread 1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="schedule-compare"><a href="#schedule-compare" class="headerlink" title="schedule compare"></a>schedule compare</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NUM 100000000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">isprime</span><span class="params">( <span class="type">int</span> x )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> y = <span class="number">2</span>; y * y &lt;= x; y++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>( x % y == <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test8</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel for reduction (+:sum) schedule(dynamic,1) </span></span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> i = <span class="number">2</span>; i &lt;= NUM ; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        sum += <span class="built_in">isprime</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;Number of primes numbers: %d&quot;</span>, sum );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="no-schedule"><a href="#no-schedule" class="headerlink" title="no schedule"></a>no schedule</h4><pre><code>Number of primes numbers: 5761455./demo_openmp  151.64s user 0.04s system 582% cpu 26.048 total
</code></pre>
<h4 id="schedule-static-1"><a href="#schedule-static-1" class="headerlink" title="schedule(static,1)"></a>schedule(static,1)</h4><pre><code>Number of primes numbers: 5761455./demo_openmp  111.13s user 0.00s system 399% cpu 27.799 total
</code></pre>
<h4 id="schedule-dynamic-1"><a href="#schedule-dynamic-1" class="headerlink" title="schedule(dynamic,1)"></a>schedule(dynamic,1)</h4><pre><code>Number of primes numbers: 5761455./demo_openmp  167.22s user 0.02s system 791% cpu 21.135 total
</code></pre>
<h4 id="schedule-dynamic-200"><a href="#schedule-dynamic-200" class="headerlink" title="schedule(dynamic,200)"></a>schedule(dynamic,200)</h4><pre><code>Number of primes numbers: 5761455./demo_openmp  165.96s user 0.02s system 791% cpu 20.981 total
</code></pre>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>




<h2 id="OpenCV-with-OpenMP"><a href="#OpenCV-with-OpenMP" class="headerlink" title="OpenCV with OpenMP"></a>OpenCV with OpenMP</h2><p>see <a target="_blank" rel="noopener" href="http://answers.opencv.org/question/103701/how-opencv-use-openmp-thread-to-get-performance/">how-opencv-use-openmp-thread-to-get-performance</a></p>
<p>3 type OpenCV implementation</p>
<ul>
<li>sequential implementation: default (slowest)</li>
<li>parallel implementation: OpenMP &#x2F; TBB</li>
<li>GPU implementation: CUDA(fastest) &#x2F; OpenCL</li>
</ul>
<blockquote>
<p>With CMake-gui, Building <code>OpenCV</code> with the <code>WITH_OPENMP</code> flag means that the internal functions will use <code>OpenMP</code> to parallelize some of the algorithms, like <code>cvCanny</code>, <code>cvSmooth</code> and <code>cvThreshold</code>.</p>
</blockquote>
<blockquote>
<p>In OpenCV, an algorithm can have a <code>sequential (slowest) implementation</code>; a <code>parallel implementation</code> using <code>OpenMP</code> or <code>TBB</code>; and a <code>GPU implementation</code> using <code>OpenCL</code> or <code>CUDA</code>(fastest). You can decide with the <code>WITH_XXX</code> flags which version to use.</p>
</blockquote>
<blockquote>
<p>Of course, not every algorithm can be parallelized.</p>
</blockquote>
<blockquote>
<p>Now, if you want to parallelize your methods with OpenMP, you have to implement it yourself.</p>
</blockquote>
<h3 id="concepts"><a href="#concepts" class="headerlink" title="concepts"></a>concepts</h3><p><code>avoiding extra copying</code></p>
<p>from <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9039449/improving-image-processing-speed?r=SearchResults">improving-image-processing-speed</a></p>
<blockquote>
<p>There is one important thing about increasing speed in OpenCV not related to processor nor algorithm and it is <strong>avoiding extra copying</strong> when dealing with matrices. I will give you an example taken from the documentation:</p>
</blockquote>
<blockquote>
<p>“…by constructing a header for a part of another matrix. It can be a single row, single column, several rows, several columns, rectangular region in the matrix (called a minor in algebra) or a diagonal. Such operations are also O(1), because the new header will reference the same data. You can actually modify a part of the matrix using this feature, e.g.”</p>
</blockquote>
<h3 id="parallel-for-1"><a href="#parallel-for-1" class="headerlink" title="parallel for"></a>parallel for</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;opencv2/highgui/highgui.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;opencv2/features2d/features2d.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">opencv_vector</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> imNum = <span class="number">2</span>;</span><br><span class="line">    <span class="function">std::vector&lt;cv::Mat&gt; <span class="title">imVec</span><span class="params">(imNum)</span></span>;</span><br><span class="line">    std::vector&lt;std::vector&lt;cv::KeyPoint&gt;&gt;<span class="built_in">keypointVec</span>(imNum);</span><br><span class="line">    <span class="function">std::vector&lt;cv::Mat&gt; <span class="title">descriptorsVec</span><span class="params">(imNum)</span></span>;</span><br><span class="line">	</span><br><span class="line">	cv::Ptr&lt;cv::ORB&gt; detector = cv::ORB::<span class="built_in">create</span>();</span><br><span class="line">	cv::Ptr&lt;DescriptorMatcher&gt; matcher = cv::DescriptorMatcher::<span class="built_in">create</span>(<span class="string">&quot;BruteForce-Hamming&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::vector&lt; cv::DMatch &gt; matches;</span><br><span class="line">    <span class="type">char</span> filename[<span class="number">100</span>];</span><br><span class="line">    <span class="type">double</span> t1 = <span class="built_in">omp_get_wtime</span>();</span><br><span class="line">    </span><br><span class="line"><span class="comment">//#pragma omp parallel for</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;imNum;i++)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(filename,<span class="string">&quot;rgb%d.jpg&quot;</span>,i);</span><br><span class="line">        imVec[i] = cv::<span class="built_in">imread</span>( filename, CV_LOAD_IMAGE_GRAYSCALE );</span><br><span class="line">        detector-&gt;<span class="built_in">detect</span>( imVec[i], keypointVec[i] );</span><br><span class="line">        detector-&gt;<span class="built_in">compute</span>( imVec[i],keypointVec[i],descriptorsVec[i]);</span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;find &quot;</span>&lt;&lt;keypointVec[i].<span class="built_in">size</span>()&lt;&lt;<span class="string">&quot; keypoints in im&quot;</span>&lt;&lt;i&lt;&lt;std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">double</span> t2 = <span class="built_in">omp_get_wtime</span>();</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;time: &quot;</span>&lt;&lt;t2-t1&lt;&lt;std::endl;</span><br><span class="line">	</span><br><span class="line">	matcher-&gt;<span class="built_in">match</span>(descriptorsVec[<span class="number">0</span>], descriptorsVec[<span class="number">1</span>], matches, <span class="number">2</span>); <span class="comment">// uchar descriptor Mat</span></span><br><span class="line"></span><br><span class="line">    cv::Mat img_matches;</span><br><span class="line">    cv::<span class="built_in">drawMatches</span>( imVec[<span class="number">0</span>], keypointVec[<span class="number">0</span>], imVec[<span class="number">1</span>], keypointVec[<span class="number">1</span>], matches, img_matches ); </span><br><span class="line">    cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;Matches&quot;</span>,CV_WINDOW_AUTOSIZE);</span><br><span class="line">    cv::<span class="built_in">imshow</span>( <span class="string">&quot;Matches&quot;</span>, img_matches );</span><br><span class="line">    cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="parallel-sections-2"><a href="#parallel-sections-2" class="headerlink" title="parallel sections"></a>parallel sections</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel sections</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp section</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cout&lt;&lt;<span class="string">&quot;processing im0&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">            im0 = cv::<span class="built_in">imread</span>(<span class="string">&quot;rgb0.jpg&quot;</span>, CV_LOAD_IMAGE_GRAYSCALE );</span><br><span class="line">            detector.<span class="built_in">detect</span>( im0, keypoints0);</span><br><span class="line">            extractor.<span class="built_in">compute</span>( im0,keypoints0,descriptors0);</span><br><span class="line">            std::cout&lt;&lt;<span class="string">&quot;find &quot;</span>&lt;&lt;keypoints<span class="number">0.</span><span class="built_in">size</span>()&lt;&lt;<span class="string">&quot;keypoints in im0&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp section</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cout&lt;&lt;<span class="string">&quot;processing im1&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">            im1 = cv::<span class="built_in">imread</span>(<span class="string">&quot;rgb1.jpg&quot;</span>, CV_LOAD_IMAGE_GRAYSCALE );</span><br><span class="line">            detector.<span class="built_in">detect</span>( im1, keypoints1);</span><br><span class="line">            extractor.<span class="built_in">compute</span>( im1,keypoints1,descriptors1);</span><br><span class="line">            std::cout&lt;&lt;<span class="string">&quot;find &quot;</span>&lt;&lt;keypoints<span class="number">1.</span><span class="built_in">size</span>()&lt;&lt;<span class="string">&quot;keypoints in im1&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/baimafujinji/article/details/52444739">openmp</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/baimafujinji/article/details/52769930">openmp + MPI</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ospider/p/5265975.html">openmp</a></li>
<li><a target="_blank" rel="noopener" href="http://answers.opencv.org/question/103701/how-opencv-use-openmp-thread-to-get-performance/">how-opencv-use-openmp-thread-to-get-performance</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangzhebupt/article/details/22743515">csdn opencv with openmp for+section </a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/51173703">openmp functions</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9039449/improving-image-processing-speed?r=SearchResults">improving-image-processing-speed</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6358375/openmp-are-local-variables-automatically-private">openmp-are-local-variables-automatically-private</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10850155/whats-the-difference-between-static-and-dynamic-schedule-in-openmp">whats-the-difference-between-static-and-dynamic-schedule-in-openmp</a></li>
<li><a target="_blank" rel="noopener" href="https://software.intel.com/en-us/vtune-amplifier-cookbook-openmp-imbalance-and-scheduling-overhead">dynamic openmp with isprime</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190403: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/nvidia-management-library-nvml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/nvidia-management-library-nvml/" class="post-title-link" itemprop="url">install and use nvidia management library (nvml)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-21 09:35:00" itemprop="dateCreated datePublished" datetime="2019-03-21T09:35:00+08:00">2019-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="nvidia-smi"><a href="#nvidia-smi" class="headerlink" title="nvidia-smi"></a>nvidia-smi</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; nvidia-smi</span><br><span class="line">Thu Mar 21 09:41:18 2019       </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 396.54                 Driver Version: 396.54                    |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  GeForce GTX 1060    Off  | 00000000:01:00.0 Off |                  N/A |</span><br><span class="line">| N/A   65C    P0    30W /  N/A |    538MiB /  6078MiB |      0%      Default |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br></pre></td></tr></table></figure>

<h3 id="nvidia-ml-py"><a href="#nvidia-ml-py" class="headerlink" title="nvidia-ml-py"></a>nvidia-ml-py</h3><p>This is a wrapper around the NVML library.</p>
<p>Python methods wrap NVML functions, implemented in a C shared library.</p>
<blockquote>
<p>Each function’s use is the same with the following exceptions: Instead of returning error codes, failing error codes are raised as Python exceptions.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install nvidia-ml-py2 --user</span><br><span class="line">pip install nvidia-ml-py3 --user</span><br></pre></td></tr></table></figure>

<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># pip install nvidia-ml-py3 --user</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pynvml</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    pynvml.nvmlInit()</span><br><span class="line"><span class="keyword">except</span> pynvml.NVMLError <span class="keyword">as</span> error:</span><br><span class="line">    <span class="built_in">print</span>(error) </span><br><span class="line">    <span class="comment"># Driver Not Loaded      驱动加载失败(没装驱动或者驱动有问题)</span></span><br><span class="line">    <span class="comment"># Insufficent Permission 没有以管理员权限运行  pynvml.NVMLError_DriverNotLoaded: Driver Not Loaded</span></span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(pynvml.nvmlDeviceGetCount())</span><br><span class="line"><span class="keyword">except</span> pynvml.NVMLError <span class="keyword">as</span> error:</span><br><span class="line">    <span class="built_in">print</span>(error)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(pynvml.nvmlDeviceGetCount())<span class="comment"># total gpu count = 1</span></span><br><span class="line"><span class="built_in">print</span>(pynvml.nvmlSystemGetDriverVersion()) <span class="comment"># 396.54</span></span><br><span class="line"></span><br><span class="line">GPU_ID = <span class="number">0</span></span><br><span class="line">handle = pynvml.nvmlDeviceGetHandleByIndex(GPU_ID)</span><br><span class="line"><span class="built_in">print</span>(pynvml.nvmlDeviceGetName(handle)) <span class="comment"># GeForce GTX 1060</span></span><br><span class="line"></span><br><span class="line">meminfo = pynvml.nvmlDeviceGetMemoryInfo(handle)</span><br><span class="line">MB_SIZE = <span class="number">1024</span>*<span class="number">1024</span></span><br><span class="line"><span class="built_in">print</span>(meminfo.total/MB_SIZE) <span class="comment"># 6078 MB</span></span><br><span class="line"><span class="built_in">print</span>(meminfo.used/MB_SIZE)  <span class="comment"># 531 MB</span></span><br><span class="line"><span class="built_in">print</span>(meminfo.free/MB_SIZE)  <span class="comment"># 5546 MB</span></span><br><span class="line"></span><br><span class="line">pynvml.nvmlShutdown()</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.nvidia.com/nvidia-management-library-nvml">nvml</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.nvidia.com/deploy/nvml-api/index.html">nvml-api</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.org/project/nvidia-ml-py/">nvidia-ml-py</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190321: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/mean-shift-clustering/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/mean-shift-clustering/" class="post-title-link" itemprop="url">mean shift clustering</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-18 14:44:00" itemprop="dateCreated datePublished" datetime="2019-03-18T14:44:00+08:00">2019-03-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="MeanShift"><a href="#MeanShift" class="headerlink" title="MeanShift"></a>MeanShift</h3><ul>
<li>python:	<code>git clone https://github.com/mattnedrich/MeanShift_py.git</code></li>
<li>cpp:  <code>git https://github.com/mattnedrich/MeanShift_cpp.git</code></li>
</ul>
<p>cpp compile </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> MeanShfit_cpp </span><br><span class="line"><span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; cmake .. &amp;&amp; make -j8</span><br><span class="line"></span><br><span class="line">./MeanShift_cpp </span><br></pre></td></tr></table></figure>

<h4 id="Visualization-for-linux"><a href="#Visualization-for-linux" class="headerlink" title="Visualization for linux"></a>Visualization for linux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install gnuplot gnuplot-qt</span><br></pre></td></tr></table></figure>

<blockquote>
<p>gnuplot<br>plot ‘test.csv’ with points, ‘result.csv’ with points</p>
</blockquote>
<h3 id="python-demo"><a href="#python-demo" class="headerlink" title="python demo"></a>python demo</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mean_shift <span class="keyword">as</span> ms</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ms_cluster</span>(<span class="params">data</span>):</span><br><span class="line">        <span class="comment"># case(1) demo:     kernel_bandwidth = 3.0, cluster_epsilon = 6</span></span><br><span class="line">        <span class="comment"># case(2) laneseg:  kernel_bandwidth = 0.5, cluster_epsilon = 2</span></span><br><span class="line">        mean_shifter = ms.MeanShift()</span><br><span class="line">        mean_shift_result = mean_shifter.cluster(data, kernel_bandwidth = <span class="number">3</span>, cluster_epsilon= <span class="number">6</span>)</span><br><span class="line">        <span class="keyword">return</span> mean_shift_result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sklearn_cluster</span>(<span class="params">data</span>):</span><br><span class="line">        <span class="keyword">from</span> sklearn.cluster <span class="keyword">import</span> MeanShift</span><br><span class="line">        <span class="keyword">from</span> sklearn.cluster <span class="keyword">import</span> estimate_bandwidth</span><br><span class="line"></span><br><span class="line">        bandwidth = estimate_bandwidth(data, quantile=<span class="number">0.2</span>, n_samples=data.shape[<span class="number">0</span>])</span><br><span class="line">        <span class="comment">#print(&quot;bandwidth=&quot;,bandwidth) # 3</span></span><br><span class="line">        mean_shifter = MeanShift(bandwidth, bin_seeding=<span class="literal">True</span>)</span><br><span class="line">        mean_shifter.fit(data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get same results</span></span><br><span class="line">        original_points = data</span><br><span class="line">        cluster_centers = mean_shifter.cluster_centers_</span><br><span class="line">        cluster_ids = mean_shifter.labels_</span><br><span class="line"></span><br><span class="line">        mean_shift_result = ms.MeanShiftResult(original_points, cluster_centers, cluster_ids)</span><br><span class="line">        <span class="keyword">return</span> mean_shift_result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cluster_api</span>(<span class="params">data, use_sklearn=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="keyword">if</span> use_sklearn:</span><br><span class="line">                <span class="keyword">return</span> sklearn_cluster(data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> ms_cluster(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_cluster_result</span>(<span class="params">mean_shift_result</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Original Point     Shifted Point  Cluster ID&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;============================================&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(mean_shift_result.original_points)): <span class="comment"># 125</span></span><br><span class="line">                original_point = mean_shift_result.original_points[i] <span class="comment"># 125</span></span><br><span class="line">                cluster_id = mean_shift_result.cluster_ids[i] <span class="comment"># 125  value=0,1,2</span></span><br><span class="line">                cluster_center = mean_shift_result.cluster_centers[cluster_id] <span class="comment"># 3   </span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>( </span><br><span class="line">                        <span class="string">&quot;(%5.2f,%5.2f) -&gt;  (%5.2f,%5.2f) cluster %i&quot;</span> % </span><br><span class="line">                        (original_point[<span class="number">0</span>], original_point[<span class="number">1</span>], </span><br><span class="line">                        cluster_center[<span class="number">0</span>], cluster_center[<span class="number">1</span>], </span><br><span class="line">                        cluster_id)</span><br><span class="line">                ) </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;============================================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">        use_sklearn = <span class="literal">True</span></span><br><span class="line">        data = np.genfromtxt(<span class="string">&#x27;data.csv&#x27;</span>, delimiter=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;data.shape=&quot;</span>,data.shape)</span><br><span class="line"></span><br><span class="line">        mean_shift_result = cluster_api(data,use_sklearn)</span><br><span class="line">        <span class="comment">#print_cluster_result(mean_shift_result)</span></span><br><span class="line"></span><br><span class="line">        original_points =  mean_shift_result.original_points <span class="comment"># (125, 2)</span></span><br><span class="line">        cluster_centers = mean_shift_result.cluster_centers  <span class="comment"># (3, 2)</span></span><br><span class="line">        cluster_ids = mean_shift_result.cluster_ids <span class="comment"># (125,)   value=[0,1,2]</span></span><br><span class="line"></span><br><span class="line">        unique_ids = np.unique(cluster_ids) <span class="comment"># (3,)  value=[0,1,2]</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;original_points.shape=&quot;</span>,original_points.shape) <span class="comment"># (125, 2)</span></span><br><span class="line">        <span class="built_in">print</span>(original_points[:<span class="number">10</span>])</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;cluster_centers.shape=&quot;</span>,cluster_centers.shape) <span class="comment"># (3, 2)</span></span><br><span class="line">        <span class="built_in">print</span>(cluster_centers)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;cluster_ids.shape=&quot;</span>,cluster_ids.shape) <span class="comment"># (125,)</span></span><br><span class="line">        <span class="built_in">print</span>(cluster_ids) <span class="comment"># [0,0,0,...1,1,1,...,2,2,2,...] 0,1,2 cluster ids</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;unique_ids.shape=&quot;</span>,unique_ids.shape) <span class="comment"># (3,)</span></span><br><span class="line">        <span class="built_in">print</span>(unique_ids)  <span class="comment"># 0,1,2</span></span><br><span class="line"></span><br><span class="line">        x = original_points[:,<span class="number">0</span>]</span><br><span class="line">        y = original_points[:,<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        fig = plt.figure()</span><br><span class="line">        ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">        scatter = ax.scatter(x,y,c=cluster_ids,s=<span class="number">50</span>)</span><br><span class="line">        <span class="keyword">for</span> cx,cy <span class="keyword">in</span> cluster_centers:</span><br><span class="line">                ax.scatter(cx,cy,s=<span class="number">50</span>,c=<span class="string">&#x27;red&#x27;</span>,marker=<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">                ax.set_xlabel(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">                ax.set_ylabel(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">                plt.colorbar(scatter)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> use_sklearn:</span><br><span class="line">                filename = <span class="string">&quot;1_sklearn&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">                filename = <span class="string">&quot;2_ms&quot;</span></span><br><span class="line"></span><br><span class="line">        fig.savefig(filename)</span><br><span class="line">        plt.show()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;OK &quot;</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">        main()</span><br></pre></td></tr></table></figure>

<h4 id="meanshift-py"><a href="#meanshift-py" class="headerlink" title="meanshift_py"></a>meanshift_py</h4><pre><code>#===============================
# ms 
#===============================
(&#39;data.shape=&#39;, (125, 2))
(&#39;original_points.shape=&#39;, (125, 2))
[[10.91079039  8.38941202]
 [ 9.87500165  9.9092509 ]
 [ 7.8481223  10.4317483 ]
 [ 8.53412293  9.55908561]
 [10.38316846  9.61879086]
 [ 8.11061595  9.77471761]
 [10.02119468  9.53877962]
 [ 9.37705852  9.70853991]
 [ 7.67017034  9.60315231]
 [10.94308287 11.76207349]]
(&#39;cluster_centers.shape=&#39;, (3, 2))
[[-3.45216026  5.28851174]
 [ 5.02926925  3.56548696]
 [ 8.63149568  9.25488818]]
(&#39;cluster_ids.shape=&#39;, (125,))
[2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
 0 0 0 0 0 0 0 0 0 0 1 0 0 0]
(&#39;unique_ids.shape=&#39;, (3,))
[0 1 2]
OK 2_ms
</code></pre>
<p><img src="https://kezunlin.me/images/posts/635233-20190419173554794-823758488.png" alt="ms"></p>
<h4 id="sklearn"><a href="#sklearn" class="headerlink" title="sklearn"></a>sklearn</h4><pre><code>#===============================
# sklearn 
#===============================

(&#39;data.shape=&#39;, (125, 2))
(&#39;original_points.shape=&#39;, (125, 2))
[[10.91079039  8.38941202]
 [ 9.87500165  9.9092509 ]
 [ 7.8481223  10.4317483 ]
 [ 8.53412293  9.55908561]
 [10.38316846  9.61879086]
 [ 8.11061595  9.77471761]
 [10.02119468  9.53877962]
 [ 9.37705852  9.70853991]
 [ 7.67017034  9.60315231]
 [10.94308287 11.76207349]]
(&#39;cluster_centers.shape=&#39;, (3, 2))
[[ 4.79792283  3.01140269]
 [ 9.2548292  10.11312163]
 [-4.11368202  5.44826076]]
(&#39;cluster_ids.shape=&#39;, (125,))
[1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
 2 2 2 2 2 2 2 2 2 2 0 2 2 2]
(&#39;unique_ids.shape=&#39;, (3,))
[0 1 2]
OK 1_sklearn
</code></pre>
<p><img src="https://kezunlin.me/images/posts/635233-20190419173551648-1533882819.png" alt="sklearn"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mattnedrich/MeanShift_py">MeanShift_py</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mattnedrich/MeanShift_cpp">MeanShift_cpp</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/google19890102/article/details/51030884">mean shift clustering intro</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/lwx309025167/article/details/78434930">opencv mean shift</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20190318: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kezunlin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">181</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">213</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kezunlin</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
