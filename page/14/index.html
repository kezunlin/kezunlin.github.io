<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kezunlin.me","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Kezunlin&#39;s Blog">
<meta property="og:url" content="https://kezunlin.me/page/14/index.html">
<meta property="og:site_name" content="Kezunlin&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="kezunlin">
<meta property="article:tag" content="linux, c++, python, AI, LLM">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://kezunlin.me/page/14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Kezunlin's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Kezunlin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Kezunlin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Live and Learn</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/Example-1-theano-linear-regression-with-gradient-descent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/Example-1-theano-linear-regression-with-gradient-descent/" class="post-title-link" itemprop="url">Example 1-theano linear regression with gradient descent</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-07 09:44:00" itemprop="dateCreated datePublished" datetime="2018-08-07T09:44:00+08:00">2018-08-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index"><span itemprop="name">machine learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><a href="https://kezunlin.me/post/3bee8fac/#more"><strong>Example 1-theano linear regression with gradient descent</strong></a></li>
<li><a href="https://kezunlin.me/post/8d4707b6/#more">Example 2 - Linear Regression Example with Python and theano from MSDN</a></li>
<li><a href="https://kezunlin.me/post/8ce3f979/#more">Example 3- A Real Example Logistic Regression with theano</a></li>
</ul>
<h2 id="code-example"><a href="#code-example" class="headerlink" title="code example"></a>code example</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://blogs.msdn.microsoft.com/lukassteindl/2015/12/13/linear-regression-example-with-python-and-theano/</span></span><br><span class="line"><span class="comment"># http://blog.csdn.net/vins_napoleon/article/details/38057927</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> theano</span><br><span class="line"><span class="keyword">import</span> theano.tensor <span class="keyword">as</span> T</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Linear_Reg</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,x</span>):</span><br><span class="line">        <span class="comment">#x,y是scalar,vector(n,),matrix(m,n)</span></span><br><span class="line">        <span class="variable language_">self</span>.w = theano.shared(value = <span class="number">0.0</span>,name = <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.b = theano.shared(value = <span class="number">0.0</span>,name = <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">        <span class="comment"># w,b is scalar,so x can be vector</span></span><br><span class="line">        <span class="variable language_">self</span>.y_pred = x * <span class="variable language_">self</span>.w + <span class="variable language_">self</span>.b</span><br><span class="line">        <span class="variable language_">self</span>.params = [<span class="variable language_">self</span>.w,<span class="variable language_">self</span>.b]</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">msl</span>(<span class="params">self,y</span>):</span><br><span class="line">        <span class="keyword">return</span> T.<span class="built_in">sum</span>((y - <span class="variable language_">self</span>.y_pred)**<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Linear_Reg2</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,x</span>):</span><br><span class="line">        <span class="comment">#x,y是scalar,vector(1,),matrix(m,1)</span></span><br><span class="line">        <span class="variable language_">self</span>.w = theano.shared(value = np.zeros((<span class="number">1</span>,),dtype=theano.config.floatX),name = <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.b = theano.shared(value = np.zeros((<span class="number">1</span>,),dtype=theano.config.floatX),name = <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">        <span class="comment"># w,b is vector,so x cab be scalar</span></span><br><span class="line">        <span class="variable language_">self</span>.y_pred = x * <span class="variable language_">self</span>.w + <span class="variable language_">self</span>.b</span><br><span class="line">        <span class="variable language_">self</span>.params = [<span class="variable language_">self</span>.w,<span class="variable language_">self</span>.b]</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">msl</span>(<span class="params">self,y</span>):</span><br><span class="line">        <span class="keyword">return</span> T.<span class="built_in">sum</span>((y - <span class="variable language_">self</span>.y_pred)**<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_type</span>():</span><br><span class="line">    <span class="comment"># x,y be scalar</span></span><br><span class="line">    points_x = [<span class="number">1.1</span>,<span class="number">2.2</span>] </span><br><span class="line">    points_y = [<span class="number">3.3</span>,<span class="number">4.4</span>]</span><br><span class="line">    X = theano.shared(np.asarray(points_x,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">    Y = theano.shared(np.asarray(points_y,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">    x = T.dscalar(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> x</span><br><span class="line">    <span class="built_in">print</span> x.<span class="built_in">type</span></span><br><span class="line">    <span class="built_in">print</span> X[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span> X[<span class="number">0</span>].<span class="built_in">type</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#x</span></span><br><span class="line">    <span class="comment">#TensorType(float64, scalar)</span></span><br><span class="line">    <span class="comment">#Subtensor&#123;int64&#125;.0</span></span><br><span class="line">    <span class="comment">#TensorType(float64, scalar)</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_type2</span>():</span><br><span class="line">    <span class="comment"># x,y be vector</span></span><br><span class="line">    points_x = [<span class="number">1.1</span>,<span class="number">2.2</span>] </span><br><span class="line">    points_y = [<span class="number">3.3</span>,<span class="number">4.4</span>]</span><br><span class="line">    X = theano.shared(np.asarray(points_x,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">    Y = theano.shared(np.asarray(points_y,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">    x = T.dvector(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> x</span><br><span class="line">    <span class="built_in">print</span> x.<span class="built_in">type</span></span><br><span class="line">    <span class="built_in">print</span> X[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">    <span class="built_in">print</span> X[<span class="number">0</span>:<span class="number">2</span>].<span class="built_in">type</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#x</span></span><br><span class="line">    <span class="comment">#TensorType(float64, vector)</span></span><br><span class="line">    <span class="comment">#Subtensor&#123;int64:int64:&#125;.0</span></span><br><span class="line">    <span class="comment">#TensorType(float64, vector)</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_model1</span>(<span class="params">mode</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    [w,b be scalar]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mode = scalar(), set mini_batch_size = 1</span></span><br><span class="line"><span class="string">    mode = vector(m,),  reshape X,Y to vector  </span></span><br><span class="line"><span class="string">    mode = matrix(m,n), reshape X,Y to matrix</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    eta = <span class="number">0.000001</span></span><br><span class="line">    epochs = <span class="number">1000</span></span><br><span class="line">    points = genfromtxt(<span class="string">&quot;data.csv&quot;</span>, delimiter=<span class="string">&quot;,&quot;</span>)<span class="comment"># (100,2)</span></span><br><span class="line">    points_x = points[:,<span class="number">0</span>] <span class="comment"># (100,)   numpy.float64</span></span><br><span class="line">    points_y = points[:,<span class="number">1</span>] <span class="comment"># (100,)   numpy.float64</span></span><br><span class="line">    N = points_x.shape[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">&quot;scalar&quot;</span>:</span><br><span class="line">        mini_batch_size = <span class="number">1</span>  <span class="comment"># must be 1 so that all X[i] are used</span></span><br><span class="line">        X = theano.shared(np.asarray(points_x,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">        Y = theano.shared(np.asarray(points_y,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># so than we get X[0],X[1],...</span></span><br><span class="line">        x = T.dscalar(<span class="string">&#x27;tx&#x27;</span>)</span><br><span class="line">        y = T.dscalar(<span class="string">&#x27;ty&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">&quot;vector&quot;</span>:</span><br><span class="line">        mini_batch_size = <span class="number">5</span></span><br><span class="line">        X = theano.shared(np.asarray(points_x,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">        Y = theano.shared(np.asarray(points_y,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">                      </span><br><span class="line">        <span class="comment"># so than we get X[0:5],X[5:10],...</span></span><br><span class="line">        x = T.dvector(<span class="string">&#x27;tx&#x27;</span>)</span><br><span class="line">        y = T.dvector(<span class="string">&#x27;ty&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">&quot;matrix&quot;</span>:</span><br><span class="line">        mini_batch_size = <span class="number">5</span></span><br><span class="line">        X = theano.shared(np.asarray(points_x,dtype=theano.config.floatX).reshape(N,<span class="number">1</span>),borrow = <span class="literal">True</span>)</span><br><span class="line">        Y = theano.shared(np.asarray(points_y,dtype=theano.config.floatX).reshape(N,<span class="number">1</span>),borrow = <span class="literal">True</span>)</span><br><span class="line">                      </span><br><span class="line">        <span class="comment"># so than we get X[0:5],X[5:10],...</span></span><br><span class="line">        x = T.dmatrix(<span class="string">&#x27;tx&#x27;</span>)</span><br><span class="line">        y = T.dmatrix(<span class="string">&#x27;ty&#x27;</span>)             </span><br><span class="line">        </span><br><span class="line">    num_batches = N/mini_batch_size</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#index = T.lscalar() # l int64</span></span><br><span class="line">    </span><br><span class="line">    reg = Linear_Reg(x = x)</span><br><span class="line">    cost = reg.msl(y)</span><br><span class="line"></span><br><span class="line">    w_g = T.grad(cost = cost, wrt = reg.w)</span><br><span class="line">    b_g = T.grad(cost = cost, wrt = reg.b)</span><br><span class="line"></span><br><span class="line">    updates=[(reg.w, reg.w - eta * w_g),</span><br><span class="line">             (reg.b, reg.b - eta * b_g)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># use x,y as input (调用函数的时候，x,y的参数化必须是python数值，不能是theano variable)</span></span><br><span class="line">    train_model = theano.function(inputs=[x,y],</span><br><span class="line">                                  outputs = cost,</span><br><span class="line">                                  updates = updates,</span><br><span class="line">                                  )</span><br><span class="line"></span><br><span class="line">    cost_t = <span class="number">0.0</span></span><br><span class="line">    costs = []</span><br><span class="line">    start_time = time.clock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> xrange(epochs):</span><br><span class="line">        <span class="comment"># 1个epoch,所有N个样本参与训练,mini = m,学习N/m次</span></span><br><span class="line">        cost_l = []</span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(num_batches):</span><br><span class="line">            <span class="keyword">if</span> mode == <span class="string">&quot;scalar&quot;</span>:</span><br><span class="line">                x = X.get_value()[index]</span><br><span class="line">                y = Y.get_value()[index]</span><br><span class="line">            <span class="keyword">else</span>:  </span><br><span class="line">                x = X.get_value()[index*mini_batch_size:(index+<span class="number">1</span>)*mini_batch_size]</span><br><span class="line">                y = Y.get_value()[index*mini_batch_size:(index+<span class="number">1</span>)*mini_batch_size] </span><br><span class="line">            cost_l.append( train_model(x,y) )</span><br><span class="line"></span><br><span class="line">        cost_t = np.mean(cost_l)</span><br><span class="line">        costs.append(cost_t)</span><br><span class="line"></span><br><span class="line">    end_time = time.clock()</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;\nTotal time is ：&#x27;</span>,end_time -start_time,<span class="string">&#x27; s&#x27;</span> </span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;last cost :&#x27;</span>,cost_t</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;w value : &#x27;</span>,reg.w.get_value() </span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;b value : &#x27;</span>,reg.b.get_value() </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_model2</span>(<span class="params">mode</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    [w,b be vector(1,)]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    mode = scalar(),   set mini_batch_size = 1</span></span><br><span class="line"><span class="string">    mode = vector(1,), set mini_batch_size = 1, reshape X,Y to vector  </span></span><br><span class="line"><span class="string">    mode = matrix(m,1), reshape X,Y to matrix</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    eta = <span class="number">0.000001</span></span><br><span class="line">    epochs = <span class="number">1000</span></span><br><span class="line">    points = genfromtxt(<span class="string">&quot;data.csv&quot;</span>, delimiter=<span class="string">&quot;,&quot;</span>)<span class="comment"># (100,2)</span></span><br><span class="line">    points_x = points[:,<span class="number">0</span>] <span class="comment"># (100,)   numpy.float64</span></span><br><span class="line">    points_y = points[:,<span class="number">1</span>] <span class="comment"># (100,)   numpy.float64</span></span><br><span class="line">    N = points_x.shape[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">&quot;scalar&quot;</span>:</span><br><span class="line">        mini_batch_size = <span class="number">1</span> </span><br><span class="line">        X = theano.shared(np.asarray(points_x,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">        Y = theano.shared(np.asarray(points_y,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># so than we get X[0],X[1],...</span></span><br><span class="line">        x = T.dscalar(<span class="string">&#x27;tx&#x27;</span>)</span><br><span class="line">        y = T.dscalar(<span class="string">&#x27;ty&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">&quot;vector&quot;</span>:</span><br><span class="line">        mini_batch_size = <span class="number">1</span> </span><br><span class="line">        X = theano.shared(np.asarray(points_x,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">        Y = theano.shared(np.asarray(points_y,dtype=theano.config.floatX),borrow = <span class="literal">True</span>)</span><br><span class="line">                      </span><br><span class="line">        <span class="comment"># so than we get X[0:5],X[5:10],...</span></span><br><span class="line">        x = T.dvector(<span class="string">&#x27;tx&#x27;</span>)</span><br><span class="line">        y = T.dvector(<span class="string">&#x27;ty&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">&quot;matrix&quot;</span>:</span><br><span class="line">        mini_batch_size = <span class="number">5</span></span><br><span class="line">        X = theano.shared(np.asarray(points_x,dtype=theano.config.floatX).reshape(N,<span class="number">1</span>),borrow = <span class="literal">True</span>)</span><br><span class="line">        Y = theano.shared(np.asarray(points_y,dtype=theano.config.floatX).reshape(N,<span class="number">1</span>),borrow = <span class="literal">True</span>)</span><br><span class="line">                      </span><br><span class="line">        <span class="comment"># so than we get X[0:5],X[5:10],...</span></span><br><span class="line">        x = T.dmatrix(<span class="string">&#x27;tx&#x27;</span>)</span><br><span class="line">        y = T.dmatrix(<span class="string">&#x27;ty&#x27;</span>)             </span><br><span class="line">        </span><br><span class="line">    num_batches = N/mini_batch_size</span><br><span class="line">        </span><br><span class="line">    index = T.lscalar() <span class="comment"># l int64</span></span><br><span class="line">    reg = Linear_Reg2(x = x)</span><br><span class="line">    cost = reg.msl(y)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#w_g,b_g = T.grad(cost,[reg.w,reg.b])</span></span><br><span class="line">    <span class="comment">#updates=[(reg.w, reg.w - eta * w_g), (reg.b, reg.b - eta * b_g)]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#==========================================================================</span></span><br><span class="line">    <span class="comment"># use params and updates</span></span><br><span class="line">    <span class="comment">#==========================================================================</span></span><br><span class="line">    params = [reg.w,reg.b]       <span class="comment"># list of [w,b]</span></span><br><span class="line">    grads = T.grad(cost,params)  <span class="comment"># list of [w_g,b_g]</span></span><br><span class="line">    updates = [(param,param-eta*grad) </span><br><span class="line">               <span class="keyword">for</span> param,grad <span class="keyword">in</span> <span class="built_in">zip</span>(params,grads)]               </span><br><span class="line">                                <span class="comment"># list of [ (w,w-eta*w_g), (b, b-eta*b_g) ]</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># updates必须是shared变量;</span></span><br><span class="line">    <span class="comment"># use x,y as input (调用函数的时候，x,y的参数化必须是python数值，不能是theano variable)</span></span><br><span class="line">    <span class="comment"># use index as input (调用函数的时候，index的参数化必须是python数值),</span></span><br><span class="line">    <span class="comment"># 通过givens替换掉x,y，X[index],Y[index]和x,y的类型必须一致，都是theano variable</span></span><br><span class="line">    <span class="comment"># 此处x,y，X[index],Y[index]都是  TensorType(float64, scalar)　</span></span><br><span class="line">    <span class="comment"># 或者是float64, vector,matrix类型</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">&quot;scalar&quot;</span>:</span><br><span class="line">        train_model = theano.function(inputs=[index],</span><br><span class="line">                                      outputs = cost,</span><br><span class="line">                                      updates = updates,</span><br><span class="line">                                      givens = &#123;x:X[index],</span><br><span class="line">                                                y:Y[index]&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        train_model = theano.function(inputs=[index],</span><br><span class="line">                                      outputs = cost,</span><br><span class="line">                                      updates = updates,</span><br><span class="line">                                      givens = &#123;x:X[index*mini_batch_size:(index+<span class="number">1</span>)*mini_batch_size],</span><br><span class="line">                                                y:Y[index*mini_batch_size:(index+<span class="number">1</span>)*mini_batch_size]&#125;)</span><br><span class="line"></span><br><span class="line">    cost_t = <span class="number">0.0</span></span><br><span class="line">    costs = []</span><br><span class="line">    start_time = time.clock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> xrange(epochs):</span><br><span class="line">        <span class="comment"># 1个epoch,所有N个样本参与训练,mini = m,学习N/m次</span></span><br><span class="line">        cost_l = []</span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(num_batches):</span><br><span class="line">            cost_l.append( train_model(index) )</span><br><span class="line">            </span><br><span class="line">        cost_t = np.mean(cost_l)</span><br><span class="line">        costs.append(cost_t)</span><br><span class="line"></span><br><span class="line">    end_time = time.clock()</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;\nTotal time is ：&#x27;</span>,end_time -start_time,<span class="string">&#x27; s&#x27;</span> </span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;last cost :&#x27;</span>,cost_t</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;w value : &#x27;</span>,reg.w.get_value()  </span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;b value : &#x27;</span>,reg.b.get_value()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">run:</span></span><br><span class="line"><span class="string">Total time is ： 2.796644  s</span></span><br><span class="line"><span class="string">last cost : 113.178407322</span></span><br><span class="line"><span class="string">w value :  1.48497718432</span></span><br><span class="line"><span class="string">b value :  0.0890071567283</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">run2:</span></span><br><span class="line"><span class="string">Total time is ： 2.127487  s</span></span><br><span class="line"><span class="string">last cost : 113.178407322</span></span><br><span class="line"><span class="string">w value :  [ 1.48497718]</span></span><br><span class="line"><span class="string">b value :  [ 0.08900716]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">run3:</span></span><br><span class="line"><span class="string">Total time is ： 0.480144  s</span></span><br><span class="line"><span class="string">avg cost : 565.419900755</span></span><br><span class="line"><span class="string">w value :  [ 1.48492605]</span></span><br><span class="line"><span class="string">b value :  [ 0.08896923]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    test_type()</span><br><span class="line">    test_type2()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#test()</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#run_model1(&quot;scalar&quot;)</span></span><br><span class="line">    <span class="comment">#run_model1(&quot;vector&quot;)   </span></span><br><span class="line">    <span class="comment">#run_model1(&quot;matrix&quot;)   </span></span><br><span class="line">    </span><br><span class="line">    run_model2(<span class="string">&quot;scalar&quot;</span>)</span><br><span class="line">    run_model2(<span class="string">&quot;vector&quot;</span>)   </span><br><span class="line">    run_model2(<span class="string">&quot;matrix&quot;</span>) </span><br></pre></td></tr></table></figure>

<pre><code>Total time is ： 1.929041  s
last cost : 113.178407322
w value :  [ 1.48497718]
b value :  [ 0.08900716]

Total time is ： 2.040197  s
last cost : 113.178407322
w value :  [ 1.48497718]
b value :  [ 0.08900716]

Total time is ： 0.553913  s
last cost : 565.419900755
w value :  [ 1.48492605]
b value :  [ 0.08896923]
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/lukassteindl/2015/12/13/linear-regression-example-with-python-and-theano/">linear-regression-example-with-python-and-theano</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/vins_napoleon/article/details/38057927">theano regression exercise</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20180807: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/Example-2-Linear-Regression-Example-with-Python-and-theano-from-MSDN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/Example-2-Linear-Regression-Example-with-Python-and-theano-from-MSDN/" class="post-title-link" itemprop="url">Example 2 - Linear Regression Example with Python and theano from MSDN</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-07 09:44:00" itemprop="dateCreated datePublished" datetime="2018-08-07T09:44:00+08:00">2018-08-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index"><span itemprop="name">machine learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><a href="https://kezunlin.me/post/3bee8fac/#more">Example 1-theano linear regression with gradient descent</a></li>
<li><a href="https://kezunlin.me/post/8d4707b6/#more"><strong>Example 2 - Linear Regression Example with Python and theano from MSDN</strong></a></li>
<li><a href="https://kezunlin.me/post/8ce3f979/#more">Example 3- A Real Example Logistic Regression with theano</a></li>
</ul>
<h2 id="code-example"><a href="#code-example" class="headerlink" title="code example"></a>code example</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://blogs.msdn.microsoft.com/lukassteindl/2015/12/13/linear-regression-example-with-python-and-theano/</span></span><br><span class="line"><span class="comment"># http://jakevdp.github.io/blog/2013/05/12/embedding-matplotlib-animations/</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">在Python Notebook中无法展现动画，只能展示静态的图像。</span></span><br><span class="line"><span class="string">The problem is that so far the integration of IPython with matplotlib is entirely static, </span></span><br><span class="line"><span class="string">while animations are by their nature dynamic.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"><span class="keyword">import</span> matplotlib.animation <span class="keyword">as</span> animation </span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> style </span><br><span class="line"><span class="keyword">import</span> theano </span><br><span class="line"><span class="keyword">from</span> theano <span class="keyword">import</span> tensor <span class="keyword">as</span> T </span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">style.use(<span class="string">&#x27;fivethirtyeight&#x27;</span>) </span><br><span class="line">fig = plt.figure() </span><br><span class="line">ax1 = fig.add_subplot(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">trX = np.linspace(-<span class="number">1</span>,<span class="number">1</span>,<span class="number">101</span>)  <span class="comment"># (101,)</span></span><br><span class="line">trY = <span class="number">2</span> * trX + np.random.randn(*trX.shape) * <span class="number">0.33</span>   <span class="comment"># (101,)</span></span><br><span class="line"></span><br><span class="line">X = T.scalar() </span><br><span class="line">Y = T.scalar()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">model</span> (X,w): </span><br><span class="line">    <span class="keyword">return</span> X * w</span><br><span class="line"></span><br><span class="line">w = theano.shared(np.asarray(<span class="number">0.</span>, dtype=theano.config.floatX)) <span class="comment">#scalar</span></span><br><span class="line">y = model(X,w)</span><br><span class="line"></span><br><span class="line">cost = T.mean(T.sqr(y-Y)) </span><br><span class="line">gradient = T.grad(cost=cost, wrt = w) </span><br><span class="line">updates = [[w,w-gradient * <span class="number">0.001</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment">#train = theano.function(inputs=[X,Y], outputs=cost, updates = updates, allow_input_downcast= True)</span></span><br><span class="line">train = theano.function(inputs=[X,Y], outputs=cost, updates = updates)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>): </span><br><span class="line">        <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span> (trX,trY): </span><br><span class="line">            train(x,y) </span><br><span class="line">            <span class="built_in">print</span> (w.<span class="built_in">eval</span>()) </span><br><span class="line">            </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">animate</span>(<span class="params">i</span>): </span><br><span class="line">    <span class="comment"># i: iteration of animate</span></span><br><span class="line">    <span class="comment">#print i</span></span><br><span class="line">    ax1.clear() </span><br><span class="line">    plt.scatter(trX, trY,  label=<span class="string">&#x27;Gradient Descent on GPU&#x27;</span>, </span><br><span class="line">                    alpha=<span class="number">0.3</span>, edgecolors=<span class="string">&#x27;none&#x27;</span>) </span><br><span class="line">    plt.legend() </span><br><span class="line">    plt.grid(<span class="literal">True</span>) </span><br><span class="line">    <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span> (trX,trY): </span><br><span class="line">        train(x,y) </span><br><span class="line">        <span class="comment">#print (w.eval()) </span></span><br><span class="line">       </span><br><span class="line">    xs = [-<span class="number">1</span>,<span class="number">1</span>] </span><br><span class="line">    ys = [-<span class="number">1</span>*w.<span class="built_in">eval</span>(),w.<span class="built_in">eval</span>()] </span><br><span class="line">    ax1.plot(xs,ys) </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_animate</span>():</span><br><span class="line">    ani = animation.FuncAnimation(fig, animate, interval = <span class="number">250</span>)</span><br><span class="line">    plt.show() </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#run()</span></span><br><span class="line">    show_animate()</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/lukassteindl/2015/12/13/linear-regression-example-with-python-and-theano/">linear-regression-example-with-python-and-theano</a></li>
<li><a target="_blank" rel="noopener" href="http://jakevdp.github.io/blog/2013/05/12/embedding-matplotlib-animations/">embedding-matplotlib-animations</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20180807: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/random-and-seed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/random-and-seed/" class="post-title-link" itemprop="url">python random and seed tutorial</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-07 09:35:00" itemprop="dateCreated datePublished" datetime="2018-08-07T09:35:00+08:00">2018-08-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Random-and-seed"><a href="#Random-and-seed" class="headerlink" title="Random and seed"></a>Random and seed</h2><p>所有标准库提供的Random函数其实都是假Random，真正的Random函数式不需要Seed的。</p>
<p>所谓假Random，是指所返回的随机数字其实是一个稳定算法所得出的稳定结果序列，而不是真正意义上的随机序列。 Seed就是这个算法开始计算的第一个值。所以就会出现<strong>只要seed是一样的，那么后续所有“随机”结果和顺序也都是完全一致的。</strong> </p>
<p>通常情况下，你可以用 DateTime.Now.Millisecend() 也就是当前时钟的毫秒来做Seed，因为毫秒对你来说是一个1000以内的随机数字。 这样可以大大改善标准库的Random结果的随机性。 不过这仍然算不上是完全随机，因为重复的概率还是千分之一。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> random</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># random.seed(1)</span></span><br><span class="line"><span class="comment"># np.random.seed(1)</span></span><br><span class="line"><span class="comment">#只要seed一样，不管运行多少次，每次产生的随机数都一样。</span></span><br><span class="line">np.random.seed(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span> np.random.rand(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span> np.random.rand(<span class="number">3</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<pre><code>[[  4.17022005e-01   7.20324493e-01   1.14374817e-04]
 [  3.02332573e-01   1.46755891e-01   9.23385948e-02]]
[[ 0.18626021]
 [ 0.34556073]
 [ 0.39676747]]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#只要seed一样，不管运行多少次，每次产生的随机数都一样。</span></span><br><span class="line">np.random.seed(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span> np.random.rand(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span> np.random.rand(<span class="number">3</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<pre><code>[[  4.17022005e-01   7.20324493e-01   1.14374817e-04]
 [  3.02332573e-01   1.46755891e-01   9.23385948e-02]]
[[ 0.18626021]
 [ 0.34556073]
 [ 0.39676747]]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line">random.seed(<span class="number">1</span>)</span><br><span class="line">random.random()</span><br></pre></td></tr></table></figure>




<pre><code>0.13436424411240122
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">random.seed(<span class="number">1</span>)</span><br><span class="line">random.random()</span><br></pre></td></tr></table></figure>




<pre><code>0.13436424411240122
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">np.random.seed(<span class="number">1</span>)</span><br><span class="line">np.random.randint(<span class="number">0</span>,<span class="number">6</span>, size=(<span class="number">4</span>,<span class="number">5</span>))</span><br></pre></td></tr></table></figure>




<pre><code>array([[5, 3, 4, 0, 1],
       [3, 5, 0, 0, 1],
       [4, 5, 4, 1, 2],
       [4, 5, 2, 4, 3]])
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">np.random.seed(<span class="number">1</span>)</span><br><span class="line">np.random.randint(<span class="number">0</span>,<span class="number">6</span>, size=(<span class="number">4</span>,<span class="number">5</span>))</span><br></pre></td></tr></table></figure>




<pre><code>array([[5, 3, 4, 0, 1],
       [3, 5, 0, 0, 1],
       [4, 5, 4, 1, 2],
       [4, 5, 2, 4, 3]])
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20180806: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/Linear-Regression-with-gradient-descent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/Linear-Regression-with-gradient-descent/" class="post-title-link" itemprop="url">linear Regression with gradient descent</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-06 17:43:00" itemprop="dateCreated datePublished" datetime="2018-08-06T17:43:00+08:00">2018-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index"><span itemprop="name">machine learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Tutorial"><a href="#Tutorial" class="headerlink" title="Tutorial"></a>Tutorial</h2><ul>
<li><p>目标<br>给定N组二位坐标点对(x1,x2),…,(xn,yn)，拟合直线<strong>y &#x3D; mx + b</strong>，找到最佳的m和b，使得总的误差最小。</p>
</li>
<li><p>数据展示<br><img src="https://spin.atomicobject.com/wp-content/uploads/points_for_linear_regression1.png" alt="points"></p>
</li>
<li><p>误差公式<br><img src="https://spin.atomicobject.com/wp-content/uploads/linear_regression_error1.png" alt="errors"></p>
</li>
<li><p>可视化误差<br>误差error是m和b的函数<br><img src="https://spin.atomicobject.com/wp-content/uploads/gradient_descent_error_surface.png" alt="visual errors of m and b"></p>
</li>
<li><p>偏导数计算公式<br><img src="https://spin.atomicobject.com/wp-content/uploads/linear_regression_gradient1.png" alt="partial derivatives"></p>
</li>
<li><p>学习过程<br><img src="https://spin.atomicobject.com/wp-content/uploads/gradient_descent_search1.png" alt="learning"></p>
</li>
<li><p>误差曲线<br><img src="https://spin.atomicobject.com/wp-content/uploads/gradient_descent_error_by_iteration.png" alt="errors curve"></p>
</li>
<li><p>动画演示<br><a target="_blank" rel="noopener" href="https://github.com/mattnedrich/GradientDescentExample/blob/master/gradient_descent_example.gif">演示链接</a></p>
</li>
</ul>
<h2 id="Gradient-Descent"><a href="#Gradient-Descent" class="headerlink" title="Gradient Descent"></a>Gradient Descent</h2><h3 id="随机梯度示例"><a href="#随机梯度示例" class="headerlink" title="随机梯度示例"></a>随机梯度示例</h3><p>横轴X代表参数，纵轴Y代表误差。<br>gradient descent should force us to move in the direction of the minimum<br><img src="http://www.alanzucconi.com/wp-content/uploads/2017/04/GD1.png" alt="hilly landscape"></p>
<h3 id="沿着曲线斜率slope移动"><a href="#沿着曲线斜率slope移动" class="headerlink" title="沿着曲线斜率slope移动"></a>沿着曲线斜率slope移动</h3><p>The best guess the algorithm can do is to move in the direction that of the <strong>slope</strong>, also called the <strong>gradient of the function</strong>.<br><img src="http://www.alanzucconi.com/wp-content/uploads/2017/04/GD2.png" alt="move in the slope"></p>
<h3 id="单变量-single-variable"><a href="#单变量-single-variable" class="headerlink" title="单变量(single variable)"></a>单变量(single variable)</h3><ul>
<li><p>derivative:　导数是一个极限，准确值。<br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-480d8d86fa6d9987f7ce324b80a625f4_l3.svg" alt="derivative of single variable"></p>
</li>
<li><p>estimated gradient: 梯度是一个估计值，和采样距离dx有关。<br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-5dbf8b5401ec48e32f89a1030a272551_l3.svg" alt="estimated gradient"></p>
</li>
<li><p>how to update parameter<br>Once we have found our estimated derivative, we need to move in its opposite direction to climb down the function. This means that we have to update our parameter p like this:<br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-9a48698583db822fec79981416a16556_l3.svg" alt="update parameter"><br>The constant L is often referred as <strong>learning rate</strong>, and it dictates <strong>how fast we move against the gradient</strong>.<br>找到梯度之后，沿着梯度的相反方向移动。</p>
</li>
</ul>
<h3 id="多变量-multiple-variable"><a href="#多变量-multiple-variable" class="headerlink" title="多变量(multiple variable)"></a>多变量(multiple variable)</h3><ul>
<li><p>partial derivatives: 多变量偏导数<br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-9d2fc6510d49e9eec7cecc0a0942ada3_l3.svg" alt="partial derivatives"><br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-4485c43c04b41137d050db9173cc9672_l3.svg" alt="partial derivatives"><br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-060d755a46b1ae366e01f67d30f8604e_l3.svg" alt="partial derivatives"></p>
</li>
<li><p>estimated gradient: 梯度和采样距离dx,dy,dz有关。<br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-7c7650af48d0b52b5af436e328ce818d_l3.svg" alt="estimated gradient"><br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-0df8ae3c554d5cc7885c75e7cfc201cc_l3.svg" alt="estimated gradient"><br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-e61905804f0874ef5938b05bba167503_l3.svg" alt="estimated gradient"></p>
</li>
<li><p>gradient vector: 梯度向量<br><img src="http://www.alanzucconi.com/wp-content/ql-cache/quicklatex.com-3fc9711c2ae2b6f9df78076a177a3b29_l3.svg" alt="gradient vector"></p>
</li>
</ul>
<h2 id="Code-Example"><a href="#Code-Example" class="headerlink" title="Code Example"></a>Code Example</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># y = mx + b</span></span><br><span class="line"><span class="comment"># m is slope, b is y-intercept</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_error_for_line_given_points</span>(<span class="params">b, m, points</span>):</span><br><span class="line">    totalError = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(points)):</span><br><span class="line">        x = points[i, <span class="number">0</span>]</span><br><span class="line">        y = points[i, <span class="number">1</span>]</span><br><span class="line">        totalError += (y - (m * x + b)) ** <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> totalError / <span class="built_in">float</span>(<span class="built_in">len</span>(points))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_mini_batch</span>(<span class="params">b, m, mini_batch, learningRate</span>):</span><br><span class="line">    <span class="comment">#一次epoch梯度迭代，该函数需要调用epoches次</span></span><br><span class="line">    <span class="comment">#每一次计算m,b的梯度，每一次学习都需要所有的N个样本数据参与运算。一个epoch内，只能学习１次。</span></span><br><span class="line">    <span class="comment">#后续可以采用mini-batch思路，每一次学习只需要m个样本数据参与运算。一个epoch内，可以学习n/m次。</span></span><br><span class="line">    N = <span class="built_in">float</span>(<span class="built_in">len</span>(points))</span><br><span class="line">    b_gradient,m_gradient = compute_cost_gradient_of_all(mini_batch,b,m)</span><br><span class="line">    new_b = b - (learningRate/N) * b_gradient</span><br><span class="line">    new_m = m - (learningRate/N) * m_gradient</span><br><span class="line">    <span class="keyword">return</span> [new_b, new_m]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_cost_gradient_of_all</span>(<span class="params">points,b,m</span>):</span><br><span class="line">    <span class="comment">#计算N个样本的总梯度</span></span><br><span class="line">    b_gradient = <span class="number">0</span></span><br><span class="line">    m_gradient = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(points)):</span><br><span class="line">        delta_b,delta_m = compute_cost_gradient_of_one(points[i],b,m)</span><br><span class="line">        b_gradient += delta_b</span><br><span class="line">        m_gradient += delta_m</span><br><span class="line">    <span class="keyword">return</span> [b_gradient,m_gradient]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_cost_gradient_of_one</span>(<span class="params">point,b,m</span>):</span><br><span class="line">    <span class="comment">#计算一个样本的梯度</span></span><br><span class="line">    x = point[<span class="number">0</span>]</span><br><span class="line">    y = point[<span class="number">1</span>]</span><br><span class="line">    b_gradient =  -<span class="number">2</span> *     (y - ((m * x) + b))</span><br><span class="line">    m_gradient =  -<span class="number">2</span> * x * (y - ((m * x) + b))</span><br><span class="line">    <span class="keyword">return</span> [b_gradient,m_gradient]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gradient_descent_runner</span>(<span class="params">points, starting_b, starting_m, learning_rate, epoches</span>):</span><br><span class="line">    b = starting_b</span><br><span class="line">    m = starting_m</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(epoches):</span><br><span class="line">        <span class="comment">#每一次学习都需要所有的N个样本数据参与运算。一个epoch内，只能学习１次。</span></span><br><span class="line">        <span class="comment">#此时,mini_batch包含了所有N个样本。</span></span><br><span class="line">        b, m = update_mini_batch(b, m, array(points), learning_rate)</span><br><span class="line">        <span class="comment">#print &quot;&#123;0&#125; iterations b = &#123;1&#125;, m = &#123;2&#125;, error = &#123;3&#125;&quot;.format(i, b, m, compute_error_for_line_given_points(b, m, points))</span></span><br><span class="line">    <span class="keyword">return</span> [b, m]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gradient_descent_runner_with_mini_batch</span>(<span class="params">points, starting_b, starting_m, learning_rate, epoches,mini_batch_size</span>):</span><br><span class="line">    b = starting_b</span><br><span class="line">    m = starting_m</span><br><span class="line">    n = <span class="built_in">len</span>(points)</span><br><span class="line">    num_batches = n/mini_batch_size</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(epoches):</span><br><span class="line">        <span class="comment">#采用mini-batch思路，每一次学习只需要m个样本数据参与运算。一个epoch内，可以学习n/m次。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># shuffle data and get N/mini_batch_size mini batches</span></span><br><span class="line">        np.random.shuffle(points)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># iterate over all mini batches to learn (updating m and b)</span></span><br><span class="line">        <span class="comment"># now in a epoch,we can learn N/mini times instead of just once.</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> xrange(<span class="number">0</span>,num_batches):</span><br><span class="line">            mini_batch = points[k*mini_batch_size : (k+<span class="number">1</span>)*mini_batch_size]</span><br><span class="line">            b, m = update_mini_batch(b, m, mini_batch, learning_rate)</span><br><span class="line">        <span class="comment">#print &quot;&#123;0&#125; iterations b = &#123;1&#125;, m = &#123;2&#125;, error = &#123;3&#125;&quot;.format(i, b, m, compute_error_for_line_given_points(b, m, points))</span></span><br><span class="line">    <span class="keyword">return</span> [b, m]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    points = genfromtxt(<span class="string">&quot;data.csv&quot;</span>, delimiter=<span class="string">&quot;,&quot;</span>)</span><br><span class="line">    learning_rate = <span class="number">0.0001</span></span><br><span class="line">    initial_b = <span class="number">0</span> <span class="comment"># initial y-intercept guess</span></span><br><span class="line">    initial_m = <span class="number">0</span> <span class="comment"># initial slope guess</span></span><br><span class="line">    epoches = <span class="number">1000</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Starting gradient descent at b = &#123;0&#125;, m = &#123;1&#125;, error = &#123;2&#125;&quot;</span>.<span class="built_in">format</span>(initial_b, initial_m, compute_error_for_line_given_points(initial_b, initial_m, points))</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Running...&quot;</span></span><br><span class="line">    [b, m] = gradient_descent_runner(points, initial_b, initial_m, learning_rate, epoches)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;After &#123;0&#125; iterations b = &#123;1&#125;, m = &#123;2&#125;, error = &#123;3&#125;&quot;</span>.<span class="built_in">format</span>(epoches, b, m, compute_error_for_line_given_points(b, m, points))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run2</span>():</span><br><span class="line">    points = genfromtxt(<span class="string">&quot;data.csv&quot;</span>, delimiter=<span class="string">&quot;,&quot;</span>)</span><br><span class="line">    learning_rate = <span class="number">0.0001</span></span><br><span class="line">    initial_b = <span class="number">0</span> <span class="comment"># initial y-intercept guess</span></span><br><span class="line">    initial_m = <span class="number">0</span> <span class="comment"># initial slope guess</span></span><br><span class="line">    epoches = <span class="number">1000</span></span><br><span class="line">    mini_batch_size = <span class="number">10</span> <span class="comment"># mini batch size</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Starting gradient descent at b = &#123;0&#125;, m = &#123;1&#125;, error = &#123;2&#125;&quot;</span>.<span class="built_in">format</span>(initial_b, initial_m, compute_error_for_line_given_points(initial_b, initial_m, points))</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Running...&quot;</span></span><br><span class="line">    [b, m] = gradient_descent_runner_with_mini_batch(points, initial_b, initial_m, learning_rate, epoches,mini_batch_size)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;After &#123;0&#125; iterations b = &#123;1&#125;, m = &#123;2&#125;, error = &#123;3&#125;&quot;</span>.<span class="built_in">format</span>(epoches, b, m, compute_error_for_line_given_points(b, m, points))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    run()</span><br><span class="line">    <span class="comment">#run2()</span></span><br></pre></td></tr></table></figure>

<pre><code>Starting gradient descent at b = 0, m = 0, error = 5565.10783448
Running...
After 1000 iterations b = 0.0889365199374, m = 1.47774408519, error = 112.614810116
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://spin.atomicobject.com/2014/06/24/gradient-descent-linear-regression/">原理讲解 gradient-descent-linear-regression</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mattnedrich/GradientDescentExample">代码示例 GradientDescentExample</a></li>
<li><a target="_blank" rel="noopener" href="http://www.alanzucconi.com/2017/04/10/gradient-descent/">导数和梯度</a></li>
<li><a target="_blank" rel="noopener" href="https://www.pyimagesearch.com/2016/10/10/gradient-descent-with-python/">gradient-descent-with-python</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20180806: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/Guide-to-compile-and-use-opencv-with-CUDA-support-on-windows-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/Guide-to-compile-and-use-opencv-with-CUDA-support-on-windows-10/" class="post-title-link" itemprop="url">compile opencv with CUDA support on windows 10</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-07-13 17:16:00" itemprop="dateCreated datePublished" datetime="2018-07-13T17:16:00+08:00">2018-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><a href="https://kezunlin.me/post/15f5c3e8/">Part 1: compile opencv on ubuntu 16.04</a></li>
<li><strong><a href="https://kezunlin.me/post/6580691f/">Part 2: compile opencv with CUDA support on windows 10</a></strong></li>
<li><a href="https://kezunlin.me/post/61d55ab4/">Part 3: opencv mat for loop</a></li>
<li><a href="https://kezunlin.me/post/7a6ba82e/">Part 4: speed up opencv image processing with openmp</a></li>
</ul>
<h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><p>requirements:</p>
<ul>
<li>windows: 10</li>
<li>opencv: 3.1.0</li>
<li>nvidia driver: gtx 1060  382.05  (gtx 970m)</li>
<li>GPU arch(s): sm_61  (sm_52)</li>
<li>cuda: 8.0 </li>
<li>cudnn: 5.0.5</li>
<li>cmake: 3.10.0</li>
<li>vs: vs2015 64</li>
</ul>
<h3 id="nvidia-cuda-CC"><a href="#nvidia-cuda-CC" class="headerlink" title="nvidia cuda CC"></a>nvidia cuda CC</h3><p>see <a target="_blank" rel="noopener" href="https://developer.nvidia.com/cuda-gpus">cuda compute capacity</a></p>
<p><img src="https://kezunlin.me/images/posts/635233-20180717092113975-663849717.png" alt="cuda-enabled nvidia GeForce cc"></p>
<h3 id="cpu-vs-gpu"><a href="#cpu-vs-gpu" class="headerlink" title="cpu vs gpu"></a>cpu vs gpu</h3><p>for opencv functions</p>
<p><img src="https://kezunlin.me/images/posts/635233-20180713160537940-1813231033.png" alt="speed for cpu and gpu"></p>
<h3 id="get-source"><a href="#get-source" class="headerlink" title="get source"></a>get source</h3><p>Get opencv 3.1.0 for git and fix some bugs </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/opencv/opencv.git</span><br><span class="line"><span class="built_in">cd</span> opencv</span><br><span class="line">git checkout -b v3.1.0 3.1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># fix bugs for 3.1.0</span></span><br><span class="line">git cherry-pick 10896</span><br><span class="line">git cherry-pick cdb9c</span><br><span class="line">git cherry-pick 24dbb</span><br><span class="line"></span><br><span class="line">git branch </span><br><span class="line"></span><br><span class="line">master</span><br><span class="line">* v3.1.0</span><br></pre></td></tr></table></figure>

<h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; cmake-gui ..</span><br></pre></td></tr></table></figure>

<h4 id="config"><a href="#config" class="headerlink" title="config"></a>config</h4><p>configure with <code>VS 2015 win64</code> with options </p>
<pre><code>BUILD_SHARED_LIBS  ON
CMAKE_CONFIGURATION_TYPES Release # Release
CMAKE_CXX_FLAGS_RELEASE /MD /O2 /Ob2 /DNDEBUG /MP # for multiple processor

WITH_VTK OFF
BUILD_PERF_TESTS OFF # if ON, build errors occur

WITH_CUDA ON
CUDA_TOOLKIT_ROOT_DIR  C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v8.0
#CUDA_ARCH_BIN  3.0 3.5 5.0 5.2 6.0 6.1 # very time-consuming 
CUDA_ARCH_PTX 3.0
</code></pre>
<p>for opencv<br><img src="https://kezunlin.me/images/posts/635233-20180719170434104-1649296827.png" alt="opencv cuda arch"></p>
<p><code>CUDA_ARCH_BIN  3.0 3.5 5.0 5.2 6.0 6.1</code> relate with</p>
<pre><code>-gencode;arch=compute_30,code=sm_30;-gencode;arch=compute_35,code=sm_35;-gencode;arch=compute_50,code=sm_50;-gencode;arch=compute_52,code=sm_52;-gencode;arch=compute_60,code=sm_60;-gencode;arch=compute_61,code=sm_61;
</code></pre>
<p><code>CUDA_ARCH_PTX 3.0</code> relate with</p>
<pre><code>    -gencode;arch=compute_30,code=compute_30;
</code></pre>
<p>for caffe<br><img src="https://kezunlin.me/images/posts/635233-20180719170526770-1424061706.png" alt="caffe cuda arch"></p>
<blockquote>
<p>the <code>CUDA_ARCH_BIN</code> parameter specifies multiple architectures so as to support a variety of GPU boards. otherwise, cuda programs will not run with other type of GPU boards.<br>为了支持在多个不同计算能力的GPU上运行可执行程序，opencv&#x2F;caffe编译过程中需要支持多个不同架构，<code>eg. CUDA_ARCH_BIN  3.0 3.5 5.0 5.2 6.0 6.1</code>, 因此编译过程非常耗时。在编译的而过程中尽可能选择需要发布release版本的GPU架构进行配置编译。</p>
</blockquote>
<p>configure and output:</p>
<pre><code>Selecting Windows SDK version 10.0.14393.0 to target Windows 10.0.17134.
found IPP (ICV version): 9.0.1 [9.0.1]
at: C:/compile/opencv/3rdparty/ippicv/unpack/ippicv_win
CUDA detected: 8.0
CUDA NVCC target flags: -gencode;arch=compute_30,code=sm_30;-gencode;arch=compute_30,code=compute_30

General configuration for OpenCV 3.1.0 =====================================
  Version control:               3.1.0-3-g5e9beb8

  Platform:
    Host:                        Windows 10.0.17134 AMD64
    CMake:                       3.10.0
    CMake generator:             Visual Studio 14 2015 Win64
    CMake build tool:            C:/Program Files (x86)/MSBuild/14.0/bin/MSBuild.exe
    MSVC:                        1900

  C/C++:
    Built as dynamic libs?:      YES
    C++ Compiler:                C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe  (ver 19.0.24215.1)
    C++ flags (Release):         /DWIN32 /D_WINDOWS /W4 /GR /EHa  /D _CRT_SECURE_NO_DEPRECATE /D _CRT_NONSTDC_NO_DEPRECATE /D _SCL_SECURE_NO_WARNINGS /Gy /bigobj /Oi  /wd4251 /wd4324 /wd4275 /wd4589 /MP8  /MD /O2 /Ob2 /DNDEBUG /MP  /Zi
    C++ flags (Debug):           /DWIN32 /D_WINDOWS /W4 /GR /EHa  /D _CRT_SECURE_NO_DEPRECATE /D _CRT_NONSTDC_NO_DEPRECATE /D _SCL_SECURE_NO_WARNINGS /Gy /bigobj /Oi  /wd4251 /wd4324 /wd4275 /wd4589 /MP8  /MDd /Zi /Ob0 /Od /RTC1 
    C Compiler:                  C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe
    C flags (Release):           /DWIN32 /D_WINDOWS /W3  /D _CRT_SECURE_NO_DEPRECATE /D _CRT_NONSTDC_NO_DEPRECATE /D _SCL_SECURE_NO_WARNINGS /Gy /bigobj /Oi    /MP8  /MD /O2 /Ob2 /DNDEBUG  /Zi
    C flags (Debug):             /DWIN32 /D_WINDOWS /W3  /D _CRT_SECURE_NO_DEPRECATE /D _CRT_NONSTDC_NO_DEPRECATE /D _SCL_SECURE_NO_WARNINGS /Gy /bigobj /Oi    /MP8  /MDd /Zi /Ob0 /Od /RTC1 
    Linker flags (Release):      /machine:x64  /INCREMENTAL:NO  /debug
    Linker flags (Debug):        /machine:x64  /debug /INCREMENTAL 
    Precompiled headers:         YES
    Extra dependencies:          comctl32 gdi32 ole32 setupapi ws2_32 vfw32 cudart nppc nppi npps cufft -LC:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v8.0/lib/x64
    3rdparty dependencies:       zlib libjpeg libwebp libpng libtiff libjasper IlmImf

  OpenCV modules:
    To be built:                 cudev core cudaarithm flann imgproc ml video cudabgsegm cudafilters cudaimgproc cudawarping imgcodecs photo shape videoio cudacodec highgui objdetect ts features2d calib3d cudafeatures2d cudalegacy cudaobjdetect cudaoptflow cudastereo stitching superres videostab python2
    Disabled:                    world
    Disabled by dependency:      -
    Unavailable:                 java python3 viz

  Windows RT support:            NO

  GUI: 
    QT:                          NO
    Win32 UI:                    YES
    OpenGL support:              NO
    VTK support:                 NO

  Media I/O: 
    ZLib:                        build (ver 1.2.8)
    JPEG:                        build (ver 90)
    WEBP:                        build (ver 0.3.1)
    PNG:                         build (ver 1.6.19)
    TIFF:                        build (ver 42 - 4.0.2)
    JPEG 2000:                   build (ver 1.900.1)
    OpenEXR:                     build (ver 1.7.1)
    GDAL:                        NO

  Video I/O:
    Video for Windows:           YES
    DC1394 1.x:                  NO
    DC1394 2.x:                  NO
    FFMPEG:                      YES (prebuilt binaries)
      codec:                     YES (ver 56.41.100)
      format:                    YES (ver 56.36.101)
      util:                      YES (ver 54.27.100)
      swscale:                   YES (ver 3.1.101)
      resample:                  NO
      gentoo-style:              YES
    GStreamer:                   NO
    OpenNI:                      NO
    OpenNI PrimeSensor Modules:  NO
    OpenNI2:                     NO
    PvAPI:                       NO
    GigEVisionSDK:               NO
    DirectShow:                  YES
    Media Foundation:            NO
    XIMEA:                       NO
    Intel PerC:                  NO

  Parallel framework:            Concurrency

  Other third-party libraries:
    Use IPP:                     9.0.1 [9.0.1]
         at:                     C:/compile/opencv/3rdparty/ippicv/unpack/ippicv_win
    Use IPP Async:               NO
    Use Eigen:                   NO
    Use Cuda:                    YES (ver 8.0)
    Use OpenCL:                  YES
    Use custom HAL:              NO

  NVIDIA CUDA
    Use CUFFT:                   YES
    Use CUBLAS:                  NO
    USE NVCUVID:                 NO
    NVIDIA GPU arch:             30 35 50 52 60 61
    NVIDIA PTX archs:            30
    Use fast math:               NO

  OpenCL:
    Version:                     dynamic
    Include path:                C:/compile/opencv/3rdparty/include/opencl/1.2
    Use AMDFFT:                  NO
    Use AMDBLAS:                 NO

  Python 2:
    Interpreter:                 C:/Python27/python.exe (ver 2.7.13)
    Libraries:                   C:/Python27/libs/python27.lib (ver 2.7.13)
    numpy:                       C:/Python27/lib/site-packages/numpy/core/include (ver 1.11.3)
    packages path:               C:/Python27/Lib/site-packages

  Python 3:
    Interpreter:                 NO

  Python (for build):            C:/Python27/python.exe

  Java:
    ant:                         NO
    JNI:                         C:/Program Files/Java/jdk1.8.0_161/include C:/Program Files/Java/jdk1.8.0_161/include/win32 C:/Program Files/Java/jdk1.8.0_161/include
    Java wrappers:               NO
    Java tests:                  NO

  Matlab:                        Matlab not found or implicitly disabled

  Documentation:
    Doxygen:                     NO
    PlantUML:                    NO

  Tests and samples:
    Tests:                       YES
    Performance tests:           NO
    C/C++ Examples:              NO

  Install path:                  C:/compile/opencv/build/install

  cvconfig.h is in:              C:/compile/opencv/build
-----------------------------------------------------------------

Configuring done
Generating done
</code></pre>
<p>Notice for <code>gencode</code></p>
<pre><code>CUDA NVCC target flags: -gencode;arch=compute_30,code=sm_30;-gencode;arch=compute_35,code=sm_35;-gencode;arch=compute_50,code=sm_50;-gencode;arch=compute_52,code=sm_52;-gencode;arch=compute_60,code=sm_60;-gencode;arch=compute_61,code=sm_61;-gencode;arch=compute_30,code=compute_30
</code></pre>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


<h4 id="build"><a href="#build" class="headerlink" title="build"></a>build</h4><p>Open <code>OpenCV.sln</code> with <code>VS 2015</code> and build release version.</p>
<blockquote>
<p> this may take hours to finish.</p>
</blockquote>
<p><img src="https://kezunlin.me/images/posts/635233-20180716195321260-638321227.png" alt="build success"></p>
<h4 id="errors"><a href="#errors" class="headerlink" title="errors"></a>errors</h4><p><img src="https://kezunlin.me/images/posts/635233-20180716195324728-1445413102.png" alt="opencv build errors"></p>
<p>possible solutions</p>
<blockquote>
<p>With <code>BUILD_PERF_TESTS</code> and <code>BUILD_TESTS</code> disabled, I managed to build OpenCV 3.1 with CUDA 8.0 on Windows 10 with VS2015 x64 arch target. Without building test&#x2F;performance modules, the build process costs less time as well : )</p>
</blockquote>
<blockquote>
<p>I actually got it to work both on my laptop and my desktop (GTX960M and GTX970 respectively) running with OpenCV 3.2 and the latest version of CUDA 8.0 for Win10 in Visual Studio 15 Community! What I did was to enable <code>WITH_CUBLAS</code> aswell as <code>WITH_CUDA</code>. I also turned off <code>BUILD_PERF_TESTS</code> and <code>BUILD_TESTS</code>. The configuration was built using the Visual Studio 14 2015 C++ compiler.</p>
</blockquote>
<p>my solution:</p>
<pre><code>disable `BUILD_PERF_TESTS`
</code></pre>
<p><img src="https://kezunlin.me/images/posts/635233-20180716195328292-1498836513.png" alt="opencv disable build perf tests"></p>
<p>configure and build again. this time cost only about 1 minutes.</p>
<p>after error fixed,build results<br><img src="https://kezunlin.me/images/posts/635233-20180716195739586-1774251249.png" alt="after errors fixed"></p>
<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><h4 id="cuda-module"><a href="#cuda-module" class="headerlink" title="cuda-module"></a>cuda-module</h4><p><code>OpenCV GPU</code> module is written using <code>CUDA</code>, therefore it benefits from the <code>CUDA</code> ecosystem. </p>
<p>GPU modules includes class <code>cv::cuda::GpuMat</code> which is a primary container for data kept in GPU memory. It’s interface is very similar with <code>cv::Mat</code>, its CPU counterpart. All GPU functions receive GpuMat as input and output arguments. This allows to invoke several GPU algorithms without downloading data. GPU module API interface is also kept similar with CPU interface where possible. So developers who are familiar with Opencv on CPU could start using GPU straightaway.</p>
<p>The GPU module is designed as a host-level API. This means that if you have pre-compiled OpenCV GPU binaries, you are not required to have the CUDA Toolkit installed or write any extra code to make use of the GPU.</p>
<h4 id="CMakeLists-txt"><a href="#CMakeLists-txt" class="headerlink" title="CMakeLists.txt"></a>CMakeLists.txt</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(OpenCV REQUIRED COMPONENTS core highgui imgproc features2d calib3d </span><br><span class="line">	cudaarithm cudabgsegm cudafilters cudaimgproc cudawarping cudafeatures2d <span class="comment"># for cuda-enabled</span></span><br><span class="line">) <span class="comment">#</span></span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; OpenCV_INCLUDE_DIRS = $&#123;OpenCV_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; OpenCV_LIBS = $&#123;OpenCV_LIBS&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="demo-cpp"><a href="#demo-cpp" class="headerlink" title="demo.cpp"></a>demo.cpp</h4><p>In the sample below an image is loaded from local file, next it is uploaded to GPU, thresholded, downloaded and displayed.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/cudaarithm.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/cudabgsegm.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/cudafilters.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/cudaimgproc.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/cudawarping.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/cudafeatures2d.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">test_opencv_gpu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">try</span></span><br><span class="line">	&#123;</span><br><span class="line">		cv::Mat src_host = cv::<span class="built_in">imread</span>(<span class="string">&quot;file.png&quot;</span>, CV_LOAD_IMAGE_GRAYSCALE);</span><br><span class="line">		cv::cuda::GpuMat dst, src;</span><br><span class="line">		src.<span class="built_in">upload</span>(src_host);</span><br><span class="line"></span><br><span class="line">		cv::cuda::<span class="built_in">threshold</span>(src, dst, <span class="number">128.0</span>, <span class="number">255.0</span>, CV_THRESH_BINARY);</span><br><span class="line"></span><br><span class="line">		cv::Mat result_host;</span><br><span class="line">		dst.<span class="built_in">download</span>(result_host);</span><br><span class="line"></span><br><span class="line">		cv::<span class="built_in">imshow</span>(<span class="string">&quot;Result&quot;</span>, result_host);</span><br><span class="line">		cv::<span class="built_in">waitKey</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span> (<span class="type">const</span> cv::Exception&amp; ex)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;Error: &quot;</span> &lt;&lt; ex.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="cpu-vs-gpu-time-cost"><a href="#cpu-vs-gpu-time-cost" class="headerlink" title="cpu vs gpu time cost"></a>cpu vs gpu time cost</h3><ul>
<li>(1)对于分辨率不特别大的图片间的ORB特征匹配，CPU运算得比GPU版的快（由于图像上传到GPU消耗了时间）</li>
<li>(2)但对于分辨率较大的图片，或者GPU比CPU好的机器（比如Nvidia Jetson系列），GPU版的ORB算法比CPU版的程序更高效。</li>
</ul>
<h4 id="problems"><a href="#problems" class="headerlink" title="problems"></a>problems</h4><blockquote>
<p>(1) 使用cuda版本的opencv caffe网络的第一次创建非常耗时，后面的网络创建则非常快。<br><del>(2) opencv的gpu代码比cpu代码慢，初次启动多耗费20s左右</del>。(事实是由于编译的caffe和GPU计算力不匹配导致的)</p>
</blockquote>
<h4 id="reasons"><a href="#reasons" class="headerlink" title="reasons"></a>reasons</h4><blockquote>
<p>Your problem is that CUDA needs to initialize! And it will generally takes between serveral seconds</p>
</blockquote>
<blockquote>
<p>Why first function call is slow?<br>That is because of initialization overheads. On first GPU function call <code>Cuda Runtime API</code> is initialized implicitly.</p>
</blockquote>
<blockquote>
<p>The first gpu function call is always takes more time, because CUDA initialize context for device.<br>The following calls will be faster.</p>
</blockquote>
<blockquote>
<p>Not Reasons:<br>(1) CPU clockspeed is 10x faster than GPU clockspeed.<br>(2) memory transfer times between host (CPU) and device (GPU)  (upload,downloa data)</p>
</blockquote>
<h3 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a>deploy</h3><h4 id="runtime-errors"><a href="#runtime-errors" class="headerlink" title="runtime errors"></a>runtime errors</h4><p>gtx 1060 编译的opencv caffe在gtx 970m上运行出现错误</p>
<p><code>im2col.cu  Check failed: error == cudaSuccess (8 vs. 0) invalid device function</code></p>
<pre><code>    gtx 1060   sm_61
    gtx 970m   sm_52
</code></pre>
<p>im2col 是caffe的源文件，表明<code>gtx 970m</code>的计算能力不支持可执行文件的运行。</p>
<h4 id="reasons-1"><a href="#reasons-1" class="headerlink" title="reasons"></a>reasons</h4><p>see <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17599189/what-is-the-purpose-of-using-multiple-arch-flags-in-nvidias-nvcc-compiler/17599585#17599585">what-is-the-purpose-of-using-multiple-arch-flags-in-nvidias-nvcc-compiler</a></p>
<blockquote>
<p>Roughly speaking, the code compilation flow goes like this: <code>CUDA C/C++ device code source --&gt; PTX --&gt; SASS</code><br>The virtual architecture (e.g. <code>compute_20</code>, whatever is specified by <code>-arch compute</code>…) determines what type of PTX code will be generated. The additional switches (e.g. <code>-code sm_21</code>) determine what type of SASS code will be generated. SASS is actually executable object code for a GPU (machine language). An executable can contain multiple versions of SASS and&#x2F;or PTX, and there is a runtime loader mechanism that will pick appropriate versions based on the GPU actually being used.</p>
</blockquote>
<h4 id="win7-win10-deploy"><a href="#win7-win10-deploy" class="headerlink" title="win7&#x2F;win10 deploy"></a>win7&#x2F;win10 deploy</h4><ul>
<li>compile opencv caffe on windows 10 for GTX 1060</li>
<li>deoply on windows 7 for GTX 1080 Ti successfully</li>
</ul>
<p>for win7, if we install <code>398.82-desktop-win8-win7-64bit-international-whql.exe</code>,errors may occur:</p>
<pre><code>&gt; nvidia-smi.exe 
Failed to initialize NVML: Unknown error
</code></pre>
<p>Solutions: use older drivers <code>385.69</code></p>
<h4 id="linux-window-performance"><a href="#linux-window-performance" class="headerlink" title="linux&#x2F;window performance"></a>linux&#x2F;window performance</h4><blockquote>
<p>(1) api在linux平均耗时3ms;同样的代码在windows平均耗时14ms<br>(2) vs编译开启代码优化前后性能相差接近5倍，125ms vs 25ms<br>(3) cmake编译RELEASE选项默认已经开启了代码优化 -O3</p>
</blockquote>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.opencv.org/3.2.0/d6/d15/tutorial_building_tegra_cuda.html">Building OpenCV for Tegra with CUDA</a></li>
<li><a target="_blank" rel="noopener" href="https://opencv.org/platforms/cuda.html">opencv with cuda introduction</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.opencv.org/2.4/modules/gpu/doc/gpu.html">ref doc for opencv gpu</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.opencv.org/3.1.0/">opencv 3.1.0 doc</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencv/opencv/issues/6716">std::tuple errors when Building OpenCV (Main Branch) for Microsoft VS 2015 (x64) </a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencv/opencv/issues/7992">opencv github issues</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/42122634/building-opencv-3-cuda-errors">building-opencv-3-cuda-errors</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/12074281/why-opencv-gpu-code-is-slower-than-cpu/16038287#16038287">why-opencv-gpu-code-is-slower-than-cpu</a></li>
<li><a target="_blank" rel="noopener" href="http://answers.opencv.org/question/1670/huge-time-to-upload-data-to-gpu/#1676">huge-time-to-upload-data-to-gpu</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/floydhub/dl-docker/issues/12">https://github.com/floydhub/dl-docker/issues/12</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/BVLC/caffe/issues/138">Cuda kernel failed. Error: invalid device function </a></li>
<li><a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#initialization">offical cuda-c-programming-guide</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17599189/what-is-the-purpose-of-using-multiple-arch-flags-in-nvidias-nvcc-compiler/17599585#17599585">what-is-the-purpose-of-using-multiple-arch-flags-in-nvidias-nvcc-compiler</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20180713: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/cpp-caffe-net-run-in-multiple-threads/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/cpp-caffe-net-run-in-multiple-threads/" class="post-title-link" itemprop="url">caffe failed to use gpu in multiple threads, how to fix it ?</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-07-12 13:40:00" itemprop="dateCreated datePublished" datetime="2018-07-12T13:40:00+08:00">2018-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="set-mode"><a href="#set-mode" class="headerlink" title="set_mode"></a>set_mode</h3><p>Caffe fails to use GPU in a new thread ？？？<br>see <a target="_blank" rel="noopener" href="https://github.com/BVLC/caffe/issues/4178">here</a></p>
<pre><code>the `Caffe::mode_` variable that controls this is thread-local,
so ensure you’re calling `caffe.set_mode_gpu()` in each thread
before running any Caffe functions. That should solve your issue.

Caffe set_mode GPU 在多线程下失效
在main thread中设置GPU模式，在worker thread中调用网络进行检测，
GPU模式不起效，默认仍然使用CPU模式，所以速度很慢，和GPU相比慢了
10倍左右。

解决方案：在子线程中set_mode,然后调用网络进行检测。
(1)创建网络在main thread。static 网络存储在全局静态数据区。
worker thread可以直接使用。
(2) 在worker thread中检测，需要在子线程中set_mode,然后调用网络进行检测。

结论：
(1)caffe的set_mode所在的线程必须和使用nets进行forward的线程相同。否则默认使用CPU模式，速度会很慢。
(2)caffe的nets初始化可以在main thread也可以在worker thread。
</code></pre>
<h3 id="code-example"><a href="#code-example" class="headerlink" title="code example"></a>code example</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gtest/gtest.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;glog/logging.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/date_time/posix_time/posix_time.hpp&gt;</span>  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// opencv</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2/imgproc.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;algorithm/algorithm.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> kezunlin::algorithm;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> region net-demo</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">topwire_demo</span><span class="params">(<span class="type">bool</span> run_in_worker_thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (run_in_worker_thread) &#123;</span><br><span class="line">		CaffeApi::<span class="built_in">set_mode</span>(<span class="literal">true</span>, <span class="number">0</span>, <span class="number">1234</span>);<span class="comment">// set in worker thread-1, use GPU-0</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do net detect </span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">railway_demo</span><span class="params">(<span class="type">bool</span> run_in_worker_thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (run_in_worker_thread) &#123;</span><br><span class="line">		CaffeApi::<span class="built_in">set_mode</span>(<span class="literal">true</span>, <span class="number">0</span>, <span class="number">1234</span>);<span class="comment">// set in worker thread-1, use GPU-0</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do net detect </span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sidewall_demo</span><span class="params">(<span class="type">bool</span> run_in_worker_thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (run_in_worker_thread) &#123;</span><br><span class="line">		CaffeApi::<span class="built_in">set_mode</span>(<span class="literal">true</span>, <span class="number">0</span>, <span class="number">1234</span>);<span class="comment">// set in worker thread-1, use GPU-0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do net detect </span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lockcatch_demo</span><span class="params">(<span class="type">bool</span> run_in_worker_thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (run_in_worker_thread) &#123;</span><br><span class="line">		CaffeApi::<span class="built_in">set_mode</span>(<span class="literal">true</span>, <span class="number">0</span>, <span class="number">1234</span>);<span class="comment">// set in worker thread-1, use GPU-0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// do net detect </span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> endregion</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> region worker-thread-demo</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">worker_thread_topwire_demo</span><span class="params">(<span class="type">bool</span> run_in_worker_thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">std::thread <span class="title">thr</span><span class="params">(topwire_demo, run_in_worker_thread)</span></span>;</span><br><span class="line">	thr.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">worker_thread_railway_demo</span><span class="params">(<span class="type">bool</span> run_in_worker_thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">std::thread <span class="title">thr</span><span class="params">(railway_demo, run_in_worker_thread)</span></span>;</span><br><span class="line">	thr.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">worker_thread_sidewall_demo</span><span class="params">(<span class="type">bool</span> run_in_worker_thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">std::thread <span class="title">thr</span><span class="params">(sidewall_demo, run_in_worker_thread)</span></span>;</span><br><span class="line">	thr.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">worker_thread_lockcatch_demo</span><span class="params">(<span class="type">bool</span> run_in_worker_thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">std::thread <span class="title">thr</span><span class="params">(lockcatch_demo, run_in_worker_thread)</span></span>;</span><br><span class="line">	thr.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> endregion</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">DETECT_TYPE</span> &#123;</span><br><span class="line">	SET_IN_MAIN_DETECT_IN_MAIN, <span class="comment">// 主线程set_mode，主线程检测，40ms左右，使用GPU</span></span><br><span class="line">	SET_IN_WORKER_DETECT_IN_WORKER, <span class="comment">// 子线程set_mode，子线程检测，40ms左右，使用GPU</span></span><br><span class="line">	SET_IN_MAIN_DETECT_IN_WORKER <span class="comment">// 主线程set_mode，子线程检测，400ms左右，慢了10倍左右，没有使用GPU</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread_demo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DETECT_TYPE detect_type = SET_IN_MAIN_DETECT_IN_MAIN;</span><br><span class="line">	detect_type = SET_IN_WORKER_DETECT_IN_WORKER;</span><br><span class="line">	detect_type = SET_IN_MAIN_DETECT_IN_WORKER;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">init_algorithm_api</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (detect_type)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> SET_IN_MAIN_DETECT_IN_MAIN:</span><br><span class="line">		<span class="built_in">topwire_demo</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="built_in">railway_demo</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="built_in">sidewall_demo</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="built_in">lockcatch_demo</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> SET_IN_WORKER_DETECT_IN_WORKER:</span><br><span class="line">		<span class="built_in">worker_thread_topwire_demo</span>(<span class="literal">true</span>);</span><br><span class="line">		<span class="built_in">worker_thread_railway_demo</span>(<span class="literal">true</span>);</span><br><span class="line">		<span class="built_in">worker_thread_sidewall_demo</span>(<span class="literal">true</span>);</span><br><span class="line">		<span class="built_in">worker_thread_lockcatch_demo</span>(<span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> SET_IN_MAIN_DETECT_IN_WORKER:</span><br><span class="line">		<span class="built_in">worker_thread_topwire_demo</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="built_in">worker_thread_railway_demo</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="built_in">worker_thread_sidewall_demo</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="built_in">worker_thread_lockcatch_demo</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free_algorithm_api</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_algorithm_api</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">thread_demo</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">TEST</span>(algorithn_test, test_algorithm_api) &#123;</span><br><span class="line">	<span class="built_in">test_algorithm_api</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="conclusions"><a href="#conclusions" class="headerlink" title="conclusions"></a>conclusions</h3><ul>
<li><strong>SET_IN_MAIN_DETECT_IN_MAIN</strong>, &#x2F;&#x2F; 主线程set_mode，主线程检测，40ms左右，使用GPU</li>
<li><strong>SET_IN_WORKER_DETECT_IN_WORKER</strong>, &#x2F;&#x2F; 子线程set_mode，子线程检测，40ms左右，使用GPU</li>
<li><strong>SET_IN_MAIN_DETECT_IN_WORKER</strong> &#x2F;&#x2F; 主线程set_mode，子线程检测，400ms左右，慢了10倍左右，没有使用GPU</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/BVLC/caffe/issues/4178">Caffe fails to use GPU in a new thread</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20180712: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/boost-enable-shared-from-this/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/boost-enable-shared-from-this/" class="post-title-link" itemprop="url">boost enable shared from this</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-23 14:21:00" itemprop="dateCreated datePublished" datetime="2018-05-23T14:21:00+08:00">2018-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Code-Example"><a href="#Code-Example" class="headerlink" title="Code Example"></a>Code Example</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/shared_ptr.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/enable_shared_from_this.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> boost;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">enable_shared_from_this has become part of C++ 11 standard.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">https://blog.csdn.net/csfreebird/article/details/8282518</span></span><br><span class="line"><span class="comment">https://stackoverflow.com/questions/712279/what-is-the-usefulness-of-enable-shared-from-this</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Y</span> : <span class="keyword">public</span> boost::enable_shared_from_this&lt;Y&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="built_in">Y</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Y::Y()&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">Y</span>() </span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Y::~Y()&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">boost::shared_ptr&lt;Y&gt; <span class="title">f</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">shared_from_this</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">boost::shared_ptr&lt;Y&gt; <span class="title">f_dangerous</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;<span class="comment">// lead to multiple release on same resouce</span></span><br><span class="line">		<span class="keyword">return</span> boost::<span class="built_in">shared_ptr</span>&lt;Y&gt;(<span class="keyword">this</span>);  <span class="comment">// don&#x27;t do this!</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_safe</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">boost::shared_ptr&lt;Y&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> Y)</span></span>;</span><br><span class="line">	boost::shared_ptr&lt;Y&gt; q = p-&gt;<span class="built_in">f</span>();</span><br><span class="line">	<span class="built_in">assert</span>(p == q);</span><br><span class="line">	<span class="built_in">assert</span>(!(p &lt; q || q &lt; p)); <span class="comment">// p and q must share ownership</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	Y::Y()</span></span><br><span class="line"><span class="comment">	Y::~Y()</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_dangerous</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">boost::shared_ptr&lt;Y&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> Y)</span></span>;</span><br><span class="line">	boost::shared_ptr&lt;Y&gt; q = p-&gt;<span class="built_in">f_dangerous</span>();</span><br><span class="line">	<span class="built_in">assert</span>(p == q);</span><br><span class="line">	<span class="built_in">assert</span>(!(p &lt; q || q &lt; p)); <span class="comment">// p and q must share ownership</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	Y::Y()</span></span><br><span class="line"><span class="comment">	Y::~Y()</span></span><br><span class="line"><span class="comment">	Y::~Y()</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//test_safe();</span></span><br><span class="line">	<span class="built_in">test_dangerous</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/712279/what-is-the-usefulness-of-enable-shared-from-this">what-is-the-usefulness-of-enable-shared-from-this</a></li>
</ul>
<h1 id="History"><a href="#History" class="headerlink" title="History"></a>History</h1><ul>
<li>20180523: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/boost-asio-example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/boost-asio-example/" class="post-title-link" itemprop="url">boost asio example</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-23 13:24:00" itemprop="dateCreated datePublished" datetime="2018-05-23T13:24:00+08:00">2018-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Code-Example"><a href="#Code-Example" class="headerlink" title="Code Example"></a>Code Example</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/thread.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/bind.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/asio.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/date_time/posix_time/posix_time.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">https://mmoaay.gitbooks.io/boost-asio-cpp-network-programming-chinese/content/Chapter3.html</span></span><br><span class="line"><span class="comment">https://www.boost.org/doc/libs/1_64_0/doc/html/boost_asio/tutorial/tuttimer2/src.html</span></span><br><span class="line"><span class="comment">sync: blocking ,return until job done</span></span><br><span class="line"><span class="comment">async: non-blocking, return immediately</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Timer.1. - Using a timer synchronously</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">snyc_timer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	boost::asio::io_service  io;</span><br><span class="line"></span><br><span class="line">	boost::<span class="function">asio::deadline_timer <span class="title">t</span><span class="params">(io, boost::posix_time::seconds(<span class="number">2</span>))</span></span>;</span><br><span class="line">	t.<span class="built_in">wait</span>(); <span class="comment">//  blocking wait on the timer</span></span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Hello, world!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Timer.2 - Using a timer asynchronously</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print2</span><span class="params">(<span class="type">const</span> boost::system::error_code&amp; <span class="comment">/*e*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;thread #&quot;</span> &lt;&lt; boost::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Hello, world!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">asnyc_timer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	boost::asio::io_service io;</span><br><span class="line"></span><br><span class="line">	boost::<span class="function">asio::deadline_timer <span class="title">t</span><span class="params">(io, boost::posix_time::seconds(<span class="number">2</span>))</span></span>;</span><br><span class="line">	t.<span class="built_in">async_wait</span>(&amp;print2); <span class="comment">// asnyc,non-blocking,return immediately</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	The asio library provides a guarantee that callback handlers will only be called from threads that are currently calling io_service::run(). </span></span><br><span class="line"><span class="comment">	asio库会确保handler会在io_service::run()所在的thread中运行。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;[main thread] #&quot;</span> &lt;&lt; boost::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;here&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	io.<span class="built_in">run</span>();<span class="comment">// sync: blocking ,return until job done</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Timer.3 - Binding arguments to a handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(<span class="type">const</span> boost::system::error_code&amp; <span class="comment">/*e*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	boost::asio::deadline_timer* t, <span class="type">int</span>* count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (*count &lt; <span class="number">5</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; *count &lt;&lt; std::endl;</span><br><span class="line">		++(*count);</span><br><span class="line"></span><br><span class="line">		t-&gt;<span class="built_in">expires_at</span>(t-&gt;<span class="built_in">expires_at</span>() + boost::posix_time::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">		t-&gt;<span class="built_in">async_wait</span>(boost::<span class="built_in">bind</span>(print,</span><br><span class="line">			boost::asio::placeholders::error, t, count));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">asnyc_timer_with_params</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	boost::asio::io_service io;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">	boost::<span class="function">asio::deadline_timer <span class="title">t</span><span class="params">(io, boost::posix_time::seconds(<span class="number">1</span>))</span></span>;</span><br><span class="line">	t.<span class="built_in">async_wait</span>(boost::<span class="built_in">bind</span>(print,</span><br><span class="line">		boost::asio::placeholders::error, &amp;t, &amp;count));</span><br><span class="line"></span><br><span class="line">	io.<span class="built_in">run</span>();</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Final count is &quot;</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Timer.4 - Using a member function as a handler</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">printer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">printer</span>(boost::asio::io_service&amp; io)</span><br><span class="line">		: <span class="built_in">timer_</span>(io, boost::posix_time::<span class="built_in">seconds</span>(<span class="number">1</span>)),</span><br><span class="line">		<span class="built_in">count_</span>(<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		timer_.<span class="built_in">async_wait</span>(boost::<span class="built_in">bind</span>(&amp;printer::print, <span class="keyword">this</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">printer</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;Final count is &quot;</span> &lt;&lt; count_ &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (count_ &lt; <span class="number">5</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; count_ &lt;&lt; std::endl;</span><br><span class="line">			++count_;</span><br><span class="line"></span><br><span class="line">			timer_.<span class="built_in">expires_at</span>(timer_.<span class="built_in">expires_at</span>() + boost::posix_time::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">			timer_.<span class="built_in">async_wait</span>(boost::<span class="built_in">bind</span>(&amp;printer::print, <span class="keyword">this</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;print do nothing...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	boost::asio::deadline_timer timer_;</span><br><span class="line">	<span class="type">int</span> count_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">asnyc_timer_with_class_method</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	boost::asio::io_service io;</span><br><span class="line">	<span class="function">printer <span class="title">p</span><span class="params">(io)</span></span>;</span><br><span class="line">	io.<span class="built_in">run</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Timer.5 - Synchronising handlers in multithreaded programs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">The previous four tutorials avoided the issue of handler synchronisation </span></span><br><span class="line"><span class="comment">by calling the io_service::run() function from one thread only. As you </span></span><br><span class="line"><span class="comment">already know, the asio library provides a guarantee that callback handlers</span></span><br><span class="line"><span class="comment">will only be called from threads that are currently calling io_service::run(). </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Consequently, calling io_service::run() from only one thread ensures that </span></span><br><span class="line"><span class="comment">callback handlers cannot run concurrently.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">By wrapping the handlers using the same boost::asio::strand, we are ensuring</span></span><br><span class="line"><span class="comment">that they cannot execute concurrently.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">在一个thread中调用io_service::run()，能够确保其对应的回调handlers不会并行执行。</span></span><br><span class="line"><span class="comment">但是在A和B两个thread中调用io_service::run()，A对应的handler和B对应的handler会并行执行。</span></span><br><span class="line"><span class="comment">【handler不是线程安全的】</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">如何解决多线程调用io_service::run() 其对应的handler会并行执行的问题？</span></span><br><span class="line"><span class="comment">使用boost::asio::io_service::strand对象。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">An boost::asio::strand guarantees that, for those handlers that are dispatched </span></span><br><span class="line"><span class="comment">through it, an executing handler will be allowed to complete before the next one</span></span><br><span class="line"><span class="comment">is started.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">By wrapping the handlers using the same boost::asio::strand, we are ensuring that</span></span><br><span class="line"><span class="comment">they cannot execute concurrently.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">同一个srand对象，能够确保其wrap的handler能够顺序执行。</span></span><br><span class="line"><span class="comment">即print1和print2在2个线程中不会并行执行。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">printer_sync</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">printer_sync</span>(boost::asio::io_service&amp; io)</span><br><span class="line">		: <span class="built_in">strand_</span>(io),</span><br><span class="line">		<span class="built_in">timer1_</span>(io, boost::posix_time::<span class="built_in">seconds</span>(<span class="number">1</span>)),</span><br><span class="line">		<span class="built_in">timer2_</span>(io, boost::posix_time::<span class="built_in">seconds</span>(<span class="number">1</span>)),</span><br><span class="line">		<span class="built_in">count_</span>(<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		timer1_.<span class="built_in">async_wait</span>(strand_.<span class="built_in">wrap</span>(boost::<span class="built_in">bind</span>(&amp;printer_sync::print1, <span class="keyword">this</span>)));</span><br><span class="line">		timer2_.<span class="built_in">async_wait</span>(strand_.<span class="built_in">wrap</span>(boost::<span class="built_in">bind</span>(&amp;printer_sync::print2, <span class="keyword">this</span>)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">printer_sync</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;Final count is &quot;</span> &lt;&lt; count_ &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">print1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (count_ &lt; <span class="number">10</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;Timer 1: &quot;</span> &lt;&lt; count_ &lt;&lt;<span class="string">&quot;,thread #&quot;</span> &lt;&lt; boost::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">			++count_;</span><br><span class="line"></span><br><span class="line">			timer1_.<span class="built_in">expires_at</span>(timer1_.<span class="built_in">expires_at</span>() + boost::posix_time::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">			timer1_.<span class="built_in">async_wait</span>(strand_.<span class="built_in">wrap</span>(boost::<span class="built_in">bind</span>(&amp;printer_sync::print1, <span class="keyword">this</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;Timer 1:  else &quot;</span> &lt;&lt; count_ &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">print2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (count_ &lt; <span class="number">10</span>)</span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;Timer 2: &quot;</span> &lt;&lt; count_ &lt;&lt; <span class="string">&quot;,thread #&quot;</span> &lt;&lt; boost::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">			++count_;</span><br><span class="line"></span><br><span class="line">			timer2_.<span class="built_in">expires_at</span>(timer2_.<span class="built_in">expires_at</span>() + boost::posix_time::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">			timer2_.<span class="built_in">async_wait</span>(strand_.<span class="built_in">wrap</span>(boost::<span class="built_in">bind</span>(&amp;printer_sync::print2, <span class="keyword">this</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;Timer 2:  else &quot;</span> &lt;&lt; count_ &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	boost::asio::io_service::strand strand_; <span class="comment">// wrap handlers</span></span><br><span class="line">	boost::asio::deadline_timer timer1_;</span><br><span class="line">	boost::asio::deadline_timer timer2_;</span><br><span class="line">	<span class="type">int</span> count_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sync_handlers</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	boost::asio::io_service io;</span><br><span class="line">	<span class="function">printer_sync <span class="title">p</span><span class="params">(io)</span></span>;</span><br><span class="line">	<span class="function">boost::thread <span class="title">t</span><span class="params">(boost::bind(&amp;boost::asio::io_service::run, &amp;io))</span></span>;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;[main thread] #&quot;</span> &lt;&lt; boost::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;[1] begin to run&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	io.<span class="built_in">run</span>(); <span class="comment">// blocking until job done</span></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;[2] after run&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	t.<span class="built_in">join</span>();</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;[3] after join&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//snyc_timer();</span></span><br><span class="line">	<span class="comment">//asnyc_timer();</span></span><br><span class="line">	<span class="comment">//asnyc_timer_with_params();</span></span><br><span class="line">	<span class="comment">//asnyc_timer_with_class_method();</span></span><br><span class="line">	<span class="built_in">sync_handlers</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/1_64_0/doc/html/boost_asio/tutorial/tuttimer2/src.html">boost_asio tutorial</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20180523: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/boost-thread-pool-example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/boost-thread-pool-example/" class="post-title-link" itemprop="url">how to implement thread pool with boost in c++</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-23 13:18:00" itemprop="dateCreated datePublished" datetime="2018-05-23T13:18:00+08:00">2018-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Thread-Pool-with-Boost"><a href="#Thread-Pool-with-Boost" class="headerlink" title="Thread Pool with Boost"></a>Thread Pool with Boost</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>    <span class="comment">//std::cout std::endl</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>      <span class="comment">//std::thread</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span>      <span class="comment">//std::future std::promise</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span>     <span class="comment">//std::ref</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span>      <span class="comment">//std::chrono::seconds</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/thread.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/bind.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/asio.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">ThreadPool</span><span class="params">(<span class="type">size_t</span> size)</span> : work_(io_service_) &#123;</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">			workers_.<span class="built_in">create_thread</span>(</span><br><span class="line">				boost::<span class="built_in">bind</span>(&amp;boost::asio::io_service::run, &amp;io_service_));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">ThreadPool</span>() &#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;~ThreadPool&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		io_service_.<span class="built_in">stop</span>(); <span class="comment">// stop before join_all</span></span><br><span class="line">		workers_.<span class="built_in">join_all</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add new work item to the pool.</span></span><br><span class="line">	<span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> F&gt;</span></span><br><span class="line"><span class="function">	<span class="type">void</span> <span class="title">Enqueue</span><span class="params">(F f)</span> </span>&#123;</span><br><span class="line">		io_service_.<span class="built_in">post</span>(f);</span><br><span class="line">		<span class="comment">//sync, return immediately</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	boost::thread_group workers_;</span><br><span class="line">	boost::asio::io_service io_service_;</span><br><span class="line">	boost::asio::io_service::work work_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">boost::mutex io_mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">count</span><span class="params">(<span class="type">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		boost::<span class="function">mutex::scoped_lock <span class="title">lock</span><span class="params">(io_mutex)</span></span>;</span><br><span class="line">		std::cout &lt;&lt; id &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_thread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">boost::thread <span class="title">thrd1</span><span class="params">(boost::bind(&amp;count, <span class="number">1</span>))</span></span>;</span><br><span class="line">	<span class="function">boost::thread <span class="title">thrd2</span><span class="params">(boost::bind(&amp;count, <span class="number">2</span>))</span></span>;</span><br><span class="line">	thrd<span class="number">1.</span><span class="built_in">join</span>();</span><br><span class="line">	thrd<span class="number">2.</span><span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	boost::<span class="function">mutex::scoped_lock <span class="title">lock</span><span class="params">(io_mutex)</span></span>;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;print() #&quot;</span> &lt;&lt; boost::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;hello &quot;</span> &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">	boost::this_thread::<span class="built_in">sleep</span>(boost::posix_time::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;world &quot;</span> &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_thread_pool</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Create a thread pool of 4 worker threads.</span></span><br><span class="line">	<span class="function">ThreadPool <span class="title">pool</span><span class="params">(<span class="number">4</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Queue a bunch of work items.</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">		pool.<span class="built_in">Enqueue</span>(boost::<span class="built_in">bind</span>(&amp;print, i));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">do_task</span><span class="params">(std::promise&lt;<span class="type">int</span>&gt; &amp;promiseObj)</span> </span>&#123;</span><br><span class="line">	boost::<span class="function">mutex::scoped_lock <span class="title">lock</span><span class="params">(io_mutex)</span></span>;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Inside thread: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Inside thread: sleep 2 seconds... &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">2</span>));</span><br><span class="line">	promiseObj.<span class="built_in">set_value</span>(<span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_future</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::promise&lt;<span class="type">int</span>&gt; promiseObj;</span><br><span class="line">	std::future&lt;<span class="type">int</span>&gt; futureObj = promiseObj.<span class="built_in">get_future</span>();</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;create thread...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	<span class="function">std::thread <span class="title">th</span><span class="params">(do_task, std::ref(promiseObj))</span></span>;</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;futureObj.get() block main thread.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	std::cout &lt;&lt; futureObj.<span class="built_in">get</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	th.<span class="built_in">join</span>();</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;after join&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">std::bind</span></span><br><span class="line"><span class="comment">bind预先绑定的参数需要传具体的变量或值进去，对于预先绑定的参数，是pass-by-value的；[使用std::ref()可以pass by reference]</span></span><br><span class="line"><span class="comment">对于不事先绑定的参数，需要传std::placeholders进去，从_1开始，依次递增。placeholder是pass-by-reference的；</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//test_thread();</span></span><br><span class="line">	<span class="comment">//test_thread_pool();</span></span><br><span class="line">	<span class="built_in">test_future</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000006691692">boost thread pool example</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20180523:  created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/boost-mutex-and-lock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/boost-mutex-and-lock/" class="post-title-link" itemprop="url">boost mutex and lock</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-23 13:00:00" itemprop="dateCreated datePublished" datetime="2018-05-23T13:00:00+08:00">2018-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="basic"><a href="#basic" class="headerlink" title="basic"></a>basic</h3><p>ownership</p>
<ul>
<li>shared ownership</li>
<li>exclusive ownership</li>
<li>upgrade  ownership—&gt;exclusive ownership</li>
</ul>
<p>mutex</p>
<ul>
<li>boost::mutex       enable exclusive access to shared data.</li>
<li>boost::shared_mutex  enable shared access to shared data.</li>
</ul>
<p>lock</p>
<ul>
<li>boost::shared_lock</li>
<li>boost::unique_lock</li>
<li>boost::upgrade_lock</li>
<li>boost::upgrade_to_unique_lock</li>
</ul>
<p>Tips from <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9247085/difference-between-boostunique-lock-and-boostupgrade-lock">difference-between-boostunique-lock-and-boostupgrade-lock</a></p>
<blockquote>
<p>The difference between <code>upgrade_lock</code> and <code>unique_lock</code> is simple. An instance of <code>unique_lock</code> is acquiring a full exclusive ownership of a <code>shared_mutex</code>. This means that no one else can get any type of ownership while the <code>unique_lock</code> is alive.</p>
</blockquote>
<blockquote>
<p>Unlike the <code>unique_lock</code> an instance of <code>upgrade_lock</code> is acquiring an upgrade ownership that exclusive only amongst threads trying to get the same upgrade ownership. All other threads that try to get a shared ownership could acquire it with no conflict until the <code>upgrade_lock</code> is upgraded to unique (with an instance of <code>upgrade_to_unique_lock</code>).</p>
</blockquote>
<blockquote>
<p>The <code>upgrade_lock</code> is useful when some of threads can be readers only and will not try to promote itself to writers. Otherwise (all readers may try to become writers at some point) <code>upgrade_lock</code> will operate as <code>unique_lock</code>.</p>
</blockquote>
<p>conclusions</p>
<ul>
<li><p>thread-A get <code>shared_lock</code>,other threads cannot get <code>unique_lock,upgrade_lock</code>,but can get <code>shared_lock</code>.(multiple-reader)</p>
</li>
<li><p>thread-A get <code>upgrade_lock</code>,other threads cannot get <code>unique_lock,upgrade_lock</code>,but can get <code>shared_lock</code>.</p>
</li>
<li><p><code>upgrade_lock</code> can upgrade to <code>upgrade_to_unique_lock</code>,it’s same as thread-A get <code>unique_lock</code>.</p>
</li>
<li><p>thread-A get <code>unique_lock</code>,other threads cannot get <code>unique_lock,upgrade_lock,shared_lock</code>. (single-writer)</p>
</li>
</ul>
<h3 id="code-example"><a href="#code-example" class="headerlink" title="code example"></a>code example</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/thread.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/bind.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> boost::shared_lock&lt;boost::shared_mutex&gt; <span class="type">read_lock_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> boost::unique_lock&lt;boost::shared_mutex&gt; <span class="type">write_lock_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> boost::upgrade_lock&lt;boost::shared_mutex&gt; <span class="type">upgrade_lock_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> boost::upgrade_to_unique_lock&lt;boost::shared_mutex&gt; <span class="type">upgrade_to_unique_lock_t</span>;</span><br><span class="line"></span><br><span class="line">boost::shared_mutex _access; <span class="comment">// read-write access</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> boost::unique_lock&lt;boost::mutex&gt; <span class="type">exclusive_lock_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> data = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readOnly</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="type">read_lock_t</span>  <span class="title">rdlock</span><span class="params">(_access)</span></span>;</span><br><span class="line">	std::cout &lt;&lt; data &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">writeOnly</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="type">write_lock_t</span>  <span class="title">wtlock</span><span class="params">(_access)</span></span>;</span><br><span class="line">	data = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//=============================================</span></span><br><span class="line"><span class="comment">// reader and writer</span></span><br><span class="line"><span class="comment">//=============================================</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reader</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="type">read_lock_t</span> <span class="title">lock</span><span class="params">(_access)</span></span>;</span><br><span class="line">	<span class="comment">// do work here, without anyone having exclusive access</span></span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; data &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">conditional_writer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="type">upgrade_lock_t</span> <span class="title">lock</span><span class="params">(_access)</span></span>;</span><br><span class="line">	<span class="comment">// do work here, without anyone having exclusive access</span></span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> conditional = <span class="literal">true</span>; <span class="comment">// true/false</span></span><br><span class="line">	<span class="keyword">if</span> (conditional) &#123;</span><br><span class="line">		<span class="function"><span class="type">upgrade_to_unique_lock_t</span> <span class="title">uniqueLock</span><span class="params">(lock)</span></span>;</span><br><span class="line">		<span class="comment">// do work here, but now you have exclusive access</span></span><br><span class="line">		data = <span class="number">100</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// do more work here, without anyone having exclusive access</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">unconditional_writer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="type">write_lock_t</span> <span class="title">lock</span><span class="params">(_access)</span></span>;</span><br><span class="line">	<span class="comment">// do work here, with exclusive access</span></span><br><span class="line">	data = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/1_64_0/doc/html/thread/synchronization.html">synchronization</a><br>-<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/989795/example-for-boost-shared-mutex-multiple-reads-one-write">example-for-boost-shared-mutex-multiple-reads-one-write</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9247085/difference-between-boostunique-lock-and-boostupgrade-lock">difference-between-boostunique-lock-and-boostupgrade-lock</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20180523 created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kezunlin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">181</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">213</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kezunlin</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
