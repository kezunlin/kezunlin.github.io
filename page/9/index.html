<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">


  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-5653382914441020",
      enable_page_level_ads: true
    });
  </script>

  <meta name="google-site-verification" content="WSpJFvfcmIPBX_iK8uPbmCHIy_0f1lvd7ZJpbyad2sA">
  <meta name="yandex-verification" content="808eb057eb8396cc">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kezunlin.me","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Kezunlin&#39;s Blog">
<meta property="og:url" content="https://kezunlin.me/page/9/index.html">
<meta property="og:site_name" content="Kezunlin&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="kezunlin">
<meta property="article:tag" content="linux, c++, python, AI, LLM">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://kezunlin.me/page/9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Kezunlin's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Kezunlin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Kezunlin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Live and Learn</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/linux-command-ref/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/linux-command-ref/" class="post-title-link" itemprop="url">linux command ref</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-30 17:44:00" itemprop="dateCreated datePublished" datetime="2018-11-30T17:44:00+08:00">2018-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="ln"><a href="#ln" class="headerlink" title="ln"></a>ln</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s src dest</span><br><span class="line"></span><br><span class="line"><span class="built_in">ln</span> -s $(<span class="built_in">pwd</span>)/yolo /home/kezunlin/program/darknet/kzl-yolo</span><br></pre></td></tr></table></figure>

<blockquote>
<p>tips: use absolute path to link folder</p>
</blockquote>
<h3 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h3><p>case1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&quot;s/old/new/g&quot;</span> 1.txt</span><br></pre></td></tr></table></figure>

<blockquote>
<p>replace “old” with “new”</p>
</blockquote>
<p>case2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&quot;7,7s/neat_enable\: false/neat_enable\: true/g&quot;</span> _config.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>replace <code>neat_enale: false</code> to <code>neat_enale: true</code></p>
</blockquote>
<p>case3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&quot;s/http:\/\/kezunlin.me/https:\/\/kezunlin.me/g&quot;</span> posts/post1.md</span><br></pre></td></tr></table></figure>
<blockquote>
<p>replace “<a href="http://kezunlin.me/">http://kezunlin.me</a>“ with “<a href="https://kezunlin.me/">https://kezunlin.me</a>“</p>
</blockquote>
<h3 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h3><p>case1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">grep UpsampleParameter . -r --include *.h </span><br><span class="line"></span><br><span class="line">grep UpsampleParameter . -r --include *.proto</span><br><span class="line">./src/caffe/proto/caffe.proto:  optional UpsampleParameter upsample_param = 150;</span><br><span class="line">./src/caffe/proto/caffe.proto:message UpsampleParameter &#123;</span><br></pre></td></tr></table></figure>

<p>case2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -r <span class="string">&quot;http://kezunlin.me&quot;</span> posts/ </span><br><span class="line">posts/post1.md:[here](http://kezunlin.me/post/book)</span><br><span class="line">posts/post2.md:-[here](http://kezunlin.me/post/book)</span><br><span class="line">posts/post2.md:- [img](http://kezunlin.me/post/book)</span><br></pre></td></tr></table></figure>

<p>case3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -rl <span class="string">&quot;http://kezunlin.me&quot;</span> posts </span><br><span class="line">posts/post1.md</span><br><span class="line">posts/post2.md</span><br></pre></td></tr></table></figure>

<p>case4</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&quot;s/http:\/\/kezunlin.me/https:\/\/kezunlin.me/g&quot;</span> `grep -rl <span class="string">&quot;http://kezunlin.me&quot;</span> posts`  </span><br></pre></td></tr></table></figure>

<blockquote>
<p>replace <code>http://kezunlin.me</code> with <code>https://kezunlin.me</code> in all posts files.</p>
</blockquote>
<p>case5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&quot;s/comments\: false/comments\: true/g&quot;</span> _posts/*</span><br></pre></td></tr></table></figure>

<blockquote>
<p>replace <code>comments: false</code> with <code>comments: true</code> in all posts files.</p>
</blockquote>
<p>case6</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep --include=*.py -lr OKUtil .  | xargs </span><br><span class="line"></span><br><span class="line">grep -r -l &lt;old&gt; * | xargs sed -i <span class="string">&#x27;s/&lt;old&gt;/&lt;new&gt;/g&#x27;</span></span><br><span class="line">grep -r -l &lt;OKUtil&gt; * | xargs sed -i <span class="string">&#x27;s/&lt;OKUtil&gt;/&lt;OkoooUtil&gt;/g&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="ldd"><a href="#ldd" class="headerlink" title="ldd"></a>ldd</h3><h4 id="for-so"><a href="#for-so" class="headerlink" title="for so"></a>for so</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ldd test_opencv | awk <span class="string">&#x27;/ =&gt; / &#123; print $3 &#125;&#x27;</span></span><br><span class="line">(0x00007fff309d4000)</span><br><span class="line">/usr/local/lib/libopencv_imgcodecs.so.3.1</span><br><span class="line">/usr/local/lib/libopencv_core.so.3.1</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libstdc++.so.6</span><br><span class="line">/lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">/usr/local/lib/libopencv_imgproc.so.3.1</span><br><span class="line">/usr/local/lib/libjpeg.so.8</span><br><span class="line">/lib/x86_64-linux-gnu/libpng12.so.0</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libtiff.so.5</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libjasper.so.1</span><br><span class="line">/lib/x86_64-linux-gnu/libz.so.1</span><br><span class="line">/lib/x86_64-linux-gnu/libm.so.6</span><br><span class="line">/lib/x86_64-linux-gnu/libpthread.so.0</span><br><span class="line">/lib/x86_64-linux-gnu/libdl.so.2</span><br><span class="line">/lib/x86_64-linux-gnu/librt.so.1</span><br><span class="line">/lib/x86_64-linux-gnu/liblzma.so.5</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libjbig.so.0</span><br></pre></td></tr></table></figure>

<h4 id="for-not-found"><a href="#for-not-found" class="headerlink" title="for not found"></a>for not found</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldd test_opencv | awk <span class="string">&#x27;NF==1 &#123;file=$1&#125; /not found/ &#123; print file, $1 &#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="useful"><a href="#useful" class="headerlink" title="useful"></a>useful</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ldd example_opencv | awk  <span class="string">&#x27;&#123;if (match($3,&quot;/&quot;))&#123; printf(&quot;%s \n&quot;),$3 &#125; &#125;&#x27;</span></span><br><span class="line">/usr/local/lib/libopencv_imgcodecs.so.3.1 </span><br><span class="line">/usr/local/lib/libopencv_core.so.3.1 </span><br><span class="line">/usr/lib/x86_64-linux-gnu/libstdc++.so.6 </span><br><span class="line">/lib/x86_64-linux-gnu/libgcc_s.so.1 </span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6 </span><br><span class="line">/usr/local/lib/libopencv_imgproc.so.3.1 </span><br><span class="line">/usr/local/lib/libjpeg.so.8 </span><br><span class="line">/lib/x86_64-linux-gnu/libpng12.so.0 </span><br><span class="line">/usr/lib/x86_64-linux-gnu/libtiff.so.5 </span><br><span class="line">/usr/lib/x86_64-linux-gnu/libjasper.so.1 </span><br><span class="line">/lib/x86_64-linux-gnu/libz.so.1 </span><br><span class="line">/lib/x86_64-linux-gnu/libm.so.6 </span><br><span class="line">/lib/x86_64-linux-gnu/libpthread.so.0 </span><br><span class="line">/lib/x86_64-linux-gnu/libdl.so.2 </span><br><span class="line">/lib/x86_64-linux-gnu/librt.so.1 </span><br><span class="line">/lib/x86_64-linux-gnu/liblzma.so.5 </span><br><span class="line">/usr/lib/x86_64-linux-gnu/libjbig.so.0 </span><br></pre></td></tr></table></figure>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>



<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><p>login website with json data</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">    -H <span class="string">&quot;Accept: application/json&quot;</span> -H <span class="string">&quot;Content-type: application/json&quot;</span> \</span><br><span class="line">    --data <span class="string">&#x27;&#123;&quot;name&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;21232f297a57a5a743894a0e4a801fc3&quot;&#125;&#x27;</span> \</span><br><span class="line">    http://192.168.0.12:8888/api/login </span><br></pre></td></tr></table></figure>

<blockquote>
<p>md5(admin) &#x3D; 21232f297a57a5a743894a0e4a801fc3</p>
</blockquote>
<p>output </p>
<pre><code>&#123;&quot;rtn&quot;:0,&quot;message&quot;:&quot;OK&quot;,&quot;session_id&quot;:&quot;1406699300@kezunlin.me&quot;&#125;
</code></pre>
<p>query results with <code>session_id</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET \</span><br><span class="line">    -H <span class="string">&quot;session_id: 1406699300@kezunlin.me&quot;</span> \</span><br><span class="line">    http://192.168.0.12:8888/api/book</span><br></pre></td></tr></table></figure>

<p>download file</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -LSso ~/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim</span><br></pre></td></tr></table></figure>

<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><h3 id="check-cpu"><a href="#check-cpu" class="headerlink" title="check cpu"></a>check cpu</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/cpuinfo | grep name | <span class="built_in">cut</span> -f2 -d: | <span class="built_in">uniq</span> -c </span><br><span class="line">        8  Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/cpuinfo | grep physical | <span class="built_in">uniq</span> -c </span><br><span class="line">        1 physical <span class="built_in">id</span>	: 0</span><br><span class="line">        1 address sizes	: 39 bits physical, 48 bits virtual</span><br><span class="line">        1 physical <span class="built_in">id</span>	: 0</span><br><span class="line">        1 address sizes	: 39 bits physical, 48 bits virtual</span><br><span class="line">        1 physical <span class="built_in">id</span>	: 0</span><br><span class="line">        1 address sizes	: 39 bits physical, 48 bits virtual</span><br><span class="line">        1 physical <span class="built_in">id</span>	: 0</span><br><span class="line">        1 address sizes	: 39 bits physical, 48 bits virtual</span><br><span class="line">        1 physical <span class="built_in">id</span>	: 0</span><br><span class="line">        1 address sizes	: 39 bits physical, 48 bits virtual</span><br><span class="line">        1 physical <span class="built_in">id</span>	: 0</span><br><span class="line">        1 address sizes	: 39 bits physical, 48 bits virtual</span><br><span class="line">        1 physical <span class="built_in">id</span>	: 0</span><br><span class="line">        1 address sizes	: 39 bits physical, 48 bits virtual</span><br><span class="line">        1 physical <span class="built_in">id</span>	: 0</span><br><span class="line">        1 address sizes	: 39 bits physical, 48 bits virtual</span><br></pre></td></tr></table></figure>

<h3 id="check-gpu"><a href="#check-gpu" class="headerlink" title="check gpu"></a>check gpu</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">lspci | grep -i vga</span><br><span class="line">    00:02.0 VGA compatible controller: Intel Corporation Device 591b (rev 04)</span><br><span class="line">    01:00.0 VGA compatible controller: NVIDIA Corporation Device 1c20 (rev a1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lspci -v -s 01:00.0</span><br><span class="line">01:00.0 VGA compatible controller: NVIDIA Corporation Device 1c20 (rev a1) (prog-if 00 [VGA controller])</span><br><span class="line">    Subsystem: CLEVO/KAPOK Computer Device 65a1</span><br><span class="line">    Flags: bus master, fast devsel, latency 0, IRQ 130</span><br><span class="line">    Memory at db000000 (32-bit, non-prefetchable) [size=16M]</span><br><span class="line">    Memory at 90000000 (64-bit, prefetchable) [size=256M]</span><br><span class="line">    Memory at a0000000 (64-bit, prefetchable) [size=32M]</span><br><span class="line">    I/O ports at e000 [size=128]</span><br><span class="line">    [virtual] Expansion ROM at dc000000 [disabled] [size=512K]</span><br><span class="line">    Capabilities: &lt;access denied&gt;</span><br><span class="line">    Kernel driver <span class="keyword">in</span> use: nvidia</span><br><span class="line">    Kernel modules: nvidiafb, nouveau, nvidia_396, nvidia_396_drm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nvidia-smi</span><br><span class="line">Tue Feb 12 10:09:14 2019       </span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 396.54                 Driver Version: 396.54                    |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  GeForce GTX 1060    Off  | 00000000:01:00.0 Off |                  N/A |</span><br><span class="line">| N/A   56C    P8     8W /  N/A |    601MiB /  6078MiB |      3%      Default |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">watch -n 1 nvidia-smi</span><br><span class="line"></span><br><span class="line">pip install gpustat</span><br><span class="line">watch --color -n1 gpustat -cpu </span><br></pre></td></tr></table></figure>

<h3 id="multiple-terminal"><a href="#multiple-terminal" class="headerlink" title="multiple terminal"></a>multiple terminal</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gnome-terminal --working-directory=/home --tab --tab --tab</span><br></pre></td></tr></table></figure>

<h3 id="stop-lightdm"><a href="#stop-lightdm" class="headerlink" title="stop lightdm"></a>stop lightdm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install xserver-org</span><br><span class="line"></span><br><span class="line"><span class="comment"># stop desktop</span></span><br><span class="line"><span class="built_in">sudo</span> /etc/init.d/lightdm stop</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> fbterm</span><br></pre></td></tr></table></figure>

<h3 id="changedir-no-effect"><a href="#changedir-no-effect" class="headerlink" title="changedir no effect"></a>changedir no effect</h3><p>changedir.sh </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> /home/firefox  </span><br><span class="line"><span class="built_in">pwd</span>  </span><br></pre></td></tr></table></figure>

<blockquote>
<p>执行的时候是<code>./changedir.sh</code>来执行的，这样执行的话终端会产生一个subshell，subshell去执行脚本，在subshell中已经切换了目录了，但是subshell一旦执行完，马上退出，subshell中的变量和操作全部都收回。回到终端根本就看不到这个过程的变化。</p>
</blockquote>
<p>solution</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ./changedir.sh</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">. changedir.sh</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>source changedir.sh</code>执行，这时候就是直接在终端的shell执行脚本了，没有生成子shell，所以当前终端切换了目录。</p>
</blockquote>
<h3 id="kill-process"><a href="#kill-process" class="headerlink" title="kill process"></a>kill process</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lsof -i:4000</span><br><span class="line">netstat -tunlp | grep 4000</span><br><span class="line"><span class="built_in">kill</span> -9 1234</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6048474/how-to-remember-multiple-tabs-session-in-terminal-alike-ff-session-manager">how-to-remember-multiple-tabs-session-in-terminal-alike-ff-session-manager</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/probonopd/linuxdeployqt">linuxdeployqt git</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20181130: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/compile-dlib-on-ubuntu-16-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/compile-dlib-on-ubuntu-16-04/" class="post-title-link" itemprop="url">compile and install dlib on ubuntu 16.04</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-27 17:33:00" itemprop="dateCreated datePublished" datetime="2018-11-27T17:33:00+08:00">2018-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><a href="https://kezunlin.me/post/654a6d04/">Part 1: compile dlib on windows 10</a></li>
<li><strong><a href="https://kezunlin.me/post/c6ead512/">Part 2: compile dlib on ubuntu 16.04</a></strong></li>
</ul>
<h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/davisking/dlib.git</span><br><span class="line"><span class="built_in">cd</span> dlib &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build </span><br><span class="line">cmake-gui ..</span><br></pre></td></tr></table></figure>

<p>with options </p>
<pre><code>CMAKE_INSTALL_PREFIX /usr/local
CUDA 9.2 + cuDNN 7.1.4
</code></pre>
<p>generate</p>
<pre><code>Found CUDA: /usr/local/cuda (found suitable version &quot;9.2&quot;, minimum required is &quot;7.5&quot;) 
Looking for cuDNN install...
Found cuDNN: /usr/local/cuda/lib64/libcudnn.so
Building a CUDA test project to see if your compiler is compatible with CUDA...
Checking if you have the right version of cuDNN installed.
Enabling CUDA support for dlib.  DLIB WILL USE CUDA
C++11 activated.
</code></pre>
<h3 id="make-and-install"><a href="#make-and-install" class="headerlink" title="make and install"></a>make and install</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j8 </span><br><span class="line">  <span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure>

<p>output </p>
<pre><code>[100%] Linking CXX static library libdlib.a
[100%] Built target dlib
</code></pre>
<blockquote>
<p>generate static library <code>libdlib.a</code> </p>
</blockquote>
<h3 id="CMakeLists-txt"><a href="#CMakeLists-txt" class="headerlink" title="CMakeLists.txt"></a>CMakeLists.txt</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(dlib REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(MSVC)</span><br><span class="line">	<span class="keyword">set</span>(dlib_LIBRARIES <span class="string">&quot;C:/Program Files/dlib/lib/dlib.lib&quot;</span>) <span class="comment"># replace dlib::dlib</span></span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line"><span class="keyword">endif</span>(MSVC)</span><br><span class="line"><span class="comment"># $&#123;dlib_INCLUDE_DIRS&#125; and $&#123;dlib_LIBRARIES&#125; are deprecated, simply use target_link_libraries(your_app dlib::dlib)</span></span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; dlib_INCLUDE_DIRS = $&#123;dlib_INCLUDE_DIRS&#125;&quot;</span>) </span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; dlib_LIBRARIES = $&#123;dlib_LIBRARIES&#125;&quot;</span>)   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(demo demo.cpp)</span><br><span class="line"><span class="comment">#target_link_libraries(demo $&#123;dlib_LIBRARIES&#125;)</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(demo dlib::dlib)</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://kezunlin.me/post/654a6d04/">Part 1: compile dlib on windows 10</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20181127: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/install-pybind11-on-ubuntu-16-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/install-pybind11-on-ubuntu-16-04/" class="post-title-link" itemprop="url">Interfacing C++ and Python with pybind11 on ubuntu 16.04</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-27 17:02:00" itemprop="dateCreated datePublished" datetime="2018-11-27T17:02:00+08:00">2018-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><a href="https://kezunlin.me/post/8b9c051d/">Part 1: Interfacing C++ and Python with pybind11 on windows 10</a></li>
<li><strong><a href="https://kezunlin.me/post/a41adc1/">Part 2: Interfacing C++ and Python with pybind11 on ubuntu 16.04</a></strong></li>
</ul>
<h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><p>requirements:</p>
<ul>
<li>pybind11 v2.3.dev0</li>
<li>python 3.5</li>
</ul>
<h3 id="install-pytest"><a href="#install-pytest" class="headerlink" title="install pytest"></a>install pytest</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pytest </span><br></pre></td></tr></table></figure>

<h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/pybind/pybind11.git</span><br><span class="line"><span class="built_in">cd</span> pybind11</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake-gui ..</span><br></pre></td></tr></table></figure>

<p>with options</p>
<pre><code>PYBIND11_CPP_STANDARD /std:c++11 # default c++14
PYTHON_EXECUTABLE /usr/bin/python3.5
CMAKE_INSTALL_PREFIX /usr/local
</code></pre>
<h3 id="install"><a href="#install" class="headerlink" title="install"></a>install</h3><p>make and install </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j8</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure>

<blockquote>
<p>install to <code>/usr/local/include/pybind11</code> with only <code>include</code> and <code>/usr/local/share/cmake/pybind11</code></p>
</blockquote>
<p>output </p>
<pre><code>Install the project...
-- Install configuration: &quot;MinSizeRel&quot;
-- Installing: /usr/local/include/pybind11
-- Installing: /usr/local/include/pybind11/chrono.h
-- Installing: /usr/local/include/pybind11/eigen.h
-- Installing: /usr/local/include/pybind11/stl.h
-- Installing: /usr/local/include/pybind11/complex.h
-- Installing: /usr/local/include/pybind11/detail
-- Installing: /usr/local/include/pybind11/detail/internals.h
-- Installing: /usr/local/include/pybind11/detail/common.h
-- Installing: /usr/local/include/pybind11/detail/descr.h
-- Installing: /usr/local/include/pybind11/detail/init.h
-- Installing: /usr/local/include/pybind11/detail/class.h
-- Installing: /usr/local/include/pybind11/detail/typeid.h
-- Installing: /usr/local/include/pybind11/common.h
-- Installing: /usr/local/include/pybind11/iostream.h
-- Installing: /usr/local/include/pybind11/buffer_info.h
-- Installing: /usr/local/include/pybind11/attr.h
-- Installing: /usr/local/include/pybind11/numpy.h
-- Installing: /usr/local/include/pybind11/pybind11.h
-- Installing: /usr/local/include/pybind11/operators.h
-- Installing: /usr/local/include/pybind11/options.h
-- Installing: /usr/local/include/pybind11/cast.h
-- Installing: /usr/local/include/pybind11/eval.h
-- Installing: /usr/local/include/pybind11/embed.h
-- Installing: /usr/local/include/pybind11/pytypes.h
-- Installing: /usr/local/include/pybind11/functional.h
-- Installing: /usr/local/include/pybind11/stl_bind.h
-- Installing: /usr/local/share/cmake/pybind11/pybind11Config.cmake
-- Installing: /usr/local/share/cmake/pybind11/pybind11ConfigVersion.cmake
-- Installing: /usr/local/share/cmake/pybind11/FindPythonLibsNew.cmake
-- Installing: /usr/local/share/cmake/pybind11/pybind11Tools.cmake
-- Installing: /usr/local/share/cmake/pybind11/pybind11Targets.cmake
</code></pre>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>



<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><h3 id="pybind11"><a href="#pybind11" class="headerlink" title="pybind11"></a>pybind11</h3><h4 id="CMakeLists-txt"><a href="#CMakeLists-txt" class="headerlink" title="CMakeLists.txt"></a>CMakeLists.txt</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(pybind11 CONFIG REQUIRED)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;pybind11_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">MESSAGE</span>( [MAIN] <span class="string">&quot;Found pybind11 v$&#123;pybind11_VERSION&#125;: $&#123;pybind11_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; pybind11_INCLUDE_DIRS = $&#123;pybind11_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; pybind11_LIBRARIES = $&#123;pybind11_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(examplelib </span><br><span class="line">	<span class="variable">$&#123;HEADER_FILES&#125;</span></span><br><span class="line">	<span class="variable">$&#123;SOURCE_FILES&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span> (examplelib  </span><br><span class="line">	pybind11::module</span><br><span class="line">	<span class="variable">$&#123;xxx_LIBRARIES&#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="embed"><a href="#embed" class="headerlink" title="embed"></a>embed</h3><h4 id="CMakeLists-txt-1"><a href="#CMakeLists-txt-1" class="headerlink" title="CMakeLists.txt"></a>CMakeLists.txt</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(pybind11 CONFIG REQUIRED)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;pybind11_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">MESSAGE</span>( [MAIN] <span class="string">&quot;Found pybind11 v$&#123;pybind11_VERSION&#125;: $&#123;pybind11_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; pybind11_INCLUDE_DIRS = $&#123;pybind11_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">MESSAGE</span>( [Main] <span class="string">&quot; pybind11_LIBRARIES = $&#123;pybind11_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(cpp_use_python cpp_use_python.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(cpp_use_python PRIVATE pybind11::embed)</span><br></pre></td></tr></table></figure>


<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://kezunlin.me/post/8b9c051d/">Part 1: Interfacing C++ and Python with pybind11 on windows 10</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20181127: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/compile-refinedet-on-ubuntu-16-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/compile-refinedet-on-ubuntu-16-04/" class="post-title-link" itemprop="url">compile and install refinedet on ubuntu 16.04</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-27 14:59:00" itemprop="dateCreated datePublished" datetime="2018-11-27T14:59:00+08:00">2018-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/" itemprop="url" rel="index"><span itemprop="name">deep learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><p>RefineDet is based on Caffe.</p>
<p>See <a href="https://kezunlin.me/post/b90033a9/">Install and Configure Caffe on ubuntu 16.04</a></p>
<ul>
<li>ubuntu 16.04 </li>
<li>CUDA 9.2 + cudnn 7.1.4  (for caffe&#x2F;tensorrt&#x2F;anakin)</li>
<li>opencv 3.3.0</li>
<li>python 2.7</li>
<li>caffe (from refinedet)</li>
</ul>
<h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/sfzhang15/RefineDet.git</span><br><span class="line"><span class="built_in">cd</span> RefineDet </span><br><span class="line"><span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; cmake-gui ..</span><br><span class="line"></span><br><span class="line">make -j8 &amp;&amp; make pycaffe</span><br></pre></td></tr></table></figure>

<p>options </p>
<pre><code>USE_CUDNN True
USE_OPENCV True
WITH_PYTHON_LAYER True
BLAS atlas

CMAKE_INSTALL_PREFIX /home/kezunlin/program/refinedet/build/install
</code></pre>
<blockquote>
<p>tips: vim CMakeLists.txt and comment out examples and docs</p>
</blockquote>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#add_subdirectory(examples)</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(python)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(matlab)</span><br><span class="line"><span class="comment">#add_subdirectory(docs)</span></span><br></pre></td></tr></table></figure>

<h4 id="fix-gflags-error"><a href="#fix-gflags-error" class="headerlink" title="fix gflags error"></a>fix gflags error</h4><ul>
<li>caffe&#x2F;include&#x2F;caffe&#x2F;common.hpp</li>
<li>caffe&#x2F;examples&#x2F;mnist&#x2F;convert_mnist_data.cpp</li>
</ul>
<p>Comment out the ifndef</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #ifndef GFLAGS_GFLAGS_H_</span></span><br><span class="line"><span class="keyword">namespace</span> gflags = google;</span><br><span class="line"><span class="comment">// #endif  // GFLAGS_GFLAGS_H_</span></span><br></pre></td></tr></table></figure>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><p>two version:</p>
<ul>
<li>single version</li>
<li>batch version</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">In this example, we will load a RefineDet model and use it to detect objects.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> skimage.io <span class="keyword">as</span> io</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="comment"># Make sure that caffe is on the python path:</span></span><br><span class="line">caffe_root = <span class="string">&#x27;./&#x27;</span></span><br><span class="line">os.chdir(caffe_root)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, os.path.join(caffe_root, <span class="string">&#x27;python&#x27;</span>))</span><br><span class="line"><span class="keyword">import</span> caffe</span><br><span class="line"></span><br><span class="line">classes = [<span class="string">&#x27;background&#x27;</span>, <span class="string">&#x27;person&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter_boxs</span>(<span class="params">boxs, threshold=<span class="number">0.4</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    boxs: 500*6  (xmin,ymin,xmax,ymax,confidence,class_index) </span></span><br><span class="line"><span class="string">                class_index: 0 background, 1 person</span></span><br><span class="line"><span class="string">                confidence: 0-1</span></span><br><span class="line"><span class="string">    return: </span></span><br><span class="line"><span class="string">            new_boxs  `list`  [b1,b2,b3,...]</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    new_boxs = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, boxs.shape[<span class="number">0</span>]):</span><br><span class="line">        xmin,ymin,xmax,ymax,confidence,class_index = boxs[i]</span><br><span class="line">        <span class="comment">#print(type(class_index)) # float32</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(class_index)&gt;<span class="number">0</span> <span class="keyword">and</span> confidence &gt;= threshold:</span><br><span class="line">            box = [<span class="built_in">int</span>(xmin),<span class="built_in">int</span>(ymin),<span class="built_in">int</span>(xmax),<span class="built_in">int</span>(ymax),confidence, <span class="built_in">int</span>(class_index)]</span><br><span class="line">            new_boxs.append(box)</span><br><span class="line">    <span class="keyword">return</span> new_boxs <span class="comment"># list [b1,b2,b3,...]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_results</span>(<span class="params">counter, image_file, boxs, save_fig=<span class="literal">False</span></span>):</span><br><span class="line"></span><br><span class="line">    img = cv2.imread(image_file)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(boxs)):</span><br><span class="line">        xmin,ymin,xmax,ymax,confidence,class_index = boxs[i]</span><br><span class="line"></span><br><span class="line">        name = classes[class_index]</span><br><span class="line">        coords = (xmin, ymin), xmax - xmin, ymax - ymin</span><br><span class="line"></span><br><span class="line">        cv2.rectangle(img, (xmin, ymin), (xmax, ymax), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">3</span>) <span class="comment"># bgr</span></span><br><span class="line">        <span class="comment">#display_text = &#x27;%s: %.2f&#x27; % (name, confidence)</span></span><br><span class="line">        display_text = <span class="string">&#x27;%.2f&#x27;</span> % (confidence)</span><br><span class="line">        cv2.putText(img, display_text, (xmin, ymin-<span class="number">5</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">1</span>, color=(<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>), thickness=<span class="number">2</span>)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> save_fig:</span><br><span class="line">        image_filepath = <span class="string">&#x27;output/&#123;0&#125;_results.jpg&#x27;</span>.<span class="built_in">format</span>(counter)</span><br><span class="line">        cv2.imwrite(image_filepath, img)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Saved: &#x27;</span> + image_filepath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">single</span>():</span><br><span class="line">    caffe.set_device(<span class="number">0</span>)</span><br><span class="line">    caffe.set_mode_gpu()</span><br><span class="line"></span><br><span class="line">    save_dir = <span class="string">&quot;./output&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(save_dir):</span><br><span class="line">        os.mkdir(save_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># load model</span></span><br><span class="line">    model_def = <span class="string">&#x27;models/ResNet/coco/refinedet_resnet101_512x512/deploy.prototxt&#x27;</span></span><br><span class="line">    model_weights = <span class="string">&#x27;models/ResNet/coco/refinedet_resnet101_512x512/coco_refinedet_resnet101_512x512_iter_75000.caffemodel&#x27;</span></span><br><span class="line">    net = caffe.Net(model_def, model_weights, caffe.TEST)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># image preprocessing</span></span><br><span class="line">    img_resize = <span class="number">512</span></span><br><span class="line">    net.blobs[<span class="string">&#x27;data&#x27;</span>].reshape(<span class="number">1</span>, <span class="number">3</span>, img_resize, img_resize)</span><br><span class="line">    data_shape = net.blobs[<span class="string">&#x27;data&#x27;</span>].data.shape</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;data_shape=&quot;</span>, data_shape) <span class="comment"># 1, 3, 512, 512</span></span><br><span class="line">    <span class="comment"># by default, caffe use chw, bgr, 0-255, image-[104, 117, 123] </span></span><br><span class="line">    transformer = caffe.io.Transformer(&#123;<span class="string">&#x27;data&#x27;</span>:data_shape&#125;)</span><br><span class="line">    transformer.set_transpose(<span class="string">&#x27;data&#x27;</span>, (<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)) <span class="comment"># hwc ===&gt; chw</span></span><br><span class="line">    transformer.set_channel_swap(<span class="string">&#x27;data&#x27;</span>, (<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>))  <span class="comment"># rgb===&gt;bgr</span></span><br><span class="line">    transformer.set_raw_scale(<span class="string">&#x27;data&#x27;</span>, <span class="number">255</span>)  <span class="comment"># [0-1]===&gt; [0,255]</span></span><br><span class="line">    transformer.set_mean(<span class="string">&#x27;data&#x27;</span>, np.array([<span class="number">104</span>, <span class="number">117</span>, <span class="number">123</span>]))  <span class="comment"># bgr mean pixel</span></span><br><span class="line">    </span><br><span class="line">    files = [<span class="string">&quot;./images/1.png&quot;</span>, <span class="string">&quot;./images/2.png&quot;</span>]<span class="comment"># 500,7  + 384,7 === 500,7 + 500,7 </span></span><br><span class="line">    <span class="keyword">for</span> index,image_file <span class="keyword">in</span> <span class="built_in">enumerate</span>(files):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;image_file=&quot;</span>, image_file)</span><br><span class="line">        image = caffe.io.load_image(image_file) <span class="comment"># hwc, rgb, 0-1 </span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;image.shape=&quot;</span>, image.shape)</span><br><span class="line"></span><br><span class="line">        transformed_image = transformer.preprocess(<span class="string">&#x27;data&#x27;</span>, image)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;transformed_image.shape=&quot;</span>, transformed_image.shape)</span><br><span class="line"></span><br><span class="line">        net.blobs[<span class="string">&#x27;data&#x27;</span>].data[...] = transformed_image</span><br><span class="line"></span><br><span class="line">        detections = net.forward()[<span class="string">&#x27;detection_out&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;detections.shape = &quot;</span>,detections.shape) <span class="comment"># 1, 1, 500, 7</span></span><br><span class="line">        det_label = detections[<span class="number">0</span>, <span class="number">0</span>, :, <span class="number">1</span>] <span class="comment"># 0 back, 1 -person (now only ==1)</span></span><br><span class="line">        det_conf = detections[<span class="number">0</span>, <span class="number">0</span>, :, <span class="number">2</span>] <span class="comment"># 0-1 </span></span><br><span class="line">        det_xmin = detections[<span class="number">0</span>, <span class="number">0</span>, :, <span class="number">3</span>] * image.shape[<span class="number">1</span>]</span><br><span class="line">        det_ymin = detections[<span class="number">0</span>, <span class="number">0</span>, :, <span class="number">4</span>] * image.shape[<span class="number">0</span>]</span><br><span class="line">        det_xmax = detections[<span class="number">0</span>, <span class="number">0</span>, :, <span class="number">5</span>] * image.shape[<span class="number">1</span>]</span><br><span class="line">        det_ymax = detections[<span class="number">0</span>, <span class="number">0</span>, :, <span class="number">6</span>] * image.shape[<span class="number">0</span>]</span><br><span class="line">        boxs = np.column_stack([det_xmin, det_ymin, det_xmax, det_ymax, det_conf, det_label])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;boxs = &quot;</span>, boxs.shape) <span class="comment"># 500,6</span></span><br><span class="line"></span><br><span class="line">        new_boxs = filter_boxs(boxs)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;new_boxs = &quot;</span>, <span class="built_in">len</span>(new_boxs)) <span class="comment"># 3 boxs</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># show result</span></span><br><span class="line">        save_results(index, image_file, new_boxs, save_fig=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">batch</span>():</span><br><span class="line">    caffe.set_device(<span class="number">0</span>)</span><br><span class="line">    caffe.set_mode_gpu()</span><br><span class="line"></span><br><span class="line">    save_dir = <span class="string">&quot;./output&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(save_dir):</span><br><span class="line">        os.mkdir(save_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># load model</span></span><br><span class="line">    model_def = <span class="string">&#x27;models/ResNet/coco/refinedet_resnet101_512x512/deploy.prototxt&#x27;</span></span><br><span class="line">    model_weights = <span class="string">&#x27;models/ResNet/coco/refinedet_resnet101_512x512/coco_refinedet_resnet101_512x512_iter_75000.caffemodel&#x27;</span></span><br><span class="line">    net = caffe.Net(model_def, model_weights, caffe.TEST)</span><br><span class="line"></span><br><span class="line">    box_count_per_image = <span class="number">500</span> </span><br><span class="line">    <span class="comment">#files = [&quot;./images/2.png&quot;]</span></span><br><span class="line">    files = [<span class="string">&quot;./images/1.png&quot;</span>, <span class="string">&quot;./images/2.png&quot;</span>]<span class="comment"># 500,7  + 384,7 === 500,7 + 500,7 </span></span><br><span class="line">    <span class="comment"># update detection_output_layer.cpp and cu to keep 500 box results</span></span><br><span class="line">    batch_size = <span class="built_in">len</span>(files) </span><br><span class="line">    <span class="comment"># image preprocessing</span></span><br><span class="line">    img_resize = <span class="number">512</span></span><br><span class="line">    net.blobs[<span class="string">&#x27;data&#x27;</span>].reshape(batch_size, <span class="number">3</span>, img_resize, img_resize)</span><br><span class="line">    data_shape = net.blobs[<span class="string">&#x27;data&#x27;</span>].data.shape</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;data_shape=&quot;</span>, data_shape) <span class="comment"># 1, 3, 512, 512</span></span><br><span class="line">    <span class="comment"># by default, caffe use chw, bgr, 0-255, image-[104, 117, 123] </span></span><br><span class="line">    transformer = caffe.io.Transformer(&#123;<span class="string">&#x27;data&#x27;</span>:data_shape&#125;)</span><br><span class="line">    transformer.set_transpose(<span class="string">&#x27;data&#x27;</span>, (<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)) <span class="comment"># hwc ===&gt; chw</span></span><br><span class="line">    transformer.set_channel_swap(<span class="string">&#x27;data&#x27;</span>, (<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>))  <span class="comment"># rgb===&gt;bgr</span></span><br><span class="line">    transformer.set_raw_scale(<span class="string">&#x27;data&#x27;</span>, <span class="number">255</span>)  <span class="comment"># [0-1]===&gt; [0,255]</span></span><br><span class="line">    transformer.set_mean(<span class="string">&#x27;data&#x27;</span>, np.array([<span class="number">104</span>, <span class="number">117</span>, <span class="number">123</span>]))  <span class="comment"># bgr mean pixel</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(files)):</span><br><span class="line">        <span class="comment">#image_file = &quot;./images/1.png&quot;</span></span><br><span class="line">        image_file = files[i]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;image_file=&quot;</span>, image_file)</span><br><span class="line">        image = caffe.io.load_image(image_file) <span class="comment"># hwc, rgb, 0-1 </span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;image.shape=&quot;</span>, image.shape)</span><br><span class="line"></span><br><span class="line">        transformed_image = transformer.preprocess(<span class="string">&#x27;data&#x27;</span>, image)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;transformed_image.shape=&quot;</span>, transformed_image.shape)</span><br><span class="line"></span><br><span class="line">        net.blobs[<span class="string">&#x27;data&#x27;</span>].data[i,:,:,:] = transformed_image</span><br><span class="line"></span><br><span class="line">    detections = net.forward()[<span class="string">&#x27;detection_out&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;detections.shape = &quot;</span>,detections.shape) <span class="comment"># 1, 1, 500+384, 7 ===&gt; 1,1, 1000,7</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(batch_size):</span><br><span class="line">        start = i * box_count_per_image</span><br><span class="line">        end = (i+<span class="number">1</span>) * box_count_per_image</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;start-end: &quot;</span>,start, end)</span><br><span class="line">    </span><br><span class="line">        det_label = detections[<span class="number">0</span>, <span class="number">0</span>, start:end, <span class="number">1</span>] <span class="comment"># 0 back, 1 -person (now only ==1)</span></span><br><span class="line">        <span class="built_in">print</span>(det_label[:<span class="number">10</span>])</span><br><span class="line">        det_conf = detections[<span class="number">0</span>, <span class="number">0</span>, start:end, <span class="number">2</span>] <span class="comment"># 0-1 </span></span><br><span class="line">        det_xmin = detections[<span class="number">0</span>, <span class="number">0</span>, start:end, <span class="number">3</span>] * image.shape[<span class="number">1</span>]</span><br><span class="line">        det_ymin = detections[<span class="number">0</span>, <span class="number">0</span>, start:end, <span class="number">4</span>] * image.shape[<span class="number">0</span>]</span><br><span class="line">        det_xmax = detections[<span class="number">0</span>, <span class="number">0</span>, start:end, <span class="number">5</span>] * image.shape[<span class="number">1</span>]</span><br><span class="line">        det_ymax = detections[<span class="number">0</span>, <span class="number">0</span>, start:end, <span class="number">6</span>] * image.shape[<span class="number">0</span>]</span><br><span class="line">        boxs = np.column_stack([det_xmin, det_ymin, det_xmax, det_ymax, det_conf, det_label])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;boxs = &quot;</span>, boxs.shape) <span class="comment"># 500,6</span></span><br><span class="line"></span><br><span class="line">        new_boxs = filter_boxs(boxs)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;new_boxs = &quot;</span>, <span class="built_in">len</span>(new_boxs)) <span class="comment"># 3 boxs</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># show result</span></span><br><span class="line">        save_results(i, image_file, new_boxs, save_fig=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   <span class="comment">#single()</span></span><br><span class="line">   batch()</span><br></pre></td></tr></table></figure>

<p>output </p>
<pre><code>(&#39;data_shape=&#39;, (2, 3, 512, 512))
(&#39;image_file=&#39;, &#39;./images/1.png&#39;)
(&#39;image.shape=&#39;, (1080, 1920, 3))
(&#39;transformed_image.shape=&#39;, (3, 512, 512))
(&#39;image_file=&#39;, &#39;./images/2.png&#39;)
(&#39;image.shape=&#39;, (1080, 1920, 3))
(&#39;transformed_image.shape=&#39;, (3, 512, 512))
(&#39;detections.shape = &#39;, (1, 1, 1000, 7))
(&#39;start-end: &#39;, 0, 500)
[ 1.  1.  1.  1.  1.  1.  1.  1.  1.  1.]
(&#39;boxs = &#39;, (500, 6))
(&#39;new_boxs = &#39;, 3)
Saved: output/0_results.jpg
(&#39;start-end: &#39;, 500, 1000)
[ 0.  0.  0.  0.  0.  0.  0.  0.  0.  0.]
(&#39;boxs = &#39;, (500, 6))
(&#39;new_boxs = &#39;, 6)
Saved: output/1_results.jpg
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/sfzhang15/RefineDet">RefineDet offical</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20181127: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/yolov1-pascal-label-data/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/yolov1-pascal-label-data/" class="post-title-link" itemprop="url">yolov1 pascal label data</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-26 09:48:00" itemprop="dateCreated datePublished" datetime="2018-11-26T09:48:00+08:00">2018-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/" itemprop="url" rel="index"><span itemprop="name">deep learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="code-example"><a href="#code-example" class="headerlink" title="code example"></a>code example</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> yolo.config <span class="keyword">as</span> cfg</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">1234</span>)  <span class="comment"># for np.random.shuffle(gt_labels)</span></span><br><span class="line"></span><br><span class="line">classes = [<span class="string">&#x27;aeroplane&#x27;</span>, <span class="string">&#x27;bicycle&#x27;</span>, <span class="string">&#x27;bird&#x27;</span>, <span class="string">&#x27;boat&#x27;</span>, <span class="string">&#x27;bottle&#x27;</span>, <span class="string">&#x27;bus&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;chair&#x27;</span>, <span class="string">&#x27;cow&#x27;</span>, <span class="string">&#x27;diningtable&#x27;</span>, <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;horse&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;motorbike&#x27;</span>, <span class="string">&#x27;person&#x27;</span>, <span class="string">&#x27;pottedplant&#x27;</span>, <span class="string">&#x27;sheep&#x27;</span>, <span class="string">&#x27;sofa&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;tvmonitor&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">pascal_voc</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, phase, rebuild=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.devkil_path = os.path.join(cfg.PASCAL_PATH, <span class="string">&#x27;VOCdevkit&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.data_path = os.path.join(<span class="variable language_">self</span>.devkil_path, <span class="string">&#x27;VOC2007&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cache_path = cfg.CACHE_PATH</span><br><span class="line">        <span class="variable language_">self</span>.batch_size = cfg.BATCH_SIZE</span><br><span class="line">        <span class="variable language_">self</span>.image_size = cfg.IMAGE_SIZE</span><br><span class="line">        <span class="variable language_">self</span>.cell_size = cfg.CELL_SIZE</span><br><span class="line">        <span class="variable language_">self</span>.classes = cfg.CLASSES</span><br><span class="line">        <span class="variable language_">self</span>.class_to_ind = <span class="built_in">dict</span>(<span class="built_in">zip</span>(<span class="variable language_">self</span>.classes, <span class="built_in">range</span>(<span class="built_in">len</span>(<span class="variable language_">self</span>.classes))))</span><br><span class="line">        <span class="variable language_">self</span>.flipped = <span class="literal">False</span>  <span class="comment"># cfg.FLIPPED</span></span><br><span class="line">        <span class="variable language_">self</span>.phase = phase</span><br><span class="line">        <span class="variable language_">self</span>.rebuild = rebuild</span><br><span class="line">        <span class="variable language_">self</span>.cursor = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.epoch = <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.gt_labels = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.prepare()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self</span>):</span><br><span class="line">        images = np.zeros(</span><br><span class="line">            (<span class="variable language_">self</span>.batch_size, <span class="variable language_">self</span>.image_size, <span class="variable language_">self</span>.image_size, <span class="number">3</span>))</span><br><span class="line">        labels = np.zeros(</span><br><span class="line">            (<span class="variable language_">self</span>.batch_size, <span class="variable language_">self</span>.cell_size, <span class="variable language_">self</span>.cell_size, <span class="number">25</span>))</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> count &lt; <span class="variable language_">self</span>.batch_size:</span><br><span class="line">            imname = <span class="variable language_">self</span>.gt_labels[<span class="variable language_">self</span>.cursor][<span class="string">&#x27;imname&#x27;</span>]</span><br><span class="line">            flipped = <span class="variable language_">self</span>.gt_labels[<span class="variable language_">self</span>.cursor][<span class="string">&#x27;flipped&#x27;</span>]</span><br><span class="line">            images[count, :, :, :] = <span class="variable language_">self</span>.image_read(imname, flipped)</span><br><span class="line">            labels[count, :, :, :] = <span class="variable language_">self</span>.gt_labels[<span class="variable language_">self</span>.cursor][<span class="string">&#x27;label&#x27;</span>]</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>.cursor += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.cursor &gt;= <span class="built_in">len</span>(<span class="variable language_">self</span>.gt_labels):</span><br><span class="line">                np.random.shuffle(<span class="variable language_">self</span>.gt_labels)</span><br><span class="line">                <span class="variable language_">self</span>.cursor = <span class="number">0</span></span><br><span class="line">                <span class="variable language_">self</span>.epoch += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> images, labels</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">image_read</span>(<span class="params">self, imname, flipped=<span class="literal">False</span></span>):</span><br><span class="line">        image = cv2.imread(imname)</span><br><span class="line">        image = cv2.resize(image, (<span class="variable language_">self</span>.image_size, <span class="variable language_">self</span>.image_size))</span><br><span class="line">        image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB).astype(np.float32)</span><br><span class="line">        image = (image / <span class="number">255.0</span>) * <span class="number">2.0</span> - <span class="number">1.0</span></span><br><span class="line">        <span class="keyword">if</span> flipped:</span><br><span class="line">            image = image[:, ::-<span class="number">1</span>, :]</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">prepare</span>(<span class="params">self</span>):</span><br><span class="line">        gt_labels = <span class="variable language_">self</span>.load_labels()</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.flipped:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Appending horizontally-flipped training examples ...&#x27;</span>)</span><br><span class="line">            <span class="comment"># keep y; flip x;</span></span><br><span class="line">            gt_labels_cp = copy.deepcopy(gt_labels)</span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(gt_labels_cp)):</span><br><span class="line">                gt_labels_cp[idx][<span class="string">&#x27;flipped&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                gt_labels_cp[idx][<span class="string">&#x27;label&#x27;</span>] = \</span><br><span class="line">                    gt_labels_cp[idx][<span class="string">&#x27;label&#x27;</span>][:, ::-<span class="number">1</span>, :]  <span class="comment"># flip x grid index  [0,1,2,3,4,5,6] ===&gt;[6,5,4,3,2,1,0]</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.cell_size):</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.cell_size):</span><br><span class="line">                        <span class="keyword">if</span> gt_labels_cp[idx][<span class="string">&#x27;label&#x27;</span>][i, j, <span class="number">0</span>] == <span class="number">1</span>:</span><br><span class="line">                            gt_labels_cp[idx][<span class="string">&#x27;label&#x27;</span>][i, j, <span class="number">1</span>] = \</span><br><span class="line">                                <span class="variable language_">self</span>.image_size - <span class="number">1</span> - \</span><br><span class="line">                                gt_labels_cp[idx][<span class="string">&#x27;label&#x27;</span>][i, j, <span class="number">1</span>]  <span class="comment"># cx = 448 -1 - cx  flipped cx</span></span><br><span class="line">            gt_labels += gt_labels_cp</span><br><span class="line">        np.random.shuffle(gt_labels)  <span class="comment"># shuffle labels</span></span><br><span class="line">        <span class="variable language_">self</span>.gt_labels = gt_labels</span><br><span class="line">        <span class="keyword">return</span> gt_labels</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_labels</span>(<span class="params">self</span>):</span><br><span class="line">        cache_file = os.path.join(</span><br><span class="line">            <span class="variable language_">self</span>.cache_path, <span class="string">&#x27;pascal_&#x27;</span> + <span class="variable language_">self</span>.phase + <span class="string">&#x27;_gt_labels.pkl&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(cache_file) <span class="keyword">and</span> <span class="keyword">not</span> <span class="variable language_">self</span>.rebuild:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Loading gt_labels from: &#x27;</span> + cache_file)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(cache_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                gt_labels = pickle.load(f)</span><br><span class="line">            <span class="keyword">return</span> gt_labels</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Processing gt_labels from: &#x27;</span> + <span class="variable language_">self</span>.data_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="variable language_">self</span>.cache_path):</span><br><span class="line">            os.makedirs(<span class="variable language_">self</span>.cache_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.phase == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">            txtname = os.path.join(</span><br><span class="line">                <span class="variable language_">self</span>.data_path, <span class="string">&#x27;ImageSets&#x27;</span>, <span class="string">&#x27;Main&#x27;</span>, <span class="string">&#x27;trainval.txt&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            txtname = os.path.join(</span><br><span class="line">                <span class="variable language_">self</span>.data_path, <span class="string">&#x27;ImageSets&#x27;</span>, <span class="string">&#x27;Main&#x27;</span>, <span class="string">&#x27;test.txt&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(txtname, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="variable language_">self</span>.image_index = [x.strip() <span class="keyword">for</span> x <span class="keyword">in</span> f.readlines()]  <span class="comment"># 5011 lines</span></span><br><span class="line"></span><br><span class="line">        gt_labels = []</span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> <span class="variable language_">self</span>.image_index:</span><br><span class="line">            label, num = <span class="variable language_">self</span>.load_pascal_annotation(index)</span><br><span class="line">            <span class="keyword">if</span> num == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            imname = os.path.join(<span class="variable language_">self</span>.data_path, <span class="string">&#x27;JPEGImages&#x27;</span>, index + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">            gt_labels.append(&#123;<span class="string">&#x27;imname&#x27;</span>: imname,</span><br><span class="line">                              <span class="string">&#x27;label&#x27;</span>: label,</span><br><span class="line">                              <span class="string">&#x27;flipped&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Saving gt_labels to: &#x27;</span> + cache_file)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(cache_file, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            pickle.dump(gt_labels, f)</span><br><span class="line">        <span class="keyword">return</span> gt_labels</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_pascal_annotation</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Load image and bounding boxes info from XML file in the PASCAL VOC</span></span><br><span class="line"><span class="string">        format.   002939</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        imname = os.path.join(<span class="variable language_">self</span>.data_path, <span class="string">&#x27;JPEGImages&#x27;</span>, index + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">        im = cv2.imread(imname)</span><br><span class="line">        h_ratio = <span class="number">1.0</span> * <span class="variable language_">self</span>.image_size / im.shape[<span class="number">0</span>]</span><br><span class="line">        w_ratio = <span class="number">1.0</span> * <span class="variable language_">self</span>.image_size / im.shape[<span class="number">1</span>]</span><br><span class="line">        <span class="comment"># im = cv2.resize(im, [self.image_size, self.image_size])</span></span><br><span class="line"></span><br><span class="line">        label = np.zeros((<span class="variable language_">self</span>.cell_size, <span class="variable language_">self</span>.cell_size, <span class="number">25</span>))  <span class="comment"># 7,7,25</span></span><br><span class="line">        filename = os.path.join(<span class="variable language_">self</span>.data_path, <span class="string">&#x27;Annotations&#x27;</span>, index + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">        tree = ET.parse(filename)</span><br><span class="line">        objs = tree.findall(<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> objs:</span><br><span class="line">            bbox = obj.find(<span class="string">&#x27;bndbox&#x27;</span>)  <span class="comment"># xmin,ymin,xmax,ymax  1-based ===&gt; 0-based</span></span><br><span class="line">            <span class="comment"># Make pixel indexes 0-based</span></span><br><span class="line">            x1 = <span class="built_in">max</span>(<span class="built_in">min</span>((<span class="built_in">float</span>(bbox.find(<span class="string">&#x27;xmin&#x27;</span>).text) - <span class="number">1</span>) * w_ratio, <span class="variable language_">self</span>.image_size - <span class="number">1</span>), <span class="number">0</span>)</span><br><span class="line">            y1 = <span class="built_in">max</span>(<span class="built_in">min</span>((<span class="built_in">float</span>(bbox.find(<span class="string">&#x27;ymin&#x27;</span>).text) - <span class="number">1</span>) * h_ratio, <span class="variable language_">self</span>.image_size - <span class="number">1</span>), <span class="number">0</span>)</span><br><span class="line">            x2 = <span class="built_in">max</span>(<span class="built_in">min</span>((<span class="built_in">float</span>(bbox.find(<span class="string">&#x27;xmax&#x27;</span>).text) - <span class="number">1</span>) * w_ratio, <span class="variable language_">self</span>.image_size - <span class="number">1</span>), <span class="number">0</span>)</span><br><span class="line">            y2 = <span class="built_in">max</span>(<span class="built_in">min</span>((<span class="built_in">float</span>(bbox.find(<span class="string">&#x27;ymax&#x27;</span>).text) - <span class="number">1</span>) * h_ratio, <span class="variable language_">self</span>.image_size - <span class="number">1</span>), <span class="number">0</span>)</span><br><span class="line">            cls_ind = <span class="variable language_">self</span>.class_to_ind[obj.find(<span class="string">&#x27;name&#x27;</span>).text.lower().strip()]</span><br><span class="line">            boxes = [(x2 + x1) / <span class="number">2.0</span>, (y2 + y1) / <span class="number">2.0</span>, x2 - x1, y2 - y1]  <span class="comment"># cx,cy,w,h   [0-447]</span></span><br><span class="line">            x_ind = <span class="built_in">int</span>(boxes[<span class="number">0</span>] * <span class="variable language_">self</span>.cell_size / <span class="variable language_">self</span>.image_size)  <span class="comment"># grid x,y index  [0-6]</span></span><br><span class="line">            y_ind = <span class="built_in">int</span>(boxes[<span class="number">1</span>] * <span class="variable language_">self</span>.cell_size / <span class="variable language_">self</span>.image_size)</span><br><span class="line">            <span class="keyword">if</span> label[y_ind, x_ind, <span class="number">0</span>] == <span class="number">1</span>:  <span class="comment"># if multiple objects fall in same grid, we only use the first one</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            label[y_ind, x_ind, <span class="number">0</span>] = <span class="number">1</span>  <span class="comment"># has object  1 or 0</span></span><br><span class="line">            label[y_ind, x_ind, <span class="number">1</span>:<span class="number">5</span>] = boxes  <span class="comment"># boxs (cx,cy,w,h)  [0-447]</span></span><br><span class="line">            label[y_ind, x_ind, <span class="number">5</span> + cls_ind] = <span class="number">1</span>  <span class="comment"># class   20-one-hot-vector</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> label, <span class="built_in">len</span>(objs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">3 , 4 =  [0. 0. 0. 0. 0.]</span></span><br><span class="line"><span class="string">3 , 5 =  [  1.    325.248 229.6   111.104 228.48 ]</span></span><br><span class="line"><span class="string">    class_one_hot =  [0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]</span></span><br><span class="line"><span class="string">    class_index =  8</span></span><br><span class="line"><span class="string">    class_name =  chair</span></span><br><span class="line"><span class="string">3 , 6 =  [0. 0. 0. 0. 0.]</span></span><br><span class="line"><span class="string">4 , 0 =  [0. 0. 0. 0. 0.]</span></span><br><span class="line"><span class="string">4 , 1 =  [0. 0. 0. 0. 0.]</span></span><br><span class="line"><span class="string">4 , 2 =  [  1.    132.16  288.4   172.928 316.96 ]</span></span><br><span class="line"><span class="string">    class_one_hot =  [0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]</span></span><br><span class="line"><span class="string">    class_index =  8</span></span><br><span class="line"><span class="string">    class_name =  chair</span></span><br><span class="line"><span class="string">4 , 3 =  [0. 0. 0. 0. 0.]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">data[&#x27;label&#x27;].shape # 7,7,25  (confidence+ (x,y,w,h) + 20-classes)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">confidence: 1 if gt_box center falls in this grid, otherwise 0</span></span><br><span class="line"><span class="string">box(x,y,w,h): gt_box center x,y,w,h; otherwize [0,0,0,0]</span></span><br><span class="line"><span class="string">class: 20-one-hot-vector if gt_box; othersize [0]*20</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">how flip works: flip x dim</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(1) flip grid x-dim:  data[&#x27;label&#x27;] = data[&#x27;label&#x27;][:, ::-1, :]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">y-grid = y-grid  [0,1,2,3,4,5,6]</span></span><br><span class="line"><span class="string">x-grid flip      [0,1,2,3,4,5,6] ===&gt;[6,5,4,3,2,1,0]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(2) flip data[&#x27;label&#x27;]</span></span><br><span class="line"><span class="string">confidence = confidence</span></span><br><span class="line"><span class="string">cx:  flip cx = 417-cx:   data[&#x27;label&#x27;][i, j, 1] = 448 - 1 - data[&#x27;label&#x27;][i, j, 1]</span></span><br><span class="line"><span class="string">cy = cy</span></span><br><span class="line"><span class="string">w = w</span></span><br><span class="line"><span class="string">h = h</span></span><br><span class="line"><span class="string">class = class</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_data</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="comment"># grid y,x</span></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">            <span class="built_in">print</span>(y, <span class="string">&quot;,&quot;</span>, x, <span class="string">&quot;= &quot;</span>, data[<span class="string">&#x27;label&#x27;</span>][y, x, :<span class="number">5</span>])</span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&#x27;label&#x27;</span>][y, x, <span class="number">0</span>] &gt; <span class="number">0</span>:  <span class="comment"># confidence &gt;0</span></span><br><span class="line">                class_one_hot = data[<span class="string">&#x27;label&#x27;</span>][y, x, <span class="number">5</span>:]  <span class="comment"># (20)</span></span><br><span class="line">                class_index = np.argmax(class_one_hot)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;    class_one_hot = &quot;</span>, class_one_hot)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;    class_index = &quot;</span>, class_index)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;    class_name = &quot;</span>, classes[class_index])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flip_data</span>(<span class="params">data</span>):</span><br><span class="line">    data[<span class="string">&#x27;flipped&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">    data[<span class="string">&#x27;label&#x27;</span>] = data[<span class="string">&#x27;label&#x27;</span>][:, ::-<span class="number">1</span>, :]</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&#x27;label&#x27;</span>][y, x, <span class="number">0</span>] == <span class="number">1</span>:</span><br><span class="line">                data[<span class="string">&#x27;label&#x27;</span>][y, x, <span class="number">1</span>] = <span class="number">448</span> - <span class="number">1</span> - data[<span class="string">&#x27;label&#x27;</span>][y, x, <span class="number">1</span>]  <span class="comment"># cx = 448 -1 - cx  flipped cx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_image</span>(<span class="params">filename</span>):</span><br><span class="line">    image = cv2.imread(filename)</span><br><span class="line">    <span class="comment"># convert from BGR to RGB</span></span><br><span class="line">    rgb_image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)</span><br><span class="line">    plt.axis(<span class="string">&quot;off&quot;</span>)</span><br><span class="line">    plt.imshow(rgb_image)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================PASCAL=================================&quot;</span>)</span><br><span class="line">pascal = pascal_voc(<span class="string">&#x27;train&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(pascal.class_to_ind)  <span class="comment"># dict 20</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(pascal.gt_labels))  <span class="comment"># list: default 5011; flipped 10022</span></span><br><span class="line">data = pascal.gt_labels[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(data.keys())  <span class="comment"># dict_keys([&#x27;flipped&#x27;, &#x27;imname&#x27;, &#x27;label&#x27;])</span></span><br><span class="line"><span class="built_in">print</span>(data[<span class="string">&#x27;imname&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(data[<span class="string">&#x27;label&#x27;</span>].shape)  <span class="comment"># 7,7,25  (confidence+ (x,y,w,h) + 20-classes)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(classes)</span><br><span class="line">show_image(data[<span class="string">&#x27;imname&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;========================DATA=================================&quot;</span>)</span><br><span class="line">print_data(data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;=========================FLIPPED================================&quot;</span>)</span><br><span class="line"><span class="comment"># flip data</span></span><br><span class="line">flipped = copy.deepcopy(data)</span><br><span class="line">flip_data(flipped)</span><br><span class="line">print_data(flipped)</span><br></pre></td></tr></table></figure>

<pre><code>Loading gt_labels from: data\pascal_voc\cache\pascal_train_gt_labels.pkl
&#123;&#39;dog&#39;: 11, &#39;train&#39;: 18, &#39;bus&#39;: 5, &#39;motorbike&#39;: 13, &#39;aeroplane&#39;: 0, &#39;bicycle&#39;: 1, &#39;person&#39;: 14, &#39;horse&#39;: 12, &#39;bird&#39;: 2, &#39;tvmonitor&#39;: 19, &#39;sheep&#39;: 16, &#39;boat&#39;: 3, &#39;car&#39;: 6, &#39;diningtable&#39;: 10, &#39;pottedplant&#39;: 15, &#39;sofa&#39;: 17, &#39;bottle&#39;: 4, &#39;chair&#39;: 8, &#39;cat&#39;: 7, &#39;cow&#39;: 9&#125;
5011
dict_keys([&#39;flipped&#39;, &#39;label&#39;, &#39;imname&#39;])
data\pascal_voc\VOCdevkit\VOC2007\JPEGImages\002939.jpg
(7, 7, 25)
[&#39;aeroplane&#39;, &#39;bicycle&#39;, &#39;bird&#39;, &#39;boat&#39;, &#39;bottle&#39;, &#39;bus&#39;, &#39;car&#39;, &#39;cat&#39;, &#39;chair&#39;, &#39;cow&#39;, &#39;diningtable&#39;, &#39;dog&#39;, &#39;horse&#39;, &#39;motorbike&#39;, &#39;person&#39;, &#39;pottedplant&#39;, &#39;sheep&#39;, &#39;sofa&#39;, &#39;train&#39;, &#39;tvmonitor&#39;]
</code></pre>
<p><img src="https://kezunlin.me/images/posts/635233-20181126095114817-1975881555.png" alt="png"></p>
<pre><code>========================DATA=================================
0 , 0 =  [0. 0. 0. 0. 0.]
0 , 1 =  [0. 0. 0. 0. 0.]
0 , 2 =  [0. 0. 0. 0. 0.]
0 , 3 =  [0. 0. 0. 0. 0.]
0 , 4 =  [0. 0. 0. 0. 0.]
0 , 5 =  [0. 0. 0. 0. 0.]
0 , 6 =  [0. 0. 0. 0. 0.]
1 , 0 =  [0. 0. 0. 0. 0.]
1 , 1 =  [0. 0. 0. 0. 0.]
1 , 2 =  [0. 0. 0. 0. 0.]
1 , 3 =  [0. 0. 0. 0. 0.]
1 , 4 =  [0. 0. 0. 0. 0.]
1 , 5 =  [0. 0. 0. 0. 0.]
1 , 6 =  [0. 0. 0. 0. 0.]
2 , 0 =  [0. 0. 0. 0. 0.]
2 , 1 =  [0. 0. 0. 0. 0.]
2 , 2 =  [0. 0. 0. 0. 0.]
2 , 3 =  [0. 0. 0. 0. 0.]
2 , 4 =  [0. 0. 0. 0. 0.]
2 , 5 =  [0. 0. 0. 0. 0.]
2 , 6 =  [0. 0. 0. 0. 0.]
3 , 0 =  [0. 0. 0. 0. 0.]
3 , 1 =  [  1.          70.336      202.496       74.368      149.33333333]
    class_one_hot =  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 1.]
    class_index =  19
    class_name =  tvmonitor
3 , 2 =  [0. 0. 0. 0. 0.]
3 , 3 =  [0. 0. 0. 0. 0.]
3 , 4 =  [  1.         267.456      229.97333333  29.568       77.65333333]
    class_one_hot =  [0. 0. 0. 0. 1. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
    class_index =  4
    class_name =  bottle
3 , 5 =  [0. 0. 0. 0. 0.]
3 , 6 =  [0. 0. 0. 0. 0.]
4 , 0 =  [0. 0. 0. 0. 0.]
4 , 1 =  [0. 0. 0. 0. 0.]
4 , 2 =  [0. 0. 0. 0. 0.]
4 , 3 =  [  1.         220.864      283.136      158.592      327.33866667]
    class_one_hot =  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 0. 0. 0. 0.]
    class_index =  14
    class_name =  person
4 , 4 =  [0. 0. 0. 0. 0.]
4 , 5 =  [0. 0. 0. 0. 0.]
4 , 6 =  [0. 0. 0. 0. 0.]
5 , 0 =  [0. 0. 0. 0. 0.]
5 , 1 =  [0. 0. 0. 0. 0.]
5 , 2 =  [0. 0. 0. 0. 0.]
5 , 3 =  [0. 0. 0. 0. 0.]
5 , 4 =  [  1.         283.584      337.49333333  92.288      185.17333333]
    class_one_hot =  [0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
    class_index =  8
    class_name =  chair
5 , 5 =  [0. 0. 0. 0. 0.]
5 , 6 =  [0. 0. 0. 0. 0.]
6 , 0 =  [0. 0. 0. 0. 0.]
6 , 1 =  [0. 0. 0. 0. 0.]
6 , 2 =  [0. 0. 0. 0. 0.]
6 , 3 =  [0. 0. 0. 0. 0.]
6 , 4 =  [0. 0. 0. 0. 0.]
6 , 5 =  [0. 0. 0. 0. 0.]
6 , 6 =  [0. 0. 0. 0. 0.]
=========================FLIPPED================================
0 , 0 =  [0. 0. 0. 0. 0.]
0 , 1 =  [0. 0. 0. 0. 0.]
0 , 2 =  [0. 0. 0. 0. 0.]
0 , 3 =  [0. 0. 0. 0. 0.]
0 , 4 =  [0. 0. 0. 0. 0.]
0 , 5 =  [0. 0. 0. 0. 0.]
0 , 6 =  [0. 0. 0. 0. 0.]
1 , 0 =  [0. 0. 0. 0. 0.]
1 , 1 =  [0. 0. 0. 0. 0.]
1 , 2 =  [0. 0. 0. 0. 0.]
1 , 3 =  [0. 0. 0. 0. 0.]
1 , 4 =  [0. 0. 0. 0. 0.]
1 , 5 =  [0. 0. 0. 0. 0.]
1 , 6 =  [0. 0. 0. 0. 0.]
2 , 0 =  [0. 0. 0. 0. 0.]
2 , 1 =  [0. 0. 0. 0. 0.]
2 , 2 =  [0. 0. 0. 0. 0.]
2 , 3 =  [0. 0. 0. 0. 0.]
2 , 4 =  [0. 0. 0. 0. 0.]
2 , 5 =  [0. 0. 0. 0. 0.]
2 , 6 =  [0. 0. 0. 0. 0.]
3 , 0 =  [0. 0. 0. 0. 0.]
3 , 1 =  [0. 0. 0. 0. 0.]
3 , 2 =  [  1.         179.544      229.97333333  29.568       77.65333333]
    class_one_hot =  [0. 0. 0. 0. 1. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
    class_index =  4
    class_name =  bottle
3 , 3 =  [0. 0. 0. 0. 0.]
3 , 4 =  [0. 0. 0. 0. 0.]
3 , 5 =  [  1.         376.664      202.496       74.368      149.33333333]
    class_one_hot =  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 1.]
    class_index =  19
    class_name =  tvmonitor
3 , 6 =  [0. 0. 0. 0. 0.]
4 , 0 =  [0. 0. 0. 0. 0.]
4 , 1 =  [0. 0. 0. 0. 0.]
4 , 2 =  [0. 0. 0. 0. 0.]
4 , 3 =  [  1.         226.136      283.136      158.592      327.33866667]
    class_one_hot =  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 0. 0. 0. 0.]
    class_index =  14
    class_name =  person
4 , 4 =  [0. 0. 0. 0. 0.]
4 , 5 =  [0. 0. 0. 0. 0.]
4 , 6 =  [0. 0. 0. 0. 0.]
5 , 0 =  [0. 0. 0. 0. 0.]
5 , 1 =  [0. 0. 0. 0. 0.]
5 , 2 =  [  1.         163.416      337.49333333  92.288      185.17333333]
    class_one_hot =  [0. 0. 0. 0. 0. 0. 0. 0. 1. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
    class_index =  8
    class_name =  chair
5 , 3 =  [0. 0. 0. 0. 0.]
5 , 4 =  [0. 0. 0. 0. 0.]
5 , 5 =  [0. 0. 0. 0. 0.]
5 , 6 =  [0. 0. 0. 0. 0.]
6 , 0 =  [0. 0. 0. 0. 0.]
6 , 1 =  [0. 0. 0. 0. 0.]
6 , 2 =  [0. 0. 0. 0. 0.]
6 , 3 =  [0. 0. 0. 0. 0.]
6 , 4 =  [0. 0. 0. 0. 0.]
6 , 5 =  [0. 0. 0. 0. 0.]
6 , 6 =  [0. 0. 0. 0. 0.]
</code></pre>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20181126: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/yolov1-network-predict-output-data/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/yolov1-network-predict-output-data/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-26 00:00:00" itemprop="dateCreated datePublished" datetime="2018-11-26T00:00:00+08:00">2018-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/c-cuda-programming-tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/c-cuda-programming-tutorial/" class="post-title-link" itemprop="url">tutorial to cuda programming with C++</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-21 14:56:00" itemprop="dateCreated datePublished" datetime="2018-11-21T14:56:00+08:00">2018-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><strong><a href="https://kezunlin.me/post/7d7131f4/">Part 1:cpp cuda programming tutorial</a></strong></li>
<li><a href="https://kezunlin.me/post/ee123cac/">Part 2: cuda activation kernels</a></li>
<li><a href="https://kezunlin.me/post/ad5c5bd9/">Part 3: cublasSgemm for large matrix multiplication on gpu</a></li>
</ul>
<h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="introduction"><a href="#introduction" class="headerlink" title="introduction"></a>introduction</h3><p>在异构计算架构中，GPU与CPU通过PCIe总线连接在一起来协同工作，CPU所在位置称为为主机端（host），而GPU所在位置称为设备端（device），如下图所示。<br><img src="https://kezunlin.me/images/posts/635233-20181121153034561-963659165.png" alt="host device"></p>
<p>基于CPU+GPU的异构计算平台可以优势互补，CPU负责处理逻辑复杂的串行程序，而GPU重点处理数据密集型的并行计算程序，从而发挥最大功效。<br><img src="https://kezunlin.me/images/posts/635233-20181121153038252-126700564.png" alt="workflow"></p>
<h3 id="CUDA编程模型基础"><a href="#CUDA编程模型基础" class="headerlink" title="CUDA编程模型基础"></a>CUDA编程模型基础</h3><ul>
<li>host: CPU,Memory</li>
<li>device:  GPU,Memory</li>
</ul>
<p>CUDA程序中既包含host程序，又包含device程序，它们分别在CPU和GPU上运行。同时，host与device之间可以进行通信，这样它们之间可以进行数据拷贝。典型的CUDA程序的执行流程如下：</p>
<ol>
<li>分配host内存，并进行数据初始化；</li>
<li>分配device内存，并从host将数据拷贝到device上；</li>
<li>调用CUDA的核函数(kernel function)在device上完成指定的运算；</li>
<li>将device上的运算结果拷贝到host上；</li>
<li>释放device和host上分配的内存。</li>
</ol>
<h4 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h4><p>kernel是CUDA中一个重要的概念，kernel是在device上线程中并行执行的函数，核函数用<code>__global__</code>符号声明，在调用时需要用<code>&lt;&lt;&lt;grid, block&gt;&gt;&gt;</code>来指定kernel要执行的线程数量，在CUDA中，每一个线程都要执行核函数，并且每个线程会分配一个唯一的线程号thread ID，这个ID值可以通过核函数的内置变量<code>threadIdx</code>来获得。</p>
<p>由于GPU实际上是异构模型，所以需要区分host和device上的代码，在CUDA中是通过函数类型限定词开区别host和device上的函数，主要的三个函数类型限定词如下：</p>
<ul>
<li><code>__global__</code>：在device上执行，从host中调用（一些特定的GPU也可以从device上调用），返回类型必须是void，不支持可变参数，不能成为类成员函数。注意用<code>__global__</code>定义的kernel是异步的，这意味着host不会等待kernel执行完就执行下一步。</li>
<li><code>__device__</code>：在device上执行，单仅可以从device中调用，不可以和<code>__global__</code>同时用。</li>
<li><code>__host__</code>：在host上执行，仅可以从host上调用，一般省略不写，不可以和<code>__global__</code>同时用，但可和<code>__device__</code>同时用，此时函数会在device和host都编译。</li>
</ul>
<h4 id="grid-block-thread"><a href="#grid-block-thread" class="headerlink" title="grid&#x2F;block&#x2F;thread"></a>grid&#x2F;block&#x2F;thread</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dim3 <span class="title">grid</span><span class="params">(<span class="number">3</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line"><span class="function">dim3 <span class="title">block</span><span class="params">(<span class="number">5</span>, <span class="number">3</span>)</span></span>;</span><br><span class="line">kernel_fun&lt;&lt;&lt; grid, block &gt;&gt;&gt;(prams...);</span><br></pre></td></tr></table></figure>

<p><img src="https://kezunlin.me/images/posts/635233-20181121154406313-63648281.png" alt="grid block thread"></p>
<blockquote>
<p>The key is in CUDA’s <code>&lt;&lt;&lt;1, 1&gt;&gt;&gt;</code>syntax. This is called the execution configuration, and it tells the CUDA runtime how many parallel threads to use for the launch on the GPU. </p>
</blockquote>
<h4 id="builtin-variables"><a href="#builtin-variables" class="headerlink" title="builtin variables"></a>builtin variables</h4><ul>
<li>threadIdx</li>
<li>blockIdx</li>
<li>blockDim</li>
<li>gridDim</li>
</ul>
<p>对于一个2-dim的<code>block(Dx,Dy)</code>，线程<code>(x,y)</code>的ID值为<code>(x+y∗Dx)</code>，<br>如果是3-dim的<code>block(Dx,Dy,Dz)</code>，线程<code>(x,y,z)</code>的ID值为<code>(x+y∗Dx+z∗Dx∗Dy)</code>。</p>
<h4 id="matrix-add"><a href="#matrix-add" class="headerlink" title="matrix add"></a>matrix add</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># kernel function</span></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">MatAdd</span><span class="params">(<span class="type">float</span> A[N][N], <span class="type">float</span> B[N][N], <span class="type">float</span> C[N][N])</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="type">int</span> col = blockIdx.x * blockDim.x + threadIdx.x; </span><br><span class="line">    <span class="type">int</span> row = blockIdx.y * blockDim.y + threadIdx.y; </span><br><span class="line">    <span class="keyword">if</span> (col &lt; N &amp;&amp; row &lt; N) </span><br><span class="line">        C[row][col] = A[row][col] + B[row][col]; </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Kernel config</span></span><br><span class="line">    <span class="function">dim3 <span class="title">threadsPerBlock</span><span class="params">(<span class="number">16</span>, <span class="number">16</span>)</span></span>; </span><br><span class="line">    <span class="function">dim3 <span class="title">numBlocks</span><span class="params">(N / threadsPerBlock.x, N / threadsPerBlock.y)</span></span>;</span><br><span class="line">    <span class="comment">// kernel call</span></span><br><span class="line">    MatAdd&lt;&lt;&lt;numBlocks, threadsPerBlock&gt;&gt;&gt;(A, B, C); </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CUDA内存模型"><a href="#CUDA内存模型" class="headerlink" title="CUDA内存模型"></a>CUDA内存模型</h3><h4 id="gpu-memory"><a href="#gpu-memory" class="headerlink" title="gpu memory"></a>gpu memory</h4><p><img src="https://kezunlin.me/images/posts/635233-20181121160102636-1427071747.png" alt="gpu memory"></p>
<h4 id="logical-physical-layer"><a href="#logical-physical-layer" class="headerlink" title="logical&#x2F;physical layer"></a>logical&#x2F;physical layer</h4><p><img src="https://kezunlin.me/images/posts/635233-20181121161156616-1647932316.png" alt="logical physical"></p>
<ul>
<li><p><code>SP</code>最基本的处理单元，<code>Streaming Processor</code>，也称为CUDA core。</p>
</li>
<li><p><code>SM</code>是英文名是 <code>Streaming Multiprocessor</code>，翻译过来就是流式多处理器。</p>
</li>
<li><p>一个kernel的各个线程块有可能被分配多个<code>SM</code>，所以grid只是逻辑层，而SM才是执行的物理层。<code>SM</code>采用的是<code>SIMT</code> (<code>Single-Instruction, Multiple-Thread</code>，单指令多线程)架构，基本的执行单元是线程束（<code>wraps</code>)，线程束包含32个线程，这些线程同时执行相同的指令，但是每个线程都包含自己的指令地址计数器和寄存器状态，也有自己独立的执行路径。</p>
</li>
<li><p>由于<code>SM</code>的基本执行单元是包含32个线程的线程束，所以block大小一般要设置为32的倍数。</p>
</li>
<li><p>每个thread由每个SP执行</p>
</li>
<li><p>每个thread block由SM执行</p>
</li>
<li><p>一个kernel其实由一个grid来执行，一个kernel一次只能在一个GPU上执行</p>
</li>
</ul>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>




<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><p>see <a target="_blank" rel="noopener" href="https://gist.github.com/kezunlin/73a82cad86e920bb300b042c1f7002d1">cuda-demo</a></p>
<h3 id="CMakeLists-txt"><a href="#CMakeLists-txt" class="headerlink" title="CMakeLists.txt"></a>CMakeLists.txt</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required (VERSION 2.8.7)</span><br><span class="line"></span><br><span class="line">project (CudaExample)</span><br><span class="line">enable_language(C)</span><br><span class="line">enable_language(CXX)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 11)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the output folder where your program will be created</span></span><br><span class="line"><span class="built_in">set</span>(CMAKE_BINARY_DIR <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/bin)</span><br><span class="line"><span class="built_in">set</span>(EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>)</span><br><span class="line"><span class="built_in">set</span>(LIBRARY_OUTPUT_PATH <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line">find_package(CUDA REQUIRED) <span class="comment"># user-defined</span></span><br><span class="line"></span><br><span class="line">MESSAGE( [Main] <span class="string">&quot; CUDA_LIBRARIES = <span class="variable">$&#123;CUDA_LIBRARIES&#125;</span>&quot;</span>)</span><br><span class="line">MESSAGE( [Main] <span class="string">&quot; CUDA_INCLUDE_DIRS = <span class="variable">$&#123;CUDA_INCLUDE_DIRS&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The following folder will be included</span></span><br><span class="line">include_directories(</span><br><span class="line">	<span class="variable">$&#123;CUDA_INCLUDE_DIRS&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CUDA_NVCC_FLAGS <span class="string">&quot;-g -G&quot;</span>)</span><br><span class="line"><span class="built_in">set</span>(GENCODE -gencode=<span class="built_in">arch</span>=compute_61,code=sm_61)</span><br><span class="line"></span><br><span class="line">cuda_add_executable(demo src/demo.cu OPTIONS <span class="variable">$&#123;GENCODE&#125;</span>)</span><br><span class="line">target_link_libraries(demo <span class="variable">$&#123;CUDA_LIBRARIES&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#cuda_add_library(gpu SHARED $&#123;CURRENT_HEADERS&#125; $&#123;CURRENT_SOURCES&#125;)</span></span><br><span class="line"><span class="comment">#cuda_add_library(gpu STATIC $&#123;CURRENT_HEADERS&#125; $&#123;CURRENT_SOURCES&#125;)</span></span><br></pre></td></tr></table></figure>



<h3 id="vector-add"><a href="#vector-add" class="headerlink" title="vector add"></a>vector add</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cuda_runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">https://blog.csdn.net/fb_help/article/details/79330815</span></span><br><span class="line"><span class="comment">foo.cuh + foo.cu</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// function to add the elements of two arrays</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> n, <span class="type">float</span> *a, <span class="type">float</span> *b, <span class="type">float</span> *c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">		c[i] = a[i] + b[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">kernel_add</span><span class="params">(<span class="type">int</span> n, <span class="type">float</span> *a, <span class="type">float</span> *b, <span class="type">float</span> *c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// thread id</span></span><br><span class="line">    <span class="type">int</span> i = blockDim.x * blockIdx.x + threadIdx.x;</span><br><span class="line">    c[i] = a[i] + b[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">kernel_add2</span><span class="params">(<span class="type">int</span> n, <span class="type">float</span> *a, <span class="type">float</span> *b, <span class="type">float</span> *c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// thread id</span></span><br><span class="line">	<span class="type">int</span> index = blockDim.x * blockIdx.x + threadIdx.x;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// grid-stride loop</span></span><br><span class="line">	<span class="type">int</span> grid_stride = blockDim.x * gridDim.x; <span class="comment">// 256*4096 </span></span><br><span class="line">	<span class="comment">// in this case; only 1 loop</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = index; i &lt; n; i += grid_stride)</span><br><span class="line">	&#123;</span><br><span class="line">		c[i] = a[i] + b[i];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">device_info</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> deviceCount;</span><br><span class="line">	<span class="built_in">cudaGetDeviceCount</span>(&amp;deviceCount);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>;i&lt;deviceCount;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		cudaDeviceProp devProp;</span><br><span class="line">		<span class="built_in">cudaGetDeviceProperties</span>(&amp;devProp, i);</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;使用GPU device &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; devProp.name &lt;&lt; std::endl;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;设备全局内存总量： &quot;</span> &lt;&lt; devProp.totalGlobalMem / <span class="number">1024</span> / <span class="number">1024</span> &lt;&lt; <span class="string">&quot;MB&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;SM的数量：&quot;</span> &lt;&lt; devProp.multiProcessorCount &lt;&lt; std::endl;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;每个SM的最大线程数：&quot;</span> &lt;&lt; devProp.maxThreadsPerMultiProcessor &lt;&lt; std::endl;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;每个SM的最大线程束数(warps)：&quot;</span> &lt;&lt; devProp.maxThreadsPerMultiProcessor / <span class="number">32</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;每个线程块(Block)的共享内存大小：&quot;</span> &lt;&lt; devProp.sharedMemPerBlock / <span class="number">1024.0</span> &lt;&lt; <span class="string">&quot; KB&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;每个线程块(Block)的最大线程数：&quot;</span> &lt;&lt; devProp.maxThreadsPerBlock &lt;&lt; std::endl;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;每个线程块(Block)可用的32位寄存器数量： &quot;</span> &lt;&lt; devProp.regsPerBlock &lt;&lt; std::endl;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;======================================================&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_cpu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> *A, *B, *C;</span><br><span class="line">	<span class="type">int</span> n = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">	<span class="type">int</span> size = n * <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// CPU端分配内存</span></span><br><span class="line">	A = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">	B = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">	C = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化数组</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		A[i] = <span class="number">90.0</span>;</span><br><span class="line">		B[i] = <span class="number">10.0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Run kernel on 1M elements on the CPU</span></span><br><span class="line">	<span class="built_in">add</span>(n, A, B, C);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 校验误差</span></span><br><span class="line">	<span class="type">float</span> max_error = <span class="number">0.0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		max_error += <span class="built_in">fabs</span>(<span class="number">100.0</span> - C[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;max error is &quot;</span> &lt;&lt; max_error &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 释放CPU端的内存</span></span><br><span class="line">	<span class="built_in">free</span>(A);</span><br><span class="line">	<span class="built_in">free</span>(B);</span><br><span class="line">	<span class="built_in">free</span>(C);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">cudaMalloc+cudaMemcpy+cudaFree</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">test_gpu_1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">float</span>*A, *Ad, *B, *Bd, *C, *Cd;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="type">int</span> size = n * <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CPU端分配内存</span></span><br><span class="line">    A = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">    B = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">    C = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化数组</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        A[i] = <span class="number">90.0</span>;</span><br><span class="line">        B[i] = <span class="number">10.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GPU端分配内存</span></span><br><span class="line">    <span class="built_in">cudaMalloc</span>((<span class="type">void</span>**)&amp;Ad, size);</span><br><span class="line">    <span class="built_in">cudaMalloc</span>((<span class="type">void</span>**)&amp;Bd, size);</span><br><span class="line">    <span class="built_in">cudaMalloc</span>((<span class="type">void</span>**)&amp;Cd, size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CPU的数据拷贝到GPU端</span></span><br><span class="line">    <span class="built_in">cudaMemcpy</span>(Ad, A, size, cudaMemcpyHostToDevice);</span><br><span class="line">    <span class="built_in">cudaMemcpy</span>(Bd, B, size, cudaMemcpyHostToDevice);</span><br><span class="line">    <span class="built_in">cudaMemcpy</span>(Bd, B, size, cudaMemcpyHostToDevice);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1-dim</span></span><br><span class="line">    <span class="comment">// 定义kernel执行配置，（1024*1024/512）个block，每个block里面有512个线程</span></span><br><span class="line">	<span class="type">int</span> block_size = <span class="number">512</span>;</span><br><span class="line">	<span class="type">int</span> num_of_blocks = (n + block_size - <span class="number">1</span>) / block_size; </span><br><span class="line">    <span class="function">dim3 <span class="title">dimBlock</span><span class="params">(block_size)</span></span>;</span><br><span class="line">    <span class="function">dim3 <span class="title">dimGrid</span><span class="params">(num_of_blocks)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行kernel</span></span><br><span class="line">    kernel_add&lt;&lt;&lt;dimGrid, dimBlock&gt;&gt;&gt;(n, Ad, Bd, Cd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将在GPU端计算好的结果拷贝回CPU端</span></span><br><span class="line">    <span class="built_in">cudaMemcpy</span>(C, Cd, size, cudaMemcpyDeviceToHost);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验误差</span></span><br><span class="line">    <span class="type">float</span> max_error = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        max_error += <span class="built_in">fabs</span>(<span class="number">100.0</span> - C[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;max error is &quot;</span> &lt;&lt; max_error &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放CPU端、GPU端的内存</span></span><br><span class="line">    <span class="built_in">free</span>(A);</span><br><span class="line">    <span class="built_in">free</span>(B);</span><br><span class="line">    <span class="built_in">free</span>(C);</span><br><span class="line">    <span class="built_in">cudaFree</span>(Ad);</span><br><span class="line">    <span class="built_in">cudaFree</span>(Bd);</span><br><span class="line">    <span class="built_in">cudaFree</span>(Cd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">cudaMallocManaged+cudaDeviceSynchronize+cudaFree</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_gpu_2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span>*A, *B, *C;</span><br><span class="line">	<span class="type">int</span> n = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">	<span class="type">int</span> size = n * <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allocate Unified Memory – accessible from CPU or GPU</span></span><br><span class="line">	<span class="built_in">cudaMallocManaged</span>((<span class="type">void</span>**)&amp;A, size);</span><br><span class="line">	<span class="built_in">cudaMallocManaged</span>((<span class="type">void</span>**)&amp;B, size);</span><br><span class="line">	<span class="built_in">cudaMallocManaged</span>((<span class="type">void</span>**)&amp;C, size);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化数组</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		A[i] = <span class="number">90.0</span>;</span><br><span class="line">		B[i] = <span class="number">10.0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1-dim</span></span><br><span class="line">	<span class="comment">// 定义kernel执行配置，（1024*1024/512）个block，每个block里面有512个线程</span></span><br><span class="line">	<span class="type">int</span> block_size = <span class="number">512</span>;</span><br><span class="line">	<span class="type">int</span> num_of_blocks = (n + block_size - <span class="number">1</span>) / block_size;</span><br><span class="line">	<span class="function">dim3 <span class="title">dimBlock</span><span class="params">(block_size)</span></span>;</span><br><span class="line">	<span class="function">dim3 <span class="title">dimGrid</span><span class="params">(num_of_blocks)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行kernel</span></span><br><span class="line">	kernel_add2 &lt;&lt; &lt;dimGrid, dimBlock &gt;&gt; &gt;(n, A, B, C);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Wait for GPU to finish before accessing on host</span></span><br><span class="line">	<span class="built_in">cudaDeviceSynchronize</span>(); <span class="comment">// block until the GPU has finished all tasks</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 校验误差</span></span><br><span class="line">	<span class="type">float</span> max_error = <span class="number">0.0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		max_error += <span class="built_in">fabs</span>(<span class="number">100.0</span> - C[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;max error is &quot;</span> &lt;&lt; max_error &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Free Unified Memory</span></span><br><span class="line">	<span class="built_in">cudaFree</span>(A);</span><br><span class="line">	<span class="built_in">cudaFree</span>(B);</span><br><span class="line">	<span class="built_in">cudaFree</span>(C);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">device_info</span>();</span><br><span class="line">	<span class="built_in">test_cpu</span>();</span><br><span class="line">	<span class="built_in">test_gpu_1</span>();</span><br><span class="line">	<span class="built_in">test_gpu_2</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>notes for <code>block_size</code> and <code>num_of_blocks</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> block_size = <span class="number">512</span>;</span><br><span class="line"><span class="type">int</span> num_of_blocks = (n + block_size - <span class="number">1</span>) / block_size; <span class="comment">// 4096</span></span><br><span class="line"><span class="function">dim3 <span class="title">dimBlock</span><span class="params">(block_size)</span></span>;</span><br><span class="line"><span class="function">dim3 <span class="title">dimGrid</span><span class="params">(num_of_blocks)</span></span>;</span><br></pre></td></tr></table></figure>

<p>notes for <code>grid-stride loop</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">kernel_add2</span><span class="params">(<span class="type">int</span> n, <span class="type">float</span> *a, <span class="type">float</span> *b, <span class="type">float</span> *c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// thread id</span></span><br><span class="line">	<span class="type">int</span> index = blockDim.x * blockIdx.x + threadIdx.x;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// grid-stride loop</span></span><br><span class="line">	<span class="type">int</span> grid_stride = blockDim.x * gridDim.x; <span class="comment">// 256*4096 </span></span><br><span class="line">	<span class="comment">// in this case; only 1 loop</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = index; i &lt; n; i += grid_stride)</span><br><span class="line">	&#123;</span><br><span class="line">		c[i] = a[i] + b[i];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://kezunlin.me/images/posts/635233-20181122094641728-827239450.png" alt="thread block and grid size"></p>
<h3 id="nvprof"><a href="#nvprof" class="headerlink" title="nvprof"></a>nvprof</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvprof.exe demo.exe </span><br></pre></td></tr></table></figure>

<pre><code>==8748== Profiling application: .\demo.exe
==8748== Profiling result:
Time(%)      Time     Calls       Avg       Min       Max  Name
 43.63%  1.6413ms         3  547.10us  517.71us  591.41us  [CUDA memcpy HtoD]
 30.11%  1.1327ms         1  1.1327ms  1.1327ms  1.1327ms  [CUDA memcpy DtoH]
 26.26%  987.80us         2  493.90us  243.43us  744.37us  kernel_add(int, float*, float*, float*)
</code></pre>
<blockquote>
<p>at <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\bin\nvprof.exe</code></p>
</blockquote>
<h3 id="matrix-multiply"><a href="#matrix-multiply" class="headerlink" title="matrix multiply"></a>matrix multiply</h3><ul>
<li>for 1-dim vector add, we use 1-dim grid and block</li>
<li>for 2-dim matrix multiply, we use 2-dim grid and block.</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ========================================</span></span><br><span class="line"><span class="comment">// 2-dim</span></span><br><span class="line"><span class="comment">// ========================================</span></span><br><span class="line"><span class="comment">// 矩阵类型，行优先，M(row, col) = *(M.elements + row * M.width + col)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Matrix</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> width;</span><br><span class="line">	<span class="type">int</span> height;</span><br><span class="line">	<span class="type">float</span> *elements;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取矩阵A的(row, col)元素</span></span><br><span class="line"><span class="function">__device__ <span class="type">float</span> <span class="title">getElement</span><span class="params">(Matrix *A, <span class="type">int</span> row, <span class="type">int</span> col)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> A-&gt;elements[row * A-&gt;width + col];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为矩阵A的(row, col)元素赋值</span></span><br><span class="line"><span class="function">__device__ <span class="type">void</span> <span class="title">setElement</span><span class="params">(Matrix *A, <span class="type">int</span> row, <span class="type">int</span> col, <span class="type">float</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	A-&gt;elements[row * A-&gt;width + col] = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 矩阵相乘kernel，2-D，每个线程计算一个元素</span></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">matMulKernel</span><span class="params">(Matrix *A, Matrix *B, Matrix *C)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> sum = <span class="number">0.0</span>;</span><br><span class="line">	<span class="type">int</span> row = threadIdx.y + blockIdx.y * blockDim.y;</span><br><span class="line">	<span class="type">int</span> col = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; A-&gt;width; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		sum += <span class="built_in">getElement</span>(A, row, i) * <span class="built_in">getElement</span>(B, i, col);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">setElement</span>(C, row, col, sum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_gpu_3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> width = <span class="number">1</span> &lt;&lt; <span class="number">8</span>;</span><br><span class="line">	<span class="type">int</span> height = <span class="number">1</span> &lt;&lt; <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">	Matrix *A, *B, *C;</span><br><span class="line">	<span class="comment">// 申请托管内存</span></span><br><span class="line">	<span class="built_in">cudaMallocManaged</span>((<span class="type">void</span>**)&amp;A, <span class="built_in">sizeof</span>(Matrix));</span><br><span class="line">	<span class="built_in">cudaMallocManaged</span>((<span class="type">void</span>**)&amp;B, <span class="built_in">sizeof</span>(Matrix));</span><br><span class="line">	<span class="built_in">cudaMallocManaged</span>((<span class="type">void</span>**)&amp;C, <span class="built_in">sizeof</span>(Matrix));</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> nBytes = width * height * <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line">	<span class="built_in">cudaMallocManaged</span>((<span class="type">void</span>**)&amp;A-&gt;elements, nBytes);</span><br><span class="line">	<span class="built_in">cudaMallocManaged</span>((<span class="type">void</span>**)&amp;B-&gt;elements, nBytes);</span><br><span class="line">	<span class="built_in">cudaMallocManaged</span>((<span class="type">void</span>**)&amp;C-&gt;elements, nBytes);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化数据</span></span><br><span class="line">	A-&gt;height = height;</span><br><span class="line">	A-&gt;width = width;</span><br><span class="line">	B-&gt;height = height;</span><br><span class="line">	B-&gt;width = width;</span><br><span class="line">	C-&gt;height = height;</span><br><span class="line">	C-&gt;width = width;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; width * height; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		A-&gt;elements[i] = <span class="number">1.0</span>;</span><br><span class="line">		B-&gt;elements[i] = <span class="number">2.0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义kernel的执行配置</span></span><br><span class="line">	<span class="function">dim3 <span class="title">blockSize</span><span class="params">(<span class="number">32</span>, <span class="number">32</span>)</span></span>;</span><br><span class="line">	<span class="function">dim3 <span class="title">gridSize</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		(width + blockSize.x - <span class="number">1</span>) / blockSize.x,</span></span></span><br><span class="line"><span class="params"><span class="function">		(height + blockSize.y - <span class="number">1</span>) / blockSize.y</span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br><span class="line">	<span class="comment">// 执行kernel</span></span><br><span class="line">	matMulKernel&lt;&lt;&lt;gridSize, blockSize&gt;&gt;&gt;(A, B, C);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 同步device 保证结果能正确访问</span></span><br><span class="line">	<span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查执行结果</span></span><br><span class="line">	<span class="type">float</span> maxError = <span class="number">0.0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; width * height; ++i)</span><br><span class="line">		maxError += <span class="built_in">fabs</span>(C-&gt;elements[i] - <span class="number">2</span> * width);</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;max error is &quot;</span> &lt;&lt; maxError &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 释放托管内存</span></span><br><span class="line">	<span class="built_in">cudaFree</span>(A-&gt;elements);</span><br><span class="line">	<span class="built_in">cudaFree</span>(B-&gt;elements);</span><br><span class="line">	<span class="built_in">cudaFree</span>(C-&gt;elements);</span><br><span class="line">	<span class="built_in">cudaFree</span>(A);</span><br><span class="line">	<span class="built_in">cudaFree</span>(B);</span><br><span class="line">	<span class="built_in">cudaFree</span>(C);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">test_gpu_3</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>notes for </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dim3 <span class="title">blockSize</span><span class="params">(<span class="number">32</span>, <span class="number">32</span>)</span></span>;</span><br><span class="line"><span class="function">dim3 <span class="title">gridSize</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	(width + blockSize.x - <span class="number">1</span>) / blockSize.x,</span></span></span><br><span class="line"><span class="params"><span class="function">	(height + blockSize.y - <span class="number">1</span>) / blockSize.y</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/skyfsm/p/9673960.html">CUDA编程之快速入门</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiaohu2022/article/details/79599947">CUDA编程入门极简教程</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/RyanWangZf/CUDA_Tutorial">CUDA_Tutorial</a></li>
<li><a target="_blank" rel="noopener" href="https://devblogs.nvidia.com/even-easier-introduction-cuda/">even-easier-introduction-cuda</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20181121: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/tensorrt-int8-inference/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/tensorrt-int8-inference/" class="post-title-link" itemprop="url">how to use tensorrt int8 to do network calibration</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-19 14:27:00" itemprop="dateCreated datePublished" datetime="2018-11-19T14:27:00+08:00">2018-11-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/" itemprop="url" rel="index"><span itemprop="name">deep learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><a href="https://kezunlin.me/post/dacc4196/">Part 1: install and configure tensorrt 4 on ubuntu 16.04</a></li>
<li><a href="https://kezunlin.me/post/bcdfb73c/">Part 2: tensorrt fp32 fp16 tutorial</a></li>
<li><strong><a href="https://kezunlin.me/post/30e0cb19/">Part 3: tensorrt int8 tutorial</a></strong></li>
</ul>
<h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="FP32-FP16-INT8-range"><a href="#FP32-FP16-INT8-range" class="headerlink" title="FP32&#x2F;FP16&#x2F;INT8 range"></a>FP32&#x2F;FP16&#x2F;INT8 range</h3><p>INT8 has significantly lower precision and dynamic range compared to FP32.</p>
<p><img src="https://kezunlin.me/images/posts/635233-20181119142909032-2033014099.png" alt="png"></p>
<p>High-throughput INT8 math<br><img src="https://kezunlin.me/images/posts/635233-20181119150611865-1044627462.png" alt="png"></p>
<blockquote>
<p>DP4A: int8 dot product Requires <code>sm_61+</code> (Pascal TitanX, GTX 1080, Tesla P4, P40 and others).</p>
</blockquote>
<h3 id="Calibration-Dataset"><a href="#Calibration-Dataset" class="headerlink" title="Calibration Dataset"></a>Calibration Dataset</h3><blockquote>
<p>When preparing the calibration dataset, you should capture the expected distribution of data in typical inference scenarios. You want to make sure that the calibration dataset covers all the expected scenarios; for example, clear weather, rainy day, night scenes, etc. If you are creating your own dataset, we recommend creating a separate calibration dataset. The calibration dataset shouldn’t overlap with the training, validation or test datasets, in order to avoid a situation where the calibrated model only works well on the these datasets.<br>具有代表性，最好是val set的子集。</p>
</blockquote>
<h3 id="result"><a href="#result" class="headerlink" title="result"></a>result</h3><p>caffe &#x2F; tensorrt FP32 &#x2F; tensorrt INT8</p>
<p><img src="https://kezunlin.me/images/posts/635233-20181119145909461-564925193.png" alt="png"></p>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>



<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><h3 id="fp32"><a href="#fp32" class="headerlink" title="fp32"></a>fp32</h3><p>by default.</p>
<h3 id="fp16"><a href="#fp16" class="headerlink" title="fp16"></a>fp16</h3><ul>
<li><p>cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder-&gt;<span class="built_in">setFp16Mode</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>python</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.set_fp16_mode(<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="int8"><a href="#int8" class="headerlink" title="int8"></a>int8</h3><ul>
<li><p>cpp usage</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">builder-&gt;<span class="built_in">setInt8Mode</span>(<span class="literal">true</span>);</span><br><span class="line">builder-&gt;<span class="built_in">setInt8Calibrator</span>(calibrator);</span><br></pre></td></tr></table></figure>
</li>
<li><p>python usage</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorrt <span class="keyword">as</span> trt</span><br><span class="line"></span><br><span class="line">NUM_IMAGES_PER_BATCH = <span class="number">5</span></span><br><span class="line">batchstream = ImageBatchStream(NUM_IMAGES_PER_BATCH，calibration_files)</span><br><span class="line"></span><br><span class="line">Int8_calibrator = trt.infer.EntropyCalibrator([“input_node_name”]，batchstream)</span><br><span class="line"></span><br><span class="line">trt_builder = trt.infer.create_infer_builder(G_LOGGER)</span><br><span class="line">trt_builder.set_int8_mode(<span class="literal">True</span>)</span><br><span class="line">trt_builder.set_int8_calibrator(Int8_calibrator)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Int8-Calibrator"><a href="#Int8-Calibrator" class="headerlink" title="Int8 Calibrator"></a>Int8 Calibrator</h2><p>see <a target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-developer-guide/index.html">5.1.3.2. INT8 Calibration Using C++</a></p>
<p>Calibration can be slow, therefore, the <code>IInt8Calibrator</code> interface provides methods for caching intermediate data. Using these methods effectively requires a more detailed understanding of calibration.</p>
<p>When building an INT8 engine, the builder performs the following steps:</p>
<ol>
<li>Builds a 32-bit engine, runs it on the calibration set, and records a histogram for each tensor of the distribution of activation values.</li>
<li>Builds a calibration table from the histograms.</li>
<li>Builds the INT8 engine from the calibration table and the network definition.</li>
</ol>
<p>The calibration table can be cached. Caching is useful when building the same network multiple times, for example, on multiple platforms. It captures data derived from the network and the calibration set. The parameters are recorded in the table. If the network or calibration set changes, it is the application’s responsibility to invalidate the cache.</p>
<p>The cache is used as follows:</p>
<ol>
<li>if a calibration table is found, calibration is skipped, otherwise:<br>the calibration table is built from the histograms and parameters</li>
<li>then the INT8 network is built from the network definition and the calibration table.</li>
</ol>
<p>Cached data is passed as a pointer and length.<br>After you have implemented the calibrator, you can configure the builder to use it:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder-&gt;<span class="built_in">setInt8Calibrator</span>(calibrator);</span><br></pre></td></tr></table></figure>

<p>The <code>make_plan</code> program must run on the target system in order for the TensorRT engine to be optimized correctly for that system. However, if an INT8 calibration cache was produced on the host, the cache may be re-used by the builder on the target when generating the engine (in other words, there is no need to do INT8 calibration on the target system itself).</p>
<blockquote>
<p>INT8 calibration cache can be re-used, while engine can not.</p>
</blockquote>
<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><h4 id="c"><a href="#c" class="headerlink" title="c++"></a>c++</h4><p>cpp:  </p>
<ul>
<li><p>see <a target="_blank" rel="noopener" href="https://github.com/NVIDIA-AI-IOT/deepstream_reference_apps/blob/master/sources/lib/calibrator.h">calibrator.h</a></p>
</li>
<li><p>and <a target="_blank" rel="noopener" href="https://github.com/NVIDIA-AI-IOT/deepstream_reference_apps/blob/master/sources/lib/calibrator.cpp">calibrator.cpp</a></p>
</li>
</ul>
<p>calibrator.h </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CALIBRATOR_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _CALIBRATOR_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;NvInfer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds_image.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;trt_utils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Int8EntropyCalibrator</span> : <span class="keyword">public</span> nvinfer1::IInt8EntropyCalibrator</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Int8EntropyCalibrator</span>(<span class="type">const</span> uint&amp; batchSize, <span class="type">const</span> std::string&amp; calibrationSetPath,</span><br><span class="line">                          <span class="type">const</span> std::string&amp; calibTableFilePath, <span class="type">const</span> <span class="type">uint64_t</span>&amp; inputSize,</span><br><span class="line">                          <span class="type">const</span> uint&amp; inputH, <span class="type">const</span> uint&amp; inputW, <span class="type">const</span> std::string&amp; inputBlobName);</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Int8EntropyCalibrator</span>() &#123; <span class="built_in">NV_CUDA_CHECK</span>(<span class="built_in">cudaFree</span>(m_DeviceInput)); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getBatchSize</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> m_BatchSize; &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">getBatch</span><span class="params">(<span class="type">void</span>* bindings[], <span class="type">const</span> <span class="type">char</span>* names[], <span class="type">int</span> nbBindings)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">void</span>* <span class="title">readCalibrationCache</span><span class="params">(<span class="type">size_t</span>&amp; length)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeCalibrationCache</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* cache, <span class="type">size_t</span> length)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> uint m_BatchSize;</span><br><span class="line">    <span class="type">const</span> uint m_InputH;</span><br><span class="line">    <span class="type">const</span> uint m_InputW;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> m_InputSize;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> m_InputCount;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* m_InputBlobName;</span><br><span class="line">    <span class="type">const</span> std::string m_CalibTableFilePath&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    uint m_ImageIndex;</span><br><span class="line">    <span class="type">bool</span> m_ReadCache&#123;<span class="literal">true</span>&#125;;</span><br><span class="line">    <span class="type">void</span>* m_DeviceInput&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    std::vector&lt;std::string&gt; m_ImageList;</span><br><span class="line">    std::vector&lt;<span class="type">char</span>&gt; m_CalibrationCache;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>calibrator.cpp </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;calibrator.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iterator&gt;</span></span></span><br><span class="line"></span><br><span class="line">Int8EntropyCalibrator::<span class="built_in">Int8EntropyCalibrator</span>(<span class="type">const</span> uint&amp; batchSize,</span><br><span class="line">                                             <span class="type">const</span> std::string&amp; calibrationSetPath,</span><br><span class="line">                                             <span class="type">const</span> std::string&amp; calibTableFilePath,</span><br><span class="line">                                             <span class="type">const</span> <span class="type">uint64_t</span>&amp; inputSize, <span class="type">const</span> uint&amp; inputH,</span><br><span class="line">                                             <span class="type">const</span> uint&amp; inputW, <span class="type">const</span> std::string&amp; inputBlobName) :</span><br><span class="line">    <span class="built_in">m_BatchSize</span>(batchSize),</span><br><span class="line">    <span class="built_in">m_InputH</span>(inputH),</span><br><span class="line">    <span class="built_in">m_InputW</span>(inputW),</span><br><span class="line">    <span class="built_in">m_InputSize</span>(inputSize),</span><br><span class="line">    <span class="built_in">m_InputCount</span>(batchSize * inputSize),</span><br><span class="line">    <span class="built_in">m_InputBlobName</span>(inputBlobName.<span class="built_in">c_str</span>()),</span><br><span class="line">    <span class="built_in">m_CalibTableFilePath</span>(calibTableFilePath),</span><br><span class="line">    <span class="built_in">m_ImageIndex</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_ImageList = <span class="built_in">loadListFromTextFile</span>(calibrationSetPath);</span><br><span class="line">    m_ImageList.<span class="built_in">resize</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(m_ImageList.<span class="built_in">size</span>() / m_BatchSize) * m_BatchSize);</span><br><span class="line">    std::<span class="built_in">random_shuffle</span>(m_ImageList.<span class="built_in">begin</span>(), m_ImageList.<span class="built_in">end</span>(), [](<span class="type">int</span> i) &#123; <span class="keyword">return</span> <span class="built_in">rand</span>() % i; &#125;);</span><br><span class="line">    <span class="built_in">NV_CUDA_CHECK</span>(<span class="built_in">cudaMalloc</span>(&amp;m_DeviceInput, m_InputCount * <span class="built_in">sizeof</span>(<span class="type">float</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Int8EntropyCalibrator::getBatch</span><span class="params">(<span class="type">void</span>* bindings[], <span class="type">const</span> <span class="type">char</span>* names[], <span class="type">int</span> nbBindings)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_ImageIndex + m_BatchSize &gt;= m_ImageList.<span class="built_in">size</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load next batch</span></span><br><span class="line">    <span class="function">std::vector&lt;DsImage&gt; <span class="title">dsImages</span><span class="params">(m_BatchSize)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (uint j = m_ImageIndex; j &lt; m_ImageIndex + m_BatchSize; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">        dsImages.<span class="built_in">at</span>(j - m_ImageIndex) = <span class="built_in">DsImage</span>(m_ImageList.<span class="built_in">at</span>(j), m_InputH, m_InputW);</span><br><span class="line">    &#125;</span><br><span class="line">    m_ImageIndex += m_BatchSize;</span><br><span class="line"></span><br><span class="line">    cv::Mat trtInput = <span class="built_in">blobFromDsImages</span>(dsImages, m_InputH, m_InputW);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NV_CUDA_CHECK</span>(<span class="built_in">cudaMemcpy</span>(m_DeviceInput, trtInput.<span class="built_in">ptr</span>&lt;<span class="type">float</span>&gt;(<span class="number">0</span>), m_InputCount * <span class="built_in">sizeof</span>(<span class="type">float</span>),</span><br><span class="line">                             cudaMemcpyHostToDevice));</span><br><span class="line">    <span class="built_in">assert</span>(!<span class="built_in">strcmp</span>(names[<span class="number">0</span>], m_InputBlobName));</span><br><span class="line">    bindings[<span class="number">0</span>] = m_DeviceInput;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">void</span>* <span class="title">Int8EntropyCalibrator::readCalibrationCache</span><span class="params">(<span class="type">size_t</span>&amp; length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">void</span>* output;</span><br><span class="line">    m_CalibrationCache.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="built_in">assert</span>(!m_CalibTableFilePath.<span class="built_in">empty</span>());</span><br><span class="line">    <span class="function">std::ifstream <span class="title">input</span><span class="params">(m_CalibTableFilePath, std::ios::binary)</span></span>;</span><br><span class="line">    input &gt;&gt; std::noskipws;</span><br><span class="line">    <span class="keyword">if</span> (m_ReadCache &amp;&amp; input.<span class="built_in">good</span>())</span><br><span class="line">        std::<span class="built_in">copy</span>(std::<span class="built_in">istream_iterator</span>&lt;<span class="type">char</span>&gt;(input), std::<span class="built_in">istream_iterator</span>&lt;<span class="type">char</span>&gt;(),</span><br><span class="line">                  std::<span class="built_in">back_inserter</span>(m_CalibrationCache));</span><br><span class="line"></span><br><span class="line">    length = m_CalibrationCache.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">if</span> (length)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Using cached calibration table to build the engine&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        output = &amp;m_CalibrationCache[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;New calibration table will be created to build the engine&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        output = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Int8EntropyCalibrator::writeCalibrationCache</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* cache, <span class="type">size_t</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(!m_CalibTableFilePath.<span class="built_in">empty</span>());</span><br><span class="line">    <span class="function">std::ofstream <span class="title">output</span><span class="params">(m_CalibTableFilePath, std::ios::binary)</span></span>;</span><br><span class="line">    output.<span class="built_in">write</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(cache), length);</span><br><span class="line">    output.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="c-v2"><a href="#c-v2" class="headerlink" title="c++ v2"></a>c++ v2</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Int8CacheCalibrator</span> : <span class="keyword">public</span> IInt8EntropyCalibrator &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Int8CacheCalibrator</span>(std::string cacheFile)</span><br><span class="line">    : <span class="built_in">mCacheFile</span>(cacheFile) &#123;&#125;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Int8CacheCalibrator</span>() &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">getBatchSize</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;<span class="keyword">return</span> <span class="number">1</span>;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">getBatch</span><span class="params">(<span class="type">void</span>* bindings[], <span class="type">const</span> <span class="type">char</span>* names[], <span class="type">int</span> nbBindings)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="type">void</span>* <span class="title">readCalibrationCache</span><span class="params">(<span class="type">size_t</span>&amp; length)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    mCalibrationCache.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="function">std::ifstream <span class="title">input</span><span class="params">(mCacheFile, std::ios::binary)</span></span>;</span><br><span class="line">    input &gt;&gt; std::noskipws;</span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">good</span>()) &#123;</span><br><span class="line">      std::<span class="built_in">copy</span>(std::<span class="built_in">istream_iterator</span>(input),</span><br><span class="line">      std::<span class="built_in">istream_iterator</span>&lt;<span class="type">char</span>&gt;(),</span><br><span class="line">      std::<span class="built_in">back_inserter</span>&lt;<span class="type">char</span>&gt;(mCalibrationCache));</span><br><span class="line">    &#125;</span><br><span class="line">    length = mCalibrationCache.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">return</span> length ? &amp;mCalibrationCache[<span class="number">0</span>] : <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  std::string mCacheFile;</span><br><span class="line">  std::vector&lt;<span class="type">char</span>&gt; mCalibrationCache;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="python"><a href="#python" class="headerlink" title="python"></a>python</h4><ul>
<li>see <a target="_blank" rel="noopener" href="https://devblogs.nvidia.com/int8-inference-autonomous-vehicles-tensorrt/">calibrator.py</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pycuda.driver <span class="keyword">as</span> cuda</span><br><span class="line"><span class="keyword">import</span> pycuda.autoinit</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> tensorrt <span class="keyword">as</span> trt</span><br><span class="line"></span><br><span class="line">CHANNEL = <span class="number">3</span></span><br><span class="line">HEIGHT = <span class="number">512</span></span><br><span class="line">WIDTH = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PythonEntropyCalibrator</span>(trt.infer.EntropyCalibrator):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_layers, stream</span>):</span><br><span class="line">    trt.infer.EntropyCalibrator.__init__(<span class="variable language_">self</span>)       </span><br><span class="line">    <span class="variable language_">self</span>.input_layers = input_layers</span><br><span class="line">    <span class="variable language_">self</span>.stream = stream</span><br><span class="line">  <span class="variable language_">self</span>.d_input = cuda.mem_alloc(<span class="variable language_">self</span>.stream.calibration_data.nbytes)</span><br><span class="line">    stream.reset()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_batch_size</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">self</span>.stream.batch_size</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_batch</span>(<span class="params">self, bindings, names</span>):</span><br><span class="line">    batch = <span class="variable language_">self</span>.stream.next_batch()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> batch.size:   </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">      </span><br><span class="line">    cuda.memcpy_htod(<span class="variable language_">self</span>.d_input, batch)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable language_">self</span>.input_layers[<span class="number">0</span>]:</span><br><span class="line">      <span class="keyword">assert</span> names[<span class="number">0</span>] != i</span><br><span class="line"></span><br><span class="line">    bindings[<span class="number">0</span>] = <span class="built_in">int</span>(<span class="variable language_">self</span>.d_input)</span><br><span class="line">    <span class="keyword">return</span> bindings</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">read_calibration_cache</span>(<span class="params">self, length</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">write_calibration_cache</span>(<span class="params">self, ptr, size</span>):</span><br><span class="line">    cache = ctypes.c_char_p(<span class="built_in">int</span>(ptr))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;calibration_cache.bin&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">      f.write(cache.value)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://devblogs.nvidia.com/int8-inference-autonomous-vehicles-tensorrt/">int8-inference-autonomous-vehicles-tensorrt</a></li>
<li><a target="_blank" rel="noopener" href="http://on-demand.gputechconf.com/gtc/2017/presentation/s7310-8-bit-inference-with-tensorrt.pdf">8-bit-inference-with-tensorrt</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_32043199/article/details/81119357">8-bit-inference-with-tensorrt 中文翻译版</a></li>
<li><a target="_blank" rel="noopener" href="https://note.youdao.com/share/?id=829ba6cabfde990e2832b048a4f492b3&type=note#/">基于tensorRT方案的INT8量化实现</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20181119: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/install-apache-httpd-server-2-2-on-windows-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/install-apache-httpd-server-2-2-on-windows-10/" class="post-title-link" itemprop="url">install apache httpd server 2.2 on windows 10</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-14 09:08:00" itemprop="dateCreated datePublished" datetime="2018-11-14T09:08:00+08:00">2018-11-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="install-and-config"><a href="#install-and-config" class="headerlink" title="install and config"></a>install and config</h3><p>download <a target="_blank" rel="noopener" href="https://www.apachelounge.com/download/win64/binaries/httpd-2.2.34-win64.zip">httpd-2.2.34-win64.zip</a><br>extract to <code>c:/Apache2</code><br>edit <code>conf/httpd.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ServerRoot &quot;c:/Apache2&quot;</span><br><span class="line">Listen 80</span><br><span class="line">ServerName 127.0.0.1</span><br><span class="line">DocumentRoot &quot;c:/Apache2/htdocs&quot;</span><br></pre></td></tr></table></figure>

<p>run <code>cmd.exe</code> as administrator and install <code>apache2.2 service</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> c:/Apache2/bin</span><br><span class="line">httpd.exe -k install -n apache2.2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>tips: use <code>sc delete apache2.2</code> to delete service first if error occurs and then install again.</p>
</blockquote>
<p><img src="https://kezunlin.me/images/posts/635233-20181114091911655-1258149903.png" alt="install service"></p>
<p>run <code>bin/ApacheMonitor.exe</code> to start <code>apache2.2 service</code></p>
<p><img src="https://kezunlin.me/images/posts/635233-20181114091916642-1053007383.png" alt="apache2.2 service running"></p>
<h3 id="access-from-local"><a href="#access-from-local" class="headerlink" title="access from local"></a>access from local</h3><p>test <code>localhost</code><br><img src="https://kezunlin.me/images/posts/635233-20181114092055122-1548918459.png" alt="works"></p>
<h3 id="access-from-remote"><a href="#access-from-remote" class="headerlink" title="access from remote"></a>access from remote</h3><p>edit <code>conf/httpd.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Directory &quot;c:/Apache2/htdocs&quot;</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Order allow,deny</span><br><span class="line">    Allow from all</span><br><span class="line">#/Directory</span><br></pre></td></tr></table></figure>

<p>open <code>windows defender</code> and allow <code>Apache Http Server</code> packets in&#x2F;out<br><img src="https://kezunlin.me/images/posts/635233-20181114094200752-1237273524.png" alt="allow apache "></p>
<ul>
<li>server host ip: 192.168.6.149</li>
<li>access host ip: 192.168.6.100</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@192.168.6.100&gt;$  wget http://192.168.6.149/1.txt</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20181114: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kezunlin.me/blog/compile-darknet-on-windows-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kezunlin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kezunlin's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/compile-darknet-on-windows-10/" class="post-title-link" itemprop="url">compile and install darknet on windows 10</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-01 09:18:00" itemprop="dateCreated datePublished" datetime="2018-11-01T09:18:00+08:00">2018-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-14 13:39:28" itemprop="dateModified" datetime="2024-10-14T13:39:28+08:00">2024-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/deep-learning/" itemprop="url" rel="index"><span itemprop="name">deep learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h2><ul>
<li><a target="_blank" rel="noopener" href="http://kezunline.me/post/e8f8aadd/">Part 1: compile darknet on ubuntu 16.04</a></li>
<li><strong><a target="_blank" rel="noopener" href="http://kezunline.me/post/a5c428f1/">Part 2: compile darknet on windows 10</a></strong></li>
<li><a href="https://kezunlin.me/post/cfeb28a4/">Part 3: compile caffe-yolov3 on ubuntu 16.04</a></li>
</ul>
<h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="requirements"><a href="#requirements" class="headerlink" title="requirements"></a>requirements</h3><p>my system requirements</p>
<ul>
<li>windows 10</li>
<li>GeForce 1060 (6G)  sm_61</li>
<li>VS: 2015 </li>
<li>cuda: 8.0</li>
<li>cudnn: 6.0.1</li>
<li>opencv: <a target="_blank" rel="noopener" href="http://sourceforge.net/projects/opencvlibrary/files/opencv-win/3.3.0/opencv-3.3.0.exe/download">opencv-3.3.0-vc14.exe</a></li>
</ul>
<blockquote>
<p>Tips:<br>Install Cuda after VS 2015. otherwise errors occur. (don’t know why)</p>
</blockquote>
<p>commands</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/AlexeyAB/darknet.git</span><br></pre></td></tr></table></figure>

<h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><ul>
<li>extract <code>opencv-3.3.0-vc14.exe</code> to <code>C:\opencv330\</code></li>
<li>find <code>CUDA 8.0.props</code> from <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\extras\visual_studio_integration\MSBuildExtensions\CUDA 8.0.props</code></li>
</ul>
<p>vim <code>build/darknet/darknet.vcxproj</code></p>
<ul>
<li>replace <code>C:\opencv_2.4.9\</code> with <code>C:\opencv330\</code></li>
<li>replace <code>CUDA 9.2.props</code> with <code>CUDA 8.0.props</code></li>
<li>replace <code>CUDA 9.2.targets</code> with <code>CUDA 8.0.targets</code></li>
<li>replace <code>compute_30,sm_30;</code> with <code>compute_61,sm_61;</code></li>
</ul>
<h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h3><p>open <code>build/darknet/darknet.sln</code> with <code>VS 2015</code></p>
<p>include path</p>
<pre><code>C:\opencv330\opencv\build\include
..\..\3rdparty\include
$(CUDA_PATH)\include
</code></pre>
<p>library path</p>
<pre><code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\lib\x64
$(CUDA_PATH)\lib\$(PlatformName)  
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\lib\x64
</code></pre>
<p>linker input</p>
<pre><code>    ..\..\3rdparty\lib\x64\pthreadVC2.lib;cublas.lib;curand.lib;cudart.lib;
</code></pre>
<p>build with <code>x64 Release</code>.</p>
<h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><h4 id="darknet-exe"><a href="#darknet-exe" class="headerlink" title="darknet.exe"></a>darknet.exe</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet.exe detector <span class="built_in">test</span> data/coco.data yolov3.cfg yolov3.weights -i 0 -thresh 0.25 dog.jpg -ext_output</span><br></pre></td></tr></table></figure>

<h4 id="darknet-py"><a href="#darknet-py" class="headerlink" title="darknet.py"></a>darknet.py</h4><p>compile <code>yolo_cpp_dll.sln</code> and generate <code>yolo_cpp_dll.dll</code> for python usage.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python darknet.py</span><br></pre></td></tr></table></figure>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kzl in-article ad -->
<p><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5653382914441020"
     data-ad-slot="7925631830"></ins></p>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><h3 id="yolo-py"><a href="#yolo-py" class="headerlink" title="yolo.py"></a>yolo.py</h3><p>for linux and windows.<br>see <a target="_blank" rel="noopener" href="https://gist.github.com/kezunlin/01adb3c752072f36954ad1bb4f935c14">yolo.py</a></p>
<h3 id="yolo-cpp-dll"><a href="#yolo-cpp-dll" class="headerlink" title="yolo_cpp_dll"></a>yolo_cpp_dll</h3><p>System Path</p>
<pre><code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\bin
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\libnvvp
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\jre\bin
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\jre\bin\plugin2
</code></pre>
<p>cuda80+cudnn6 </p>
<ul>
<li>cuda_8.0.61_win10.exe: <code>cublas64_80.dll,curand64_80.dll,cudart64_80.dll</code></li>
<li>cudnn-8.0-windows10-x64-v6.0.zip: <code>cudnn64_6.dll</code></li>
</ul>
<p>cuda90+cudnn7</p>
<ul>
<li>cuda_9.0.176_win10.exe: <code>cublas64_90.dll,curand64_90.dll,cudart64_90.dll</code></li>
<li>cudnn-9.0-windows10-x64-v7.1.zip: <code>cudnn64_7.dll</code></li>
</ul>
<p>yolo dll</p>
<ul>
<li>cuda80_yolo_cpp_dll: <code>pthreadvc2.dll, cublas64_80.dll,curand64_80.dll,cudart64_80.dll,cudnn64_6.dll</code></li>
<li>cuda90_yolo_cpp_dll: <code>pthreadvc2.dll, cublas64_90.dll,curand64_90.dll,cudart64_90.dll,cudnn64_7.dll</code><blockquote>
<p>Tips: use <code>Dependency Walker</code> to list dlls.</p>
</blockquote>
</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/pjreddie/darknet">pjreddie darknet yolo</a></li>
<li><a target="_blank" rel="noopener" href="https://pjreddie.com/darknet/install/">darknet install</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/AlexeyAB/darknet">darknet for linux and windows</a></li>
</ul>
<h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><ul>
<li>20181101: created.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kezunlin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">181</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">213</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kezunlin</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
